# K12 视频搜索系统 - Cursor Rules

## 项目概述
这是一个AI驱动的K12教育视频搜索和评估系统，支持多国家、多语言的教育资源搜索和深度评估。

## 技术栈共识

### 后端
- **框架**: Flask 2.3+
- **数据验证**: Pydantic 2.0+
- **LLM API**: AI Builders API
  - DeepSeek: 文本生成（成本低）
  - Gemini 2.5 Pro: 结构化提取（准确性高）
- **搜索引擎**: Tavily Search（通过AI Builders API）
- **视频处理**: yt-dlp, ffmpeg-python
- **并发**: ThreadPoolExecutor

### 前端
- **框架**: 原生HTML/CSS/JavaScript（无框架）
- **UI库**: 自定义样式，响应式设计

## 代码规范

### 文件组织
```
core/          # 核心业务逻辑模块（video_evaluator.py, video_processor.py等）
data/          # 数据文件
  ├── config/          # 配置文件（countries_config.json, search_history.json）
  ├── evaluations/     # 评估结果（运行时生成）
  ├── knowledge_points/ # 知识点数据
  ├── syllabus/       # 教学大纲PDF
  └── videos/         # 视频文件（运行时生成）
docs/          # 文档目录（所有.md文件，除了根目录的README.md）
logs/          # 日志文件（按日期组织：YYYY-MM-DD/）
scripts/       # 脚本文件（test_*.py, extract_*.py, *.sh等）
tests/         # 测试文件（test_*.html, test_*.json, test_*.csv）
templates/     # 前端模板（*.html）
```

**文件组织规则**（详细规则见 `docs/FILE_ORGANIZATION_RULES.md`）：

1. **核心代码文件**（根目录）：
   - `web_app.py` - Flask应用主入口
   - `*_engine*.py`, `*_agent.py`, `*_evaluator.py`, `*_manager.py`, `*_utils.py` - 核心模块

2. **Core模块**（core/目录）：
   - `video_*.py`, `transcript_*.py`, `playlist_*.py`, `vision_*.py` - 核心业务逻辑模块

3. **文档文件**（docs/目录）：
   - ✅ 所有 `.md` 文件必须放在 `docs/` 目录
   - ✅ 根目录只保留 `README.md`（项目主README）
   - ❌ 禁止在根目录创建其他 `.md` 文件

4. **配置文件**（data/config/目录）：
   - ✅ 所有配置文件放在 `data/config/` 目录
   - ✅ 代码中引用时使用相对路径：`data/config/countries_config.json`

5. **脚本文件**（scripts/目录）：
   - ✅ 所有脚本文件（`.py`, `.sh`）放在 `scripts/` 目录
   - ✅ 测试脚本使用 `test_` 前缀

6. **测试文件**（tests/目录）：
   - ✅ 测试数据和测试HTML文件放在 `tests/` 目录
   - ✅ 测试脚本放在 `scripts/` 目录

7. **创建新文件时的检查清单**：
   - `.md` → `docs/`（除了根目录的README.md）
   - `.py` (脚本) → `scripts/`
   - `.py` (核心模块) → `core/` 或根目录
   - `.json` (配置) → `data/config/`
   - `.html` → `templates/` 或 `tests/`
   - `.sh` → `scripts/`

### 命名规范
- **Python文件**: snake_case（如 `search_engine_v2.py`）
- **类名**: PascalCase（如 `SearchEngineV2`）
- **函数/变量**: snake_case（如 `search_video`）
- **常量**: UPPER_SNAKE_CASE（如 `MAX_RETRIES`）

### 日志规范
- **时区**: 统一使用UTC
- **Request ID**: 每个API请求生成唯一ID，注入到所有日志
- **Logger命名**: 每个模块使用独立的logger名称（如 `search_engine`, `discovery_agent`）
- **日志级别**: INFO（生产），DEBUG（开发）

### JSON解析
- **统一使用**: `json_utils.py` 中的工具函数
- **函数**: `extract_and_parse_json()`, `extract_json_object()`, `extract_json_array()`
- **处理**: Markdown代码块、单引号、尾部逗号、正则提取

## 核心功能共识

### 1. 搜索策略
- **混合搜索**: 通用搜索（YouTube）+ 本地定向搜索（site:domain语法）
- **去重**: URL去重 + LLM统一评分
- **并发**: 批量搜索使用ThreadPoolExecutor（max_workers=4）

### 2. 视频评估
- **下载策略**: 只下载低清版（480p/360p）用于分析，记录高清元数据（max_resolution_height）
- **关键帧**: 6张均匀分布的关键帧
- **评分维度**:
  - 视觉质量 (20%): 硬指标（分辨率）+ 软指标（设计质量）
  - 内容相关度 (40%): LLM分析
  - 教学质量 (30%): LLM分析
  - 热度/元数据 (10%): 规则计算

### 3. 视觉分析
- **当前状态**: 使用文本描述模拟（AI Builders API不支持视觉输入）
- **未来方案**: 集成外部Vision API（Google Cloud Vision API）

### 4. 错误处理
- **API调用**: 失败时记录详细错误信息，不中断主流程
- **视频下载**: 失败时返回错误信息，不崩溃
- **JSON解析**: 多层容错机制（直接解析 → ast.literal_eval → 正则提取）

## API设计共识

### 请求/响应格式
- **统一使用**: Pydantic BaseModel
- **时间戳**: ISO 8601格式，UTC时区
- **错误响应**: 包含error字段和详细错误信息

### 端点命名
- **搜索**: `/api/search`
- **国家发现**: `/api/discover_country`
- **配置获取**: `/api/config/<country_code>`
- **日志**: `/api/debug_logs`, `/api/save_debug_log`

## 数据模型共识

### CountryProfile
- **必需字段**: country_code, country_name, grades, subjects, domains
- **学科格式**: `{"local_name": "...", "zh_name": "..."}`
- **域名**: 包含EdTech平台和视频托管平台

### SearchRequest
- **必需字段**: country, grade, subject
- **可选字段**: semester, language

### SearchResult
- **评分范围**: 0-10分
- **必需字段**: title, url, snippet, score, recommendation_reason

## 开发流程共识

### 1. 代码修改
- **先理解**: 阅读相关文件和文档
- **再修改**: 保持现有代码风格和结构
- **后验证**: 运行测试脚本，检查日志

### 2. 功能添加
- **文档先行**: 更新SOP文档
- **代码实现**: 遵循现有模式
- **测试验证**: 创建测试脚本验证功能

### 3. Bug修复
- **日志分析**: 查看详细日志定位问题
- **最小改动**: 只修改必要的代码
- **验证测试**: 确保修复后功能正常

### 4. 文件修改安全实践 ⚠️ 重要
**核心原则**: 永远不要覆盖现有文件内容，只进行精确修改

#### 修改现有文件前必须执行：
1. **先读取完整文件**
   - ✅ 使用 `read_file()` 工具读取完整文件内容
   - ✅ 了解文件结构、函数数量、路由数量等关键信息
   - ❌ 禁止不读取文件就直接修改

2. **选择正确的修改工具**
   - ✅ **优先使用 `search_replace`**: 精确替换，保留其他内容
     - 适用于：添加函数、修改函数、添加路由、修改配置
   - ✅ **谨慎使用 `write`**: 仅用于创建新文件或完全重写
     - 使用前必须确认：文件不存在 或 已备份完整内容
   - ❌ **禁止**: 使用 `write` 修改现有文件（会导致内容丢失）

3. **修改前完整性检查**
   - 检查关键元素数量（路由、函数、导入等）
   - 记录修改前的状态（如路由数量）
   - 如果发现异常（如路由数量明显偏少），停止修改并报告

4. **修改后验证**
   - ✅ 验证关键元素数量未减少
   - ✅ 运行语法检查（`python3 -m py_compile`）
   - ✅ 检查关键路由/函数是否存在
   - ✅ 如果修改了API路由，验证路由数量

#### 文件修改检查清单：
```
修改文件前：
□ 已读取完整文件内容
□ 已了解文件结构（路由数、函数数等）
□ 已选择正确的修改工具（search_replace vs write）
□ 已记录修改前的关键指标

修改文件后：
□ 关键元素数量未减少
□ 语法检查通过
□ 关键功能仍然存在
□ 新功能已正确添加
```

#### 示例：正确的修改流程
```python
# ✅ 正确做法
# 1. 先读取完整文件
read_file('web_app.py')

# 2. 使用search_replace精确添加
search_replace(
    file_path='web_app.py',
    old_string='@app.route(\'/api/old_endpoint\')',
    new_string='@app.route(\'/api/old_endpoint\')\n@app.route(\'/api/new_endpoint\')'
)

# 3. 验证修改
# 检查路由数量是否增加
```

#### 示例：错误的修改流程
```python
# ❌ 错误做法
# 1. 不读取文件就直接write
write('web_app.py', new_content)  # 会覆盖所有内容！

# ❌ 错误做法
# 2. 使用write修改现有文件
write('web_app.py', only_new_api_code)  # 丢失其他路由！
```

#### 特殊情况处理：
- **文件被意外覆盖**: 
  - 立即停止修改
  - 尝试从Git历史恢复（如果有）
  - 或从运行中的服务器获取代码（如果可能）
  - 或手动重建文件
- **需要完全重写文件**:
  - 先备份原文件（复制到临时位置）
  - 使用 `write` 创建新文件
  - 验证新文件包含所有必要内容
  - 对比备份文件，确保无遗漏

## 重要约定

### 1. 时区和时间
- **统一使用**: UTC时区
- **格式**: ISO 8601 (`datetime.now(timezone.utc).isoformat()`)

### 2. Request ID
- **生成位置**: `web_app.py` 的API端点
- **注入方式**: `contextvars` 注入到日志系统
- **用途**: 日志追踪和前端过滤

### 3. Token消耗
- **优化原则**: 优先使用DeepSeek（成本低）
- **字幕截断**: 只取前2000字符进行评估
- **批量处理**: 考虑缓存机制避免重复评估

### 4. 视觉模型
- **当前限制**: AI Builders API不支持视觉输入（已验证）
- **临时方案**: 文本描述模拟
- **未来方案**: 外部Vision API集成

## 禁止事项

1. ❌ 不要修改核心业务逻辑的接口签名（除非必要）
2. ❌ 不要硬编码配置值（使用配置文件或环境变量）
3. ❌ 不要忽略错误处理（所有API调用都要有异常处理）
4. ❌ 不要使用非UTC时区（统一使用UTC）
5. ❌ 不要直接使用json.loads（使用json_utils工具函数）
6. ❌ **禁止使用 `write` 工具修改现有文件**（必须使用 `search_replace`）
7. ❌ **禁止不读取文件就直接修改**（必须先 `read_file` 了解完整内容）
8. ❌ **禁止修改后不验证**（必须检查关键元素数量、语法、功能完整性）
9. ❌ **禁止在根目录创建文档文件**（除了 `README.md`，所有 `.md` 文件应放在 `docs/` 目录）
10. ❌ **禁止在根目录创建测试脚本**（所有测试脚本应放在 `scripts/` 目录）
11. ❌ **禁止在根目录创建配置文件**（所有配置文件应放在 `data/config/` 目录）
12. ❌ **禁止在根目录创建HTML文件**（所有HTML文件应放在 `templates/` 或 `tests/` 目录）
13. ❌ **禁止创建重复文件**（创建新文件前先检查是否已存在）

## 文档要求

### 必须更新的文档
- **SOP文档**: `docs/SOP_COMPLETE_V3.2.md`（重大功能变更时）
- **README**: `README.md`（项目结构变更时）
- **进度总结**: `docs/PROGRESS_SUMMARY.md`（阶段性更新）
- **文件组织规则**: `docs/FILE_ORGANIZATION_RULES.md`（文件结构变更时）

### 文档格式
- **Markdown格式**: 使用标准Markdown语法
- **代码引用**: 使用 `startLine:endLine:filepath` 格式
- **流程图**: 使用Mermaid语法

### 文档位置规则
- ✅ 所有文档文件（`.md`）必须放在 `docs/` 目录
- ✅ 根目录只保留 `README.md`（项目主README）
- ❌ 禁止在根目录创建其他 `.md` 文件
- ✅ 创建新文档时，参考 `docs/FILE_ORGANIZATION_RULES.md` 中的命名规范

## 测试要求

### 测试脚本位置
- **功能测试**: `scripts/`
- **验证脚本**: `scripts/debug_verification.py`

### 测试原则
- **模拟调用**: 使用Mock数据避免真实API调用
- **验证路径**: 确保代码路径畅通
- **错误处理**: 验证错误处理逻辑

## 版本管理

### 版本号格式
- **格式**: V3.X.Y
- **X**: 主要功能更新
- **Y**: Bug修复和小优化

### 当前版本
- **版本**: V3.2.0
- **主要特性**: 视频深度评估、视觉模型测试

