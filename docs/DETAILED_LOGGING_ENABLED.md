# 详细日志输出已启用

## 修改内容

### 1. 日志级别调整

**文件**: `logger_utils.py`

- ✅ 控制台日志级别从 `INFO` 改为 `DEBUG`
- ✅ 现在所有详细日志都会打印到终端
- ✅ 文件日志仍然记录所有级别（DEBUG及以上）

### 2. 搜索API增强日志

**文件**: `web_app.py`

添加了详细的日志记录：

1. **请求开始日志**
   - 请求ID
   - 请求数据（JSON格式）

2. **参数日志**
   - 国家、年级、学科、学期、语言、资源类型

3. **执行过程日志**
   - 模块加载状态
   - 搜索执行时间
   - 结果统计

4. **错误处理增强**
   - 错误类型
   - 错误消息
   - 完整堆栈跟踪
   - 超时错误检测（错误代码5）
   - 同时输出到控制台和日志文件

## 日志输出位置

### 终端输出
- ✅ 所有DEBUG级别及以上的日志都会显示在终端
- ✅ 错误信息会以醒目的格式打印
- ✅ 包含完整的堆栈跟踪

### 日志文件
- 主日志文件: `search_system.log`
- 启动日志: `/tmp/web_app_detailed.log`（如果使用tee）

## 错误代码5（超时）检测

系统会自动检测超时错误：
- 检测关键词: "timeout", "超时", "timed out"
- 如果检测到超时，会在日志中标记 `⚠️ 检测到超时错误（错误代码5）`
- 响应中会包含 `error_code: 5`

## 使用方法

### 启动服务器（详细日志模式）

```bash
# 方式1: 直接运行（日志输出到终端）
source venv/bin/activate
python web_app.py

# 方式2: 同时保存到文件
python web_app.py 2>&1 | tee /tmp/web_app_detailed.log
```

### 查看实时日志

```bash
# 查看终端输出（实时）
# 直接在运行web_app.py的终端查看

# 查看日志文件（实时）
tail -f search_system.log

# 查看启动日志
tail -f /tmp/web_app_detailed.log
```

## 日志格式示例

### 正常搜索日志
```
2026-01-08T01:20:25.120Z - web_app - INFO - [搜索请求] 开始处理搜索请求 [ID: abc12345]
2026-01-08T01:20:25.121Z - web_app - DEBUG - [搜索请求] 请求数据: {"country":"NG","grade":"Primary 1","subject":"English"}
2026-01-08T01:20:25.122Z - web_app - INFO - [搜索参数] 国家=NG, 年级=Primary 1, 学科=English
2026-01-08T01:20:25.123Z - web_app - INFO - [搜索执行] 开始执行搜索 [ID: abc12345]
2026-01-08T01:20:30.456Z - web_app - INFO - [搜索执行] 搜索完成，耗时: 5.33秒，结果数: 20
2026-01-08T01:20:30.457Z - web_app - INFO - [搜索完成] 请求ID: abc12345, 总结果数: 20
```

### 错误日志
```
================================================================================
❌ [搜索失败] 请求ID: abc12345
❌ [搜索失败] 错误类型: TimeoutError
❌ [搜索失败] 错误消息: Request timed out after 120 seconds
❌ [搜索失败] 完整堆栈跟踪:
Traceback (most recent call last):
  File "web_app.py", line 494, in search
    response = search_engine.search(search_request)
  ...
⚠️ 检测到超时错误（错误代码5）
================================================================================
```

## 排查错误代码5的步骤

1. **查看终端输出**
   - 所有详细日志都会实时显示在终端
   - 查找 `⚠️ 检测到超时错误（错误代码5）` 标记

2. **查看日志文件**
   ```bash
   tail -100 search_system.log | grep -A 20 "搜索失败"
   ```

3. **检查搜索执行时间**
   - 查找 `[搜索执行] 搜索完成` 日志
   - 如果耗时超过120秒，可能是超时

4. **检查API调用**
   - 查看是否有大量API调用日志
   - 检查是否有API调用失败或超时

## 注意事项

1. **日志量增加**: DEBUG级别会输出大量日志，可能影响性能
2. **终端输出**: 确保终端有足够的缓冲区显示日志
3. **日志文件大小**: 日志文件可能会快速增长，注意定期清理

## 恢复默认日志级别

如果需要恢复INFO级别（减少日志输出），修改 `logger_utils.py`:

```python
console_handler.setLevel(logging.INFO)  # 改回INFO级别
```

