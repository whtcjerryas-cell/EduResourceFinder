# 系统流程确认 - 用户理解 vs 当前实现

## ✅ 您的理解（完全正确！）

### 1. 搜索阶段
**您的理解**：选择国家、年级、学科后进行搜索  
**当前实现**：✅ **完全一致**
- 前端提供国家、年级、学期、学科选择
- 后端执行AI搜索词生成和混合搜索
- 返回20个搜索结果（按评分排序）

### 2. 选择视频资源
**您的理解**：选择个别视频列表，进行AI评估  
**当前实现**：✅ **完全一致**
- 前端提供"AI 深度评估"按钮（单个视频）
- 前端提供"批量评估视频"按钮（多个视频/播放列表）
- 后端提供 `/api/analyze_video`（单个）和 `/api/batch_evaluate_videos`（批量）

### 3. 视频下载策略
**您的理解**：系统自动下载最多3个480p视频进行评估  
**当前实现**：✅ **完全一致，且有优化**
- **播放列表**：自动提取前3个视频（可配置 `max_videos_per_playlist`）
- **单个视频**：直接评估
- **总数限制**：最多评估10个视频（可配置 `max_total_videos`）
- **下载质量**：只下载480p/360p用于分析，但**记录最大分辨率**（如1080p）用于评分

### 4. 字幕/转录策略
**您的理解**：如果有字幕评估字幕，没有字幕进行转录后评估  
**当前实现**：✅ **完全一致**
- **优先级1**：使用yt-dlp提取官方字幕（支持多语言选择）
- **优先级2**：如果没有字幕，使用Whisper进行音频转录
- **评估影响**：有字幕或转录都可以正常评估内容相关度和教学质量

### 5. 评估数据记录
**您的理解**：评估后会记录详细数据，包括各维度打分和Token消耗  
**当前实现**：✅ **基本一致，部分增强中**

**已实现**：
- ✅ 各维度评分（视觉质量、内容相关度、教学质量、热度/元数据）
- ✅ 总分（0-10分）
- ✅ 视觉API Token消耗（已记录）
- ✅ 评估时间戳
- ✅ 视频元数据（分辨率、观看次数、点赞数等）
- ✅ 字幕/转录来源和语言

**部分实现**：
- ⚠️ LLM Token消耗（AIBuildersClient已打印，但未返回给调用者）
  - 需要修改 `AIBuildersClient.call_llm` 返回usage字典
  - 需要修改 `VideoEvaluator` 收集LLM调用的Token

## 📊 完整流程对比

### 您的理解流程
```
1. 选择国家、年级、学科 → 搜索
2. 选择视频列表 → AI评估
3. 下载最多3个480p视频
4. 有字幕用字幕，没有用转录
5. 记录各维度打分和Token消耗
```

### 当前实现流程
```
1. ✅ 选择国家、年级、学科 → 搜索
   └─ 返回20个搜索结果

2. ✅ 选择视频列表 → AI评估
   ├─ 单个视频：/api/analyze_video
   └─ 批量视频：/api/batch_evaluate_videos
      ├─ 播放列表：提取前3个视频
      └─ 单个视频：直接评估
      └─ 总数限制：最多10个

3. ✅ 视频处理（每个视频）
   ├─ 下载480p视频（用于分析）
   ├─ 记录最大分辨率（用于评分）
   ├─ 提取音频（MP3）
   ├─ 提取6张关键帧
   └─ 提取字幕/转录
       ├─ 优先：官方字幕（yt-dlp）
       └─ 备选：Whisper转录

4. ✅ 多维度评估
   ├─ 视觉质量（20%）：硬指标 + Vision AI
   ├─ 内容相关度（40%）：LLM分析
   ├─ 教学质量（30%）：LLM分析
   └─ 热度/元数据（10%）：规则计算

5. ✅ 记录评估数据
   ├─ 各维度评分 ✅
   ├─ Token消耗统计 ⚠️（视觉API已记录，LLM需要增强）
   ├─ 评估时间戳 ✅
   └─ 视频元数据 ✅
```

## 🎯 一致性总结

| 项目 | 您的理解 | 当前实现 | 一致性 |
|------|---------|---------|--------|
| 搜索功能 | ✅ | ✅ | **100%一致** |
| 视频选择 | ✅ | ✅ | **100%一致** |
| 下载策略 | 最多3个480p | 播放列表3个，总共10个，480p | **95%一致**（有优化） |
| 字幕/转录 | 有字幕用字幕，没有用转录 | ✅ | **100%一致** |
| 评估维度 | 各维度打分 | ✅ | **100%一致** |
| Token记录 | 记录Token消耗 | 视觉API已记录，LLM需增强 | **80%一致** |

## 📝 需要完善的部分

### 1. LLM Token记录增强（优先级：中）
**问题**：`AIBuildersClient.call_llm` 方法打印了Token使用情况，但没有返回给调用者。

**解决方案**：
- 修改 `AIBuildersClient.call_llm` 返回 `(content, usage)` 元组
- 修改 `VideoEvaluator` 收集并记录LLM调用的Token
- 在评估结果中包含完整的Token统计

### 2. 批量评估前端集成（优先级：高）
**问题**：前端有"批量评估视频"按钮，但需要确认JavaScript函数是否正确调用API。

**需要检查**：
- `batchEvaluateVideos` 函数是否存在
- 是否正确调用 `/api/batch_evaluate_videos`
- 是否正确显示进度和结果

### 3. 评估数据持久化（优先级：低）
**问题**：评估结果目前只返回给前端，没有持久化存储。

**建议**：
- 保存评估结果到JSON文件或数据库
- 支持查询历史评估记录
- 支持导出评估报告（Excel/PDF）

## ✅ 总结

**您的理解与当前实现高度一致！** 

主要差异：
1. **下载策略**：您说"最多3个"，实际是"播放列表3个，总共10个"（这是优化，更灵活）
2. **Token记录**：视觉API已完整记录，LLM Token需要增强（已识别问题，待修复）

**建议**：
- 当前系统已基本符合您的理解
- 可以开始测试批量评估功能
- Token记录增强可以后续优化





