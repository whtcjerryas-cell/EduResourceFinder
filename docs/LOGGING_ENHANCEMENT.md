# 日志增强功能说明

## 📅 更新日期
2025-12-29

## 🎯 目标
为 K12 视频搜索系统添加详细的调试日志，帮助排查学科交叉验证和本地化资源搜索的问题。

---

## ✅ 新增日志功能

### 1. 学科交叉验证日志 (`discovery_agent.py`)

#### 输入阶段
- ✅ 打印国家名称和当前学科数量
- ✅ 打印当前学科列表详情（每个学科的 local_name 和 zh_name）
- ✅ 打印发送给 LLM 的完整 System Prompt（前500字符预览 + 完整内容）
- ✅ 打印发送给 LLM 的完整 User Prompt（前500字符预览 + 完整内容）
- ✅ 打印 LLM 调用参数（model, max_tokens, temperature）

#### 输出阶段
- ✅ 打印 LLM 响应的完整内容（包括长度和完整文本）
- ✅ 打印解析过程的每一步：
  - 步骤1：JSON 数组提取
  - 步骤2：JSON 字符串清理
  - 步骤3：JSON 解析
  - 步骤4：数据验证和提取
- ✅ 打印每个元素的处理过程（类型、键、有效性）
- ✅ 打印修复尝试过程（单引号修复等）

#### 结果阶段
- ✅ 打印遗漏学科详情列表
- ✅ 打印去重过程（现有学科名称集合）
- ✅ 打印每个学科的添加/跳过状态
- ✅ 打印最终统计（添加数、跳过数、最终总数）

---

### 2. 混合搜索日志 (`search_engine_v2.py`)

#### 搜索 A（通用搜索）
- ✅ 打印查询词和参数
- ✅ 打印搜索结果详情（前5个结果的标题和URL）

#### 搜索 B（本地定向搜索）
- ✅ 打印国家配置读取过程：
  - 国家代码
  - 配置是否存在
  - 域名数量和列表
- ✅ 打印域名筛选过程：
  - EdTech 关键词列表
  - 每个域名的分类结果（视频平台/EdTech平台）
  - 筛选结果统计
- ✅ 打印查询词构建过程：
  - 选择的平台列表
  - 平台名称提取过程
  - 最终构建的查询词
- ✅ 打印搜索结果详情：
  - 每个结果的标题和URL
  - URL 是否匹配目标平台

#### 合并去重
- ✅ 打印合并前统计（通用、本地、总计）
- ✅ 打印去重过程（每个重复项的URL）
- ✅ 打印合并后统计（去重数、保留数、最终数）

---

### 3. Tavily API 调用日志 (`search_engine_v2.py`)

#### 请求阶段
- ✅ 打印原始查询词
- ✅ 打印请求参数（max_results, include_domains）
- ✅ 打印域名增强过程（如果启用）
- ✅ 打印增强后的查询词
- ✅ 打印请求 Endpoint 和完整 Payload

#### 响应阶段
- ✅ 打印响应状态码
- ✅ 打印响应类型和结构
- ✅ 打印 queries 数量
- ✅ 打印 Tavily 结果数量
- ✅ 打印每个结果的详情（标题、URL）
- ✅ 打印 URL 是否匹配目标域名

---

## 📋 日志格式说明

### 日志层级
- `[步骤 X]` - 主要步骤
- `    [🔍/✅/⚠️/❌]` - 子步骤（4空格缩进）
- `        [步骤X]` - 详细步骤（8空格缩进）

### 日志图标
- 🔍 - 搜索/查找
- ✅ - 成功
- ⚠️ - 警告
- ❌ - 错误
- 📋 - 信息/列表
- 📤 - 发送/输出
- 📥 - 接收/输入
- 🔧 - 处理/转换
- ⚙️ - 参数/配置
- 📊 - 统计
- 🔄 - 循环/迭代

---

## 🔍 使用示例

### 学科交叉验证日志示例
```
    [🔍 验证] 开始学科交叉验证...
    [📋 输入] 国家: Indonesia
    [📋 输入] 当前学科数量: 6
    [📋 当前学科列表]
        1. Matematika (数学)
        2. Bahasa Indonesia (印尼语)
        ...

    [📤 LLM 输入] System Prompt (前500字符): ...
    [📤 LLM 输入] User Prompt (前500字符): ...
    [📤 LLM 输入] 完整 User Prompt:
    ================================================================================
    [完整内容]
    ================================================================================

    [🤖 LLM] 调用 AI 进行学科验证...
    [⚙️ 参数] model=deepseek, max_tokens=1000, temperature=0.2
    [✅ LLM] AI 响应接收成功
    [📥 LLM 输出] 响应长度: 234 字符
    [📥 LLM 输出] 完整响应:
    ================================================================================
    [完整响应]
    ================================================================================

    [🔧 解析] 开始解析 LLM 响应...
        [步骤1] 提取 JSON 数组...
        [步骤2] 清理 JSON 字符串...
        [步骤3] 解析 JSON...
        [步骤4] 验证和提取...
    [🔧 解析] 解析完成，提取到 2 个遗漏学科

    [📝 补充] 发现 2 个遗漏的学科，正在补充...
    [📝 遗漏学科详情]:
        1. Pendidikan Jasmani (体育)
        2. Seni Budaya (艺术)
    ...
```

### 混合搜索日志示例
```
[步骤 2] 执行混合搜索...
    [🔍 搜索A-通用] 查询: "playlist matematika kelas 3 SD"
    [⚙️ 参数] max_results=15
    [✅ 搜索A] 找到 15 个结果
    [📋 搜索A结果详情]
        1. Matematika Kelas 3 SD - Playlist Lengkap...
           URL: https://www.youtube.com/playlist?list=...

    [🔍 搜索B-本地] 开始检查国家配置...
    [📋 输入] 国家代码: ID
    [✅ 配置] 成功读取国家配置: Indonesia
    [📋 配置] 域名数量: 3
    [📋 配置] 域名列表:
        1. ruangguru.com
        2. zenius.net
        3. vidio.com

    [🔧 筛选] 开始筛选视频托管平台域名...
    [📋 筛选] EdTech 关键词: ['khanacademy', 'coursera', ...]
        ⏭️ ruangguru.com -> EdTech平台（跳过）
        ⏭️ zenius.net -> EdTech平台（跳过）
        ✅ vidio.com -> 视频托管平台
    [📊 筛选结果] 找到 1 个视频托管平台
    [📋 视频平台列表]: vidio.com

    [🔧 构建] 构建本地平台查询词...
    [📋 选择] 使用前 1 个平台: vidio.com
        vidio.com -> 平台名称: vidio
    [🔍 搜索B-本地] 查询: "playlist matematika kelas 3 SD vidio"
    [📍 目标平台] vidio.com
    [⚙️ 参数] max_results=10, include_domains=['vidio.com']
        [🔍 Tavily搜索] 原始查询: "playlist matematika kelas 3 SD vidio"
        [⚙️ 参数] max_results=10, include_domains=['vidio.com']
        [🔧 增强] 添加域名限制: ['vidio.com']
        [🔍 Tavily搜索] 增强查询: "playlist matematika kelas 3 SD vidio (site:vidio.com)"
        [📤 请求] Endpoint: https://space.ai-builders.com/backend/v1/search/
        [📤 请求] Payload: {...}
        [📥 响应] 状态码: 200
        [📥 响应] queries 数量: 1
        [📥 响应] Tavily 结果数量: 8
        [📋 结果1] Matematika Kelas 3 - Vidio...
            URL: https://www.vidio.com/watch/...
            ✅ 匹配目标域名: vidio.com
    [✅ 搜索B] 找到 8 个结果

    [🔧 合并] 开始合并和去重...
    [📊 合并前] 通用: 15 个, 本地: 8 个, 总计: 23 个
    [📊 合并后] 去重: 2 个, 保留: 21 个
    [📊 统计] 通用: 15, 本地: 8, 最终: 21
```

---

## 🎯 调试建议

### 学科交叉验证问题排查
1. **检查 LLM 输入**：查看 System Prompt 和 User Prompt 是否包含完整信息
2. **检查 LLM 输出**：查看响应是否包含有效的 JSON 数组
3. **检查解析过程**：查看每个解析步骤是否成功
4. **检查去重逻辑**：查看现有学科名称集合，确认去重是否正确

### 本地化资源搜索问题排查
1. **检查国家配置**：确认配置是否存在，域名列表是否正确
2. **检查域名筛选**：查看哪些域名被识别为视频平台，哪些被排除
3. **检查查询词构建**：查看最终构建的查询词是否正确
4. **检查 API 响应**：查看 Tavily API 返回的结果数量和内容
5. **检查 URL 匹配**：查看返回的 URL 是否来自目标平台

---

## ✅ 完成状态

- [x] 学科交叉验证详细日志
- [x] 混合搜索详细日志
- [x] Tavily API 调用详细日志
- [x] 代码语法检查通过

所有日志功能已添加完成，可以开始调试！

