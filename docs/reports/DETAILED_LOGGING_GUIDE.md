# 🔍 详细日志功能 - 问题定位指南

## 已添加的详细日志

### 1. 搜索开始日志
```
================================================================================
🔍 [搜索开始] IQ - الصف الأول - الرياضيات
   时间: 2026-01-07 19:30:00
   内存使用: 55.2 MB
================================================================================
```

**记录内容：**
- 国家-年级-学科
- 开始时间
- 当前内存使用量

---

### 2. 步骤进度日志

#### 步骤0：配对验证
```
[步骤 0] 年级-学科配对验证...
   ✅ 配对验证通过
```

#### 步骤3：结果评估
```
[步骤 3] 评估结果... (内存: 60.1 MB)
   ✅ 步骤3完成: 2.3秒, 15个结果 (内存: 62.5 MB)
```

#### 步骤3.5：智能评分
```
[步骤 3.5] 智能评分开始... (内存: 62.5 MB)
[LLM评分] 开始: 15个结果 (内存: 62.5 MB)
   ✅ LLM评分完成: 45.2秒, 15个结果 (内存: 78.3 MB)
   ✅ 步骤3.5完成: 45.3秒 (内存: 78.3 MB)
   📊 评分结果: 视觉=0, 快速=15
```

**记录内容：**
- 每个步骤的开始和结束时间
- 每个步骤的耗时
- 每个步骤前后的内存使用量
- 处理的结果数量

---

### 3. 搜索完成日志
```
================================================================================
✅ [搜索完成] IQ - الصف الأول - الرياضيات
   总耗时: 120.5秒
   结果数: 15
   内存使用: 78.3 MB
   时间: 2026-01-07 19:32:00
================================================================================
```

**记录内容：**
- 总耗时
- 找到的结果数量
- 最终内存使用量
- 完成时间

---

### 4. 错误日志（崩溃时）
```
================================================================================
❌ [搜索失败] IQ - الصف الأول - التربية الإسلامية
   错误类型: TimeoutError
   错误信息: Request timeout after 300 seconds
   耗时: 300.0秒
   内存使用: 1024.5 MB
   时间: 2026-01-07 19:35:00
================================================================================
堆栈信息:
Traceback (most recent call last):
  ...
```

**记录内容：**
- 错误类型
- 错误信息
- 发生错误的步骤耗时
- 当时的内存使用量
- 完整的堆栈跟踪

---

## 📊 如何使用日志定位问题

### 方法1：实时查看日志
```bash
# 在一个终端窗口中实时查看日志
tail -f search_system.log

# 只看错误和警告
tail -f search_system.log | grep -E "ERROR|WARNING|❌"

# 只看特定搜索的日志
tail -f search_system.log | grep "الصف الأول"
```

### 方法2：搜索后查看日志
```bash
# 查看最后100行
tail -100 search_system.log

# 查看特定搜索的所有日志
grep "الصف الأول.*الرياضيات" search_system.log

# 查看所有错误
grep "ERROR" search_system.log

# 查看所有耗时超过60秒的步骤
grep "完成.*[6-9][0-9]\.[0-9]秒" search_system.log
```

### 方法3：分析内存问题
```bash
# 查看内存使用趋势
grep "内存使用:" search_system.log | tail -20

# 查找内存泄漏（内存持续增长）
grep "内存使用:" search_system.log | awk '{print $NF}' | sort -n | tail -10

# 查找耗时最长的步骤
grep "完成.*秒" search_system.log | sort -t: -k2 -rn | head -10
```

---

## 🎯 常见问题定位

### 问题1：错误代码5（超时）

**日志特征：**
```
[步骤 3.5] 智能评分开始... (内存: 65.2 MB)
[LLM评分] 开始: 20个结果 (内存: 65.2 MB)
...（长时间无日志）...
❌ [搜索失败] ...
   耗时: 300.0秒
```

**原因分析：**
- 步骤3.5的LLM评分卡住了
- 20个结果 × 每个API调用5-15秒 = 100-300秒
- 超过HTTP超时限制

**解决方案：**
- 减少结果数量（TOP 10或更少）
- 增加超时时间
- 检查API是否正常响应

---

### 问题2：内存泄漏

**日志特征：**
```
🔍 [搜索开始] 搜索1 - 内存: 55.2 MB
✅ [搜索完成] 搜索1 - 内存: 150.3 MB

🔍 [搜索开始] 搜索2 - 内存: 155.1 MB  # ← 没有释放
✅ [搜索完成] 搜索2 - 内存: 250.8 MB

🔍 [搜索开始] 搜索3 - 内存: 255.6 MB  # ← 继续增长
✅ [搜索完成] 搜索3 - 内存: 350.2 MB
```

**原因分析：**
- Playwright浏览器进程没有关闭
- 搜索引擎实例没有释放
- 缓存累积

**解决方案：**
- 运行 `python3 memory_monitor.py` 清理
- 检查是否有残留的Chromium进程
- 重启Web服务

---

### 问题3：API调用失败

**日志特征：**
```
[LLM评分] 开始: 15个结果
⚠️ LLM调用失败: 超时
⚠️ LLM调用失败: 连接错误
⚠️ 视觉评估失败
```

**解决方案：**
- 检查网络连接
- 检查API密钥是否有效
- 查看具体错误信息

---

## 📋 检查清单

在报告问题时，请提供以下信息：

### 必需信息
1. **search_system.log** 的最后200行
   ```bash
   tail -200 search_system.log > error_log.txt
   ```

2. **搜索参数**
   - 国家
   - 年级
   - 学科
   - 大概有多少结果

3. **错误表现**
   - 错误代码（5、500等）
   - 大约在哪个阶段崩溃
   - 是否每次都崩溃还是偶尔

### 可选信息
4. **系统资源**
   ```bash
   python3 memory_monitor.py
   ```

5. **进程状态**
   ```bash
   ps aux | grep python | wc -l  # 有多少Python进程
   ps aux | grep chrom | wc -l  # 有多少浏览器进程
   ```

---

## 🔧 快速诊断命令

```bash
# 一键诊断脚本
cat > diagnose.sh << 'EOF'
#!/bin/bash
echo "=== 系统诊断 ==="
echo "1. Python进程数:"
ps aux | grep python | grep -v grep | wc -l
echo "2. Chromium进程数:"
ps aux | grep chrom | grep -v grep | wc -l
echo "3. 最近错误:"
tail -50 search_system.log | grep -E "ERROR|WARNING|❌" | tail -10
echo "4. 内存使用:"
python3 memory_monitor.py <<< "n" | grep "物理内存"
echo "5. 磁盘空间:"
df -h | grep -E "Filesystem|/dev/"
EOF
chmod +x diagnose.sh
./diagnose.sh
```

---

## ✅ 验证日志功能

运行测试脚本验证日志是否正常：

```bash
python3 test_detailed_logging.py
```

预期输出：
```
✅ 当前内存使用: XX.X MB
✅ 日志功能正常
```

---

## 📞 下次崩溃时

1. **立即保存日志**
   ```bash
   cp search_system.log search_system_crash_$(date +%Y%m%d_%H%M%S).log
   ```

2. **收集诊断信息**
   ```bash
   ./diagnose.sh > diagnosis_$(date +%Y%m%d_%H%M%S).txt
   ```

3. **查看最后的活动**
   ```bash
   tail -100 search_system.log | grep -E "步骤|完成|ERROR"
   ```

4. **提供日志文件进行诊断**

---

现在系统已经添加了详细的日志记录功能。下次出现错误代码5时，请立即查看日志文件并提供相关信息，这样可以快速定位问题！
