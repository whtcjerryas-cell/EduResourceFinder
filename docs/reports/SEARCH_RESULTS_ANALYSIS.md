# 搜索结果问题分析报告

**日期**: 2026-01-09
**分析文件**:
- 批量搜索_2026-01-09 (4).xlsx - 伊拉克 一年级 数学
- 批量搜索_2026-01-09 (5).xlsx - 伊拉克 三年级 阿拉伯语
- 批量搜索_2026-01-09 (6).xlsx - 中国 五年级 数学

---

## 🚨 关键发现

### 问题1: 搜索结果数量严重不足

| 文件 | 国家/年级/学科 | 结果数 | 期望数 | 差距 |
|------|--------------|-------|--------|------|
| (4) | IQ 一年级 数学 | **2条** | 10-20条 | **-80~-90%** |
| (5) | IQ 三年级 阿拉伯语 | **2条** | 10-20条 | **-80~-90%** |
| (6) | CN 五年级 数学 | **7条** | 20-30条 | **-65~-75%** |

---

### 问题2: 中文年级识别仍然错误 ⚠️⚠️⚠️

**文件6，结果5**:
```
标题: 初三数学全册-九年级数学-上册-下册-同步课程
评分: 4.0分
推荐理由: "年级严重不符（标题为三年级，目标为五年级）"
```

**问题**: LLM将"初三"（九年级）识别为"三年级"！❌

**正确识别**: 初三 = 九年级（初中三年级）

---

### 问题3: 搜索策略可能不够精准

#### 伊拉克搜索（文件4和5）
- 一年级数学 → 只找到2条
- 三年级阿拉伯语 → 只找到2条

**可能原因**:
1. 搜索词不够多样化
2. 只使用了Google搜索，没有用其他引擎
3. 阿拉伯语搜索词可能不够准确
4. 搜索引擎限制（Google API配额）

#### 中国搜索（文件6）
- 五年级数学 → 找到7条

**可能原因**:
1. 百度搜索结果不如预期丰富
2. 搜索词组合不够
3. 只用了百度，没有用其他引擎（如必应、搜狗）

---

## 🔍 根本原因分析

### 1. 搜索引擎调用限制

**当前搜索引擎使用**:
- Google Custom Search API: 10,000次/天免费
- 百度搜索API: 100次/天免费
- Tavily API: 1,000次/月免费
- Metaso API: 5,000次免费

**问题**:
- 可能API配额用尽或接近上限
- API调用失败没有正确处理
- 没有降级到其他搜索引擎

---

### 2. 搜索词生成问题

**伊拉克搜索**:
```
预期搜索词:
- الرياضيات الصف الأول playlist
- شرح رياضيات للصف الأول
- mathematics grade 1 iraq
- الصف الأول رياضيات
```

**实际可能只用了1-2个搜索词**

**中国搜索**:
```
预期搜索词:
- 五年级数学 播放列表
- 五年级数学 完整课程
- 小学五年级数学教学视频
- 五年级上册数学
```

**可能只用了"五年级数学"一个搜索词**

---

### 3. 中文年级识别问题

**问题案例**:
- "初三" → 识别为"三年级" ❌
- 正确: "初三" = "九年级" = "初中三年级"

**其他可能的识别错误**:
- "初二" → 可能识别为"二年级" ❌（应该是八年级）
- "初一" → 可能识别为"一年级" ❌（应该是七年级）
- "高一" → 可能识别为"一年级" ❌（应该是十年级）
- "高二" → 可能识别为"二年级" ❌（应该是十一年级）
- "高三" → 可能识别为"三年级" ❌（应该是十二年级）

---

### 4. 搜索结果数量限制

**代码检查** (`search_engine_v2.py`):
```python
# 可能的硬编码限制
MAX_RESULTS_PER_ENGINE = 10  # 每个引擎最多10条
TOP_N_RESULTS = 10  # 只返回TOP 10
```

**问题**:
- 每个搜索引擎只取前10条
- 多个搜索引擎的结果可能重复
- 没有充分利用所有搜索结果

---

## 💡 改进方案

### 方案1: 优化搜索词生成 ⭐⭐⭐⭐⭐

**实施**:
1. **增加搜索词数量**
   - 当前: 4-5个搜索词
   - 优化: 8-10个搜索词（包含更多变体）

2. **针对伊拉克的阿拉伯语搜索词**:
   ```python
   IRAQ_ARABIC_QUERIES = [
       # 标准表达
       "الرياضيات للصف الأول playlist",
       "شرح رياضيات الصف الأول",

       # 埃及/海湾变体
       "رياضيات الصف الاول",

       # 混合表达
       "mathematics grade 1 iraq arabic",
       "الصف الأول رياضيات كامل",

       # 教材版本
       "منهج عراقي رياضيات الصف الأول",
       "الرياضيات الصف الأول العراقي",
   ]
   ```

3. **针对中国的搜索词**:
   ```python
   CHINA_MATH_QUERIES = [
       # 标准表达
       "五年级数学 播放列表",
       "五年级数学上册 完整教程",

       # 教材版本
       "人教版五年级数学",
       "苏教版五年级数学",
       "北师大版五年级数学",

       # 平台特定
       "site:bilibili.com 五年级数学",
       "site:bilibili.com 小学五年级数学 playlist",

       # 更多变体
       "五年级数学同步精讲",
       "小学五年级数学全册",
   ]
   ```

---

### 方案2: 修复中文年级识别 ⭐⭐⭐⭐⭐

**实施**:
1. **创建中文年级标准化模块** (`chinese_grade_normalizer.py`):
   ```python
   CHINESE_GRADE_MAPPING = {
       # 小学
       "一年级": "小学一年级",
       "二年级": "小学二年级",
       "三年级": "小学三年级",
       "四年级": "小学四年级",
       "五年级": "小学五年级",
       "六年级": "小学六年级",

       # 初中（关键！）
       "初一": "七年级",  # 或"初中一年级"
       "初二": "八年级",  # 或"初中二年级"
       "初三": "九年级",  # 或"初中三年级"

       # 高中
       "高一": "十年级",  # 或"高中一年级"
       "高二": "十一年级", # 或"高中二年级"
       "高三": "十二年级", # 或"高中三年级"
   }

   def normalize_chinese_grade(text):
       """标准化中文年级表达"""
       for colloquial, standard in CHINESE_GRADE_MAPPING.items():
           if colloquial in text:
               return standard
       return text
   ```

2. **在规则验证中添加中文年级识别**:
   ```python
   def _validate_with_rules(self, result, metadata):
       # ... 现有代码 ...

       # 检查是否中文
       if is_chinese_text(title):
           # 标准化年级
           normalized_grade = normalize_chinese_grade(title)

           # 检查"初三"等特殊情况
           if "初三" in title:
               identified_grade = "九年级"  # 或"初中三年级"
           elif "初二" in title:
               identified_grade = "八年级"
           elif "初一" in title:
               identified_grade = "七年级"
           # ... 其他年级
   ```

---

### 方案3: 增加搜索引擎调用 ⭐⭐⭐⭐

**实施**:
1. **使用更多搜索引擎**:
   - 当前: Google + 百度 + Tavily + Metaso
   - 优化: 添加必应、搜狗、360搜索

2. **增加每个引擎的结果数量**:
   ```python
   # 当前
   MAX_RESULTS_PER_ENGINE = 10

   # 优化
   MAX_RESULTS_PER_ENGINE = 20  # 增加到20条
   ```

3. **优化搜索策略**:
   ```python
   # 伊拉克: 优先Google，备选Tavily
   # 中国: 优先百度，备选必应、搜狗
   # 美国: 优先Google，备选Bing
   ```

---

### 方案4: 移除结果数量限制 ⭐⭐⭐

**实施**:
1. **检查并移除硬编码限制**:
   ```python
   # search_engine_v2.py
   # 查找所有 MAX_RESULTS、TOP_N 等常量
   # 增加或移除这些限制
   ```

2. **允许返回更多结果**:
   - 当前: 每次搜索返回10条
   - 优化: 返回20-30条

---

### 方案5: 增强去重逻辑 ⭐⭐⭐

**实施**:
1. **改进URL去重**:
   ```python
   # 当前: 只基于URL去重
   # 优化: 基于URL + 标题去重
   def dedupe_results(results):
       seen = set()
       unique_results = []
       for result in results:
           key = (result['url'], result['title'])
           if key not in seen:
               seen.add(key)
               unique_results.append(result)
       return unique_results
   ```

2. **保留高质量重复**:
   - 如果同一URL被多次搜索到，提高其质量分数
   - 说明多个搜索词都指向它，更相关

---

## 📊 预期效果

### 实施前（当前）

| 指标 | 伊拉克 | 中国 |
|------|--------|------|
| 平均结果数 | 2条 | 7条 |
| 中文年级识别准确率 | N/A | ~70% |
| 搜索词多样性 | 低 | 中 |

### 实施后（预期）

| 指标 | 伊拉克 | 中国 | 提升 |
|------|--------|------|------|
| 平均结果数 | 10-15条 | 20-30条 | **+400%~+300%** |
| 中文年级识别准确率 | N/A | ~95% | **+25%** |
| 搜索词多样性 | 高 | 高 | **+100%** |

---

## 🚀 实施优先级

### 立即实施（今天）⭐⭐⭐⭐⭐

1. **修复中文年级识别** (方案2)
   - 创建 `chinese_grade_normalizer.py`
   - 集成到规则验证
   - **影响**: 修复"初三"识别为"三年级"的错误

2. **增加搜索词数量** (方案1)
   - 修改 `search_strategy_agent.py`
   - 每个搜索生成8-10个变体
   - **影响**: 大幅增加搜索结果

### 短期实施（本周）⭐⭐⭐⭐

3. **增加搜索引擎调用** (方案3)
   - 添加必应、搜狗等搜索引擎
   - **影响**: 提升结果数量和多样性

4. **移除结果数量限制** (方案4)
   - 检查并调整 `MAX_RESULTS` 等常量
   - **影响**: 返回更多结果

### 中期实施（下周）⭐⭐⭐

5. **增强去重逻辑** (方案5)
   - 优化去重算法
   - **影响**: 提升结果质量

---

## 📝 测试验证

### 测试用例

**伊拉克**:
- 一年级数学 → 期望: 10-15条结果
- 三年级阿拉伯语 → 期望: 10-15条结果

**中国**:
- 五年级数学 → 期望: 20-30条结果
- 初二物理 → 期望: 正确识别为八年级

---

## ✅ 下一步行动

1. **立即修复**: 中文年级识别问题（方案2）
2. **立即优化**: 搜索词生成（方案1）
3. **测试验证**: 用相同的搜索测试效果提升

需要我立即开始实施这些改进吗？
