{% extends "base_new.html" %}

{% block title %}çŸ¥è¯†ç‚¹æ¦‚è§ˆ - K12æ•™è‚²èµ„æºæœç´¢ç³»ç»Ÿ{% endblock %}

{% block page_css %}
<style>
    .filters {
        background: var(--bg-card);
        padding: var(--spacing-lg);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        margin-bottom: var(--spacing-md);
        display: flex;
        gap: var(--spacing-md);
        flex-wrap: wrap;
        align-items: end;
    }

    .filter-group {
        flex: 1;
        min-width: 200px;
    }

    .filter-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text-primary);
        font-size: var(--font-sm);
    }

    .filter-group select {
        width: 100%;
        padding: 10px 12px;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        font-size: var(--font-base);
        background: var(--bg-secondary);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .filter-group select:hover {
        border-color: var(--primary-color);
    }

    .filter-group select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .search-btn {
        background: var(--primary-gradient);
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: var(--font-base);
        font-weight: 500;
        transition: transform var(--transition-base);
        white-space: nowrap;
    }

    .search-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .search-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .stats {
        display: flex;
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
        flex-wrap: wrap;
    }

    .stat-card {
        flex: 1;
        min-width: 200px;
        background: var(--primary-gradient);
        color: white;
        padding: var(--spacing-lg);
        border-radius: var(--border-radius);
        text-align: center;
    }

    .stat-card h3 {
        font-size: var(--font-sm);
        opacity: 0.9;
        margin-bottom: var(--spacing-sm);
    }

    .stat-card .value {
        font-size: 32px;
        font-weight: bold;
    }

    .knowledge-points-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: var(--spacing-lg);
    }

    .knowledge-point-card {
        background: var(--bg-card);
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: var(--spacing-lg);
        transition: all var(--transition-base);
        box-shadow: var(--shadow-md);
    }

    .knowledge-point-card:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
    }

    .kp-header {
        margin-bottom: var(--spacing-lg);
    }

    .kp-header h3 {
        font-size: var(--font-lg);
        color: var(--text-primary);
        margin-bottom: var(--spacing-sm);
        line-height: 1.4;
    }

    .kp-header .chapter {
        font-size: var(--font-sm);
        color: var(--text-secondary);
        margin-bottom: 5px;
    }

    .kp-header .objective {
        font-size: var(--font-xs);
        color: var(--text-secondary);
        line-height: 1.5;
        max-height: 60px;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .charts-container {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-lg);
        margin-top: var(--spacing-md);
    }

    .chart-section {
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: var(--spacing-md);
        background: var(--bg-primary);
    }

    .chart-section-title {
        font-size: var(--font-sm);
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-md);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .chart-section-title .icon {
        font-size: 18px;
    }

    .chart-wrapper {
        position: relative;
        height: 200px;
        width: 100%;
    }

    .chart-wrapper canvas {
        cursor: pointer;
    }

    .chart-empty {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-secondary);
        font-size: var(--font-sm);
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }

    .empty-state h3 {
        font-size: var(--font-lg);
        margin-bottom: 10px;
        color: var(--text-secondary);
    }

    /* Modalæ ·å¼ */
    .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        overflow-y: auto;
    }

    .modal-content {
        background-color: var(--bg-card);
        margin: 30px auto;
        padding: var(--spacing-xl);
        border-radius: var(--border-radius);
        max-width: 900px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--shadow-lg);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
        padding-bottom: var(--spacing-md);
        border-bottom: 2px solid var(--border-color);
    }

    .modal-header h2 {
        font-size: var(--font-2xl);
        color: var(--text-primary);
    }

    .close-btn {
        background: var(--danger-color);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: var(--font-sm);
    }

    .close-btn:hover {
        background: #d32f2f;
    }

    .detail-section {
        margin-bottom: var(--spacing-lg);
    }

    .detail-section h3 {
        font-size: var(--font-lg);
        color: var(--primary-color);
        margin-bottom: var(--spacing-md);
        padding-bottom: var(--spacing-sm);
        border-bottom: 1px solid var(--border-color);
    }

    .video-item {
        background: var(--bg-primary);
        padding: var(--spacing-md);
        border-radius: var(--border-radius);
        margin-bottom: 12px;
        border-left: 4px solid var(--primary-color);
    }

    .video-item h4 {
        font-size: var(--font-base);
        color: var(--text-primary);
        margin-bottom: var(--spacing-sm);
    }

    .video-item a {
        color: var(--primary-color);
        text-decoration: none;
        font-size: var(--font-sm);
    }

    .video-item a:hover {
        text-decoration: underline;
    }

    .score-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: var(--font-xs);
        font-weight: 600;
        margin-right: 8px;
    }

    .score-excellent {
        background: var(--success-color);
        color: white;
    }

    .score-good {
        background: #8bc34a;
        color: white;
    }

    .score-fair {
        background: var(--warning-color);
        color: white;
    }

    .score-poor {
        background: var(--danger-color);
        color: white;
    }

    .score-details {
        margin-top: 10px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
    }

    .score-item {
        background: white;
        padding: 8px;
        border-radius: 6px;
        font-size: var(--font-xs);
    }

    .score-item .label {
        color: var(--text-secondary);
        margin-bottom: 4px;
    }

    .score-item .value {
        font-weight: 600;
        color: var(--text-primary);
    }

    /* è§†å›¾åˆ‡æ¢æŒ‰é’®æ ·å¼ */
    .view-btn {
        padding: 8px 16px;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        background: var(--bg-card);
        color: var(--text-secondary);
        cursor: pointer;
        font-size: var(--font-sm);
        transition: all var(--transition-fast);
    }

    .view-btn:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    .view-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    /* çƒ­åŠ›å›¾å®¹å™¨æ ·å¼ */
    #heatmapContainer {
        display: none;
    }

    #heatmapContainer.active {
        display: block;
    }

    .heatmap-grid {
        display: grid;
        gap: var(--spacing-md);
    }

    .heatmap-cell {
        padding: var(--spacing-lg);
        border-radius: 10px;
        cursor: pointer;
        transition: all var(--transition-base);
        position: relative;
        border: 2px solid transparent;
    }

    .heatmap-cell:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary-color);
    }

    .heatmap-cell h4 {
        font-size: var(--font-lg);
        margin-bottom: var(--spacing-sm);
        color: var(--text-primary);
    }

    .heatmap-cell .chapter {
        font-size: var(--font-sm);
        color: var(--text-secondary);
        margin-bottom: 10px;
    }

    .heatmap-cell .stats {
        font-size: var(--font-sm);
        color: var(--text-primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>ğŸ“š çŸ¥è¯†ç‚¹æ¦‚è§ˆ</h1>
        <p>æŸ¥çœ‹çŸ¥è¯†ç‚¹åŠå…¶æ•™è‚²èµ„æºå®Œæˆåº¦</p>
    </div>

    <div class="filters">
        <div class="filter-group">
            <label>å›½å®¶</label>
            <select id="countrySelect">
                <option value="">-- è¯·é€‰æ‹©å›½å®¶ --</option>
            </select>
        </div>
        <div class="filter-group">
            <label>å¹´çº§</label>
            <select id="gradeSelect">
                <option value="">-- è¯·å…ˆé€‰æ‹©å›½å®¶ --</option>
            </select>
        </div>
        <div class="filter-group">
            <label>å­¦ç§‘</label>
            <select id="subjectSelect">
                <option value="">-- è¯·å…ˆé€‰æ‹©å›½å®¶ --</option>
            </select>
        </div>
        <div class="filter-group" style="flex: 0 0 auto;">
            <button class="search-btn" id="searchBtn" onclick="loadKnowledgePoints()" disabled>æŸ¥è¯¢</button>
        </div>
    </div>

    <!-- è§†å›¾åˆ‡æ¢ -->
    <div class="filters">
        <div style="display: flex; gap: 10px; align-items: center;">
            <span style="font-weight: 500; color: var(--text-primary);">è§†å›¾æ¨¡å¼ï¼š</span>
            <button class="view-btn active" data-view="list" onclick="switchView('list')">ğŸ“‹ åˆ—è¡¨è§†å›¾</button>
            <button class="view-btn" data-view="heatmap" onclick="switchView('heatmap')">ğŸŒˆ çƒ­åŠ›å›¾è§†å›¾</button>
        </div>
    </div>

    <div id="statsContainer" class="stats" style="display: none;">
        <div class="stat-card">
            <h3>æ€»çŸ¥è¯†ç‚¹æ•°</h3>
            <div class="value" id="totalKpCount">0</div>
        </div>
        <div class="stat-card">
            <h3>æ€»è§†é¢‘æ•°</h3>
            <div class="value" id="totalVideoCount">0</div>
        </div>
        <div class="stat-card">
            <h3>å¹³å‡èµ„æºä¸°å¯Œåº¦</h3>
            <div class="value" id="avgRichness">0.0</div>
        </div>
    </div>

    <div id="contentArea">
        <div class="empty-state">
            <h3>è¯·é€‰æ‹©å›½å®¶ã€å¹´çº§å’Œå­¦ç§‘åç‚¹å‡»æŸ¥è¯¢</h3>
            <p>ç³»ç»Ÿå°†å±•ç¤ºè¯¥æ¡ä»¶ä¸‹çš„æ‰€æœ‰çŸ¥è¯†ç‚¹åŠå…¶èµ„æºå®Œæˆåº¦</p>
        </div>
    </div>

    <!-- çƒ­åŠ›å›¾è§†å›¾å®¹å™¨ -->
    <div id="heatmapContainer">
        <div id="heatmapContent" class="heatmap-grid"></div>
    </div>
</div>

<!-- è¯¦æƒ…Modal -->
<div id="detailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="detailTitle">è¯¦æƒ…</h2>
            <button class="close-btn" onclick="closeDetailModal()">å…³é—­</button>
        </div>
        <div id="detailContent"></div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    let countriesList = [];
    let currentCountryConfig = null;
    let knowledgePointsData = [];

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async () => {
        await loadCountries();

        // ä»URLå‚æ•°è·å–åˆå§‹ç­›é€‰æ¡ä»¶
        const urlParams = new URLSearchParams(window.location.search);
        const country = urlParams.get('country');
        const grade = urlParams.get('grade');
        const subject = urlParams.get('subject');

        if (country && grade && subject) {
            document.getElementById('countrySelect').value = country;
            await loadCountryConfig(country);
            document.getElementById('gradeSelect').value = grade;
            document.getElementById('subjectSelect').value = subject;
            document.getElementById('searchBtn').disabled = false;
            await loadKnowledgePoints();
        }
    });

    // åŠ è½½å›½å®¶åˆ—è¡¨
    async function loadCountries() {
        try {
            const response = await fetch('/api/countries');
            const data = await response.json();

            if (data.success) {
                countriesList = data.countries;
                const select = document.getElementById('countrySelect');
                countriesList.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country.country_code;
                    option.textContent = country.country_name;
                    select.appendChild(option);
                });

                select.addEventListener('change', async (e) => {
                    if (e.target.value) {
                        await loadCountryConfig(e.target.value);
                    } else {
                        document.getElementById('gradeSelect').innerHTML = '<option value="">-- è¯·å…ˆé€‰æ‹©å›½å®¶ --</option>';
                        document.getElementById('subjectSelect').innerHTML = '<option value="">-- è¯·å…ˆé€‰æ‹©å›½å®¶ --</option>';
                        document.getElementById('searchBtn').disabled = true;
                    }
                });
            }
        } catch (error) {
            console.error('åŠ è½½å›½å®¶åˆ—è¡¨å¤±è´¥:', error);
            toast.error('åŠ è½½å¤±è´¥', 'æ— æ³•åŠ è½½å›½å®¶åˆ—è¡¨');
        }
    }

    // åŠ è½½å›½å®¶é…ç½®
    async function loadCountryConfig(countryCode) {
        try {
            const response = await fetch(`/api/config/${countryCode}`);
            const data = await response.json();

            if (data.success && data.config) {
                currentCountryConfig = data.config;

                // åŠ è½½å¹´çº§
                const gradeSelect = document.getElementById('gradeSelect');
                gradeSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©å¹´çº§ --</option>';
                data.config.grades.forEach(grade => {
                    const option = document.createElement('option');
                    option.value = grade.local_name;
                    option.textContent = `${grade.local_name} (${grade.zh_name})`;
                    gradeSelect.appendChild(option);
                });

                // åŠ è½½å­¦ç§‘
                const subjectSelect = document.getElementById('subjectSelect');
                subjectSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©å­¦ç§‘ --</option>';
                data.config.subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.local_name;
                    option.textContent = `${subject.local_name} (${subject.zh_name})`;
                    subjectSelect.appendChild(option);
                });

                // æ£€æŸ¥æ˜¯å¦å¯ä»¥å¯ç”¨æŸ¥è¯¢æŒ‰é’®
                checkSearchButton();

                gradeSelect.addEventListener('change', checkSearchButton);
                subjectSelect.addEventListener('change', checkSearchButton);
            }
        } catch (error) {
            console.error('åŠ è½½å›½å®¶é…ç½®å¤±è´¥:', error);
            toast.error('åŠ è½½å¤±è´¥', 'æ— æ³•åŠ è½½å›½å®¶é…ç½®');
        }
    }

    function checkSearchButton() {
        const country = document.getElementById('countrySelect').value;
        const grade = document.getElementById('gradeSelect').value;
        const subject = document.getElementById('subjectSelect').value;
        document.getElementById('searchBtn').disabled = !(country && grade && subject);
    }

    // åŠ è½½çŸ¥è¯†ç‚¹æ•°æ®
    async function loadKnowledgePoints() {
        const country = document.getElementById('countrySelect').value;
        const grade = document.getElementById('gradeSelect').value;
        const subject = document.getElementById('subjectSelect').value;

        if (!country || !grade || !subject) {
            return;
        }

        const contentArea = document.getElementById('contentArea');
        const statsContainer = document.getElementById('statsContainer');
        const heatmapContainer = document.getElementById('heatmapContainer');

        contentArea.innerHTML = '<div class="loading"><div class="spinner"></div><p>åŠ è½½ä¸­...</p></div>';
        statsContainer.style.display = 'none';
        heatmapContainer.classList.remove('active');

        try {
            const response = await fetch(`/api/knowledge_points?country=${encodeURIComponent(country)}&grade=${encodeURIComponent(grade)}&subject=${encodeURIComponent(subject)}`);
            const data = await response.json();

            if (data.success) {
                knowledgePointsData = data.knowledge_points || [];

                if (knowledgePointsData.length === 0) {
                    contentArea.innerHTML = '<div class="empty-state"><h3>æš‚æ— çŸ¥è¯†ç‚¹æ•°æ®</h3><p>è¯·å°è¯•å…¶ä»–ç­›é€‰æ¡ä»¶</p></div>';
                    return;
                }

                // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                displayStats(knowledgePointsData);

                // æ ¹æ®å½“å‰è§†å›¾æ¨¡å¼æ˜¾ç¤º
                const currentView = document.querySelector('.view-btn.active').dataset.view;
                if (currentView === 'list') {
                    displayKnowledgePoints(knowledgePointsData);
                } else {
                    displayHeatmap(knowledgePointsData);
                }
            } else {
                throw new Error(data.message || 'åŠ è½½å¤±è´¥');
            }
        } catch (error) {
            console.error('åŠ è½½çŸ¥è¯†ç‚¹å¤±è´¥:', error);
            contentArea.innerHTML = `<div class="empty-state"><h3>åŠ è½½å¤±è´¥</h3><p>${error.message}</p></div>`;
            toast.error('åŠ è½½å¤±è´¥', error.message);
        }
    }

    // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
    function displayStats(kps) {
        const statsContainer = document.getElementById('statsContainer');
        statsContainer.style.display = 'flex';

        const totalKpCount = kps.length;
        const totalVideoCount = kps.reduce((sum, kp) => sum + (kp.videos?.length || 0), 0);
        const avgRichness = totalKpCount > 0
            ? (kps.reduce((sum, kp) => {
                const videoCount = kp.videos?.length || 0;
                const materialCount = kp.learning_materials_count || 0;
                const questionCount = kp.practice_questions_count || 0;
                return sum + (videoCount + materialCount + questionCount);
            }, 0) / totalKpCount).toFixed(1)
            : '0.0';

        document.getElementById('totalKpCount').textContent = totalKpCount;
        document.getElementById('totalVideoCount').textContent = totalVideoCount;
        document.getElementById('avgRichness').textContent = avgRichness;
    }

    // åˆ‡æ¢è§†å›¾
    function switchView(view) {
        const buttons = document.querySelectorAll('.view-btn');
        buttons.forEach(btn => btn.classList.remove('active'));
        document.querySelector(`[data-view="${view}"]`).classList.add('active');

        const contentArea = document.getElementById('contentArea');
        const heatmapContainer = document.getElementById('heatmapContainer');

        if (view === 'list') {
            contentArea.style.display = 'block';
            heatmapContainer.classList.remove('active');
            if (knowledgePointsData.length > 0) {
                displayKnowledgePoints(knowledgePointsData);
            }
        } else {
            contentArea.style.display = 'none';
            heatmapContainer.classList.add('active');
            if (knowledgePointsData.length > 0) {
                displayHeatmap(knowledgePointsData);
            }
        }
    }

    // æ˜¾ç¤ºçƒ­åŠ›å›¾
    function displayHeatmap(kps) {
        const heatmapContent = document.getElementById('heatmapContent');

        // è®¡ç®—èµ„æºä¸°å¯Œåº¦å¹¶æ’åº
        const kpsWithRichness = kps.map(kp => {
            const videoCount = kp.videos?.length || 0;
            const materialCount = kp.learning_materials_count || 0;
            const questionCount = kp.practice_questions_count || 0;
            const richness = videoCount + materialCount + questionCount;
            return { ...kp, richness };
        }).sort((a, b) => b.richness - a.richness);

        // è·å–æœ€å¤§ä¸°å¯Œåº¦ç”¨äºé¢œè‰²è®¡ç®—
        const maxRichness = Math.max(...kpsWithRichness.map(kp => kp.richness), 1);

        let html = '';
        kpsWithRichness.forEach((kp, index) => {
            const richnessPercent = (kp.richness / maxRichness) * 100;
            const hue = (richnessPercent / 100) * 120; // 0-120: çº¢åˆ°ç»¿
            const bgColor = `hsl(${hue}, 70%, 85%)`;
            const borderColor = `hsl(${hue}, 70%, 65%)`;

            html += `
                <div class="heatmap-cell" style="background: ${bgColor}; border-color: ${borderColor};"
                     onclick="showKpHeatmapDetail(${index})">
                    <div style="position: absolute; top: 15px; right: 15px; font-size: 24px; font-weight: bold; opacity: 0.6;">
                        ${kp.richness}
                    </div>
                    <h4>${escapeHtml(kp.topic_title_cn || kp.topic_title_id)}</h4>
                    ${kp.chapter_title ? `<div class="chapter">${escapeHtml(kp.chapter_title)}</div>` : ''}
                    <div class="stats">
                        ğŸ“¹ ${kp.videos?.length || 0} |
                        ğŸ“š ${kp.learning_materials_count || 0} |
                        âœï¸ ${kp.practice_questions_count || 0}
                    </div>
                </div>
            `;
        });

        heatmapContent.innerHTML = html;

        // ä¿å­˜æ•°æ®ä¾›ç‚¹å‡»ä½¿ç”¨
        window.heatmapData = kpsWithRichness;
    }

    // æ˜¾ç¤ºçŸ¥è¯†ç‚¹åˆ—è¡¨
    function displayKnowledgePoints(kps) {
        const contentArea = document.getElementById('contentArea');

        if (kps.length === 0) {
            contentArea.innerHTML = '<div class="empty-state"><h3>æš‚æ— çŸ¥è¯†ç‚¹æ•°æ®</h3><p>è¯·å°è¯•å…¶ä»–ç­›é€‰æ¡ä»¶</p></div>';
            return;
        }

        contentArea.innerHTML = '<div class="knowledge-points-grid"></div>';
        const grid = contentArea.querySelector('.knowledge-points-grid');

        kps.forEach((kp, index) => {
            const card = createKnowledgePointCard(kp, index);
            grid.appendChild(card);
        });
    }

    // åˆ›å»ºçŸ¥è¯†ç‚¹å¡ç‰‡
    function createKnowledgePointCard(kp, index) {
        const card = document.createElement('div');
        card.className = 'knowledge-point-card';

        const videos = kp.videos || [];
        const materialsCount = kp.learning_materials_count || 0;
        const questionsCount = kp.practice_questions_count || 0;

        card.innerHTML = `
            <div class="kp-header">
                <h3>${escapeHtml(kp.topic_title_cn || kp.topic_title_id || 'æœªçŸ¥çŸ¥è¯†ç‚¹')}</h3>
                ${kp.chapter_title ? `<div class="chapter">ç« èŠ‚: ${escapeHtml(kp.chapter_title)}</div>` : ''}
                ${kp.learning_objective ? `<div class="objective">${escapeHtml(kp.learning_objective.substring(0, 100))}${kp.learning_objective.length > 100 ? '...' : ''}</div>` : ''}
            </div>
            <div class="charts-container">
                <div class="chart-section">
                    <div class="chart-section-title">
                        <span class="icon">ğŸ“¹</span>
                        <span>è§†é¢‘ (${videos.length}ä¸ª)</span>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="videoChart_${index}"></canvas>
                    </div>
                </div>
                <div class="chart-section">
                    <div class="chart-section-title">
                        <span class="icon">ğŸ“š</span>
                        <span>å­¦ä¹ èµ„æ–™ (${materialsCount}ä¸ª)</span>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="materialChart_${index}"></canvas>
                    </div>
                </div>
                <div class="chart-section">
                    <div class="chart-section-title">
                        <span class="icon">âœï¸</span>
                        <span>äº’åŠ¨é¢˜ç›® (${questionsCount}ä¸ª)</span>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="questionChart_${index}"></canvas>
                    </div>
                </div>
            </div>
        `;

        // åˆ›å»ºæŸ±çŠ¶å›¾
        setTimeout(() => {
            createVideoBarChart(`videoChart_${index}`, videos, kp);
            createMaterialBarChart(`materialChart_${index}`, materialsCount, kp);
            createQuestionBarChart(`questionChart_${index}`, questionsCount, kp);
        }, 100);

        return card;
    }

    // åˆ›å»ºè§†é¢‘æŸ±çŠ¶å›¾ï¼ˆé«˜åº¦ä»£è¡¨AIè¯„åˆ†ï¼‰
    function createVideoBarChart(canvasId, videos, kp) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        if (videos.length === 0) {
            canvas.parentElement.innerHTML = '<div class="chart-empty">æš‚æ— è§†é¢‘æ•°æ®</div>';
            return;
        }

        const ctx = canvas.getContext('2d');
        const scores = videos.map(v => v.overall_score || 0);
        const labels = videos.map((v, i) => `è§†é¢‘${i + 1}`);
        const colors = scores.map(score => {
            if (score >= 8) return '#f44336';
            if (score >= 6) return '#ff9800';
            if (score >= 4) return '#8bc34a';
            return '#4caf50';
        });

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'AIè¯„åˆ†',
                    data: scores,
                    backgroundColor: colors,
                    borderColor: colors,
                    borderWidth: 2,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        ticks: {
                            stepSize: 2,
                            callback: function(value) {
                                return value + 'åˆ†';
                            }
                        },
                        title: {
                            display: true,
                            text: 'AIè¯„åˆ† (0-10åˆ†)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const video = videos[context.dataIndex];
                                return [
                                    `è¯„åˆ†: ${context.parsed.y.toFixed(1)}/10`,
                                    `æ ‡é¢˜: ${video.video_title.substring(0, 30)}${video.video_title.length > 30 ? '...' : ''}`
                                ];
                            }
                        }
                    }
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        showVideoDetail(videos[index], kp);
                    }
                }
            }
        });
    }

    // åˆ›å»ºå­¦ä¹ èµ„æ–™æŸ±çŠ¶å›¾
    function createMaterialBarChart(canvasId, count, kp) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        const ctx = canvas.getContext('2d');

        if (count === 0) {
            canvas.parentElement.innerHTML = '<div class="chart-empty">æš‚æ— å­¦ä¹ èµ„æ–™</div>';
            return;
        }

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['å­¦ä¹ èµ„æ–™'],
                datasets: [{
                    label: 'æ•°é‡',
                    data: [count],
                    backgroundColor: '#4caf50',
                    borderWidth: 2,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                },
                onClick: () => {
                    showDetail('materials', kp);
                }
            }
        });
    }

    // åˆ›å»ºäº’åŠ¨é¢˜ç›®æŸ±çŠ¶å›¾
    function createQuestionBarChart(canvasId, count, kp) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        const ctx = canvas.getContext('2d');

        if (count === 0) {
            canvas.parentElement.innerHTML = '<div class="chart-empty">æš‚æ— äº’åŠ¨é¢˜ç›®</div>';
            return;
        }

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['äº’åŠ¨é¢˜ç›®'],
                datasets: [{
                    label: 'æ•°é‡',
                    data: [count],
                    backgroundColor: '#ff9800',
                    borderWidth: 2,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 10
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                },
                onClick: () => {
                    showDetail('questions', kp);
                }
            }
        });
    }

    // æ˜¾ç¤ºå•ä¸ªè§†é¢‘è¯¦æƒ…
    function showVideoDetail(video, kp) {
        const modal = document.getElementById('detailModal');
        const title = document.getElementById('detailTitle');
        const content = document.getElementById('detailContent');

        title.textContent = `è§†é¢‘è¯¦æƒ… - ${video.video_title.substring(0, 50)}${video.video_title.length > 50 ? '...' : ''}`;

        const score = video.overall_score || 0;
        const scoreClass = score >= 8 ? 'score-excellent' : score >= 6 ? 'score-good' : score >= 4 ? 'score-fair' : 'score-poor';

        content.innerHTML = `
            <div class="detail-section">
                <h3>è§†é¢‘ä¿¡æ¯</h3>
                <div class="video-item">
                    <h4><a href="${escapeHtml(video.video_url)}" target="_blank">${escapeHtml(video.video_title)}</a></h4>
                    <div style="margin-top: 10px;">
                        <span class="score-badge ${scoreClass}">æ€»åˆ†: ${score.toFixed(1)}/10</span>
                        <span style="font-size: 12px; color: #666; margin-left: 10px;">è¯„ä¼°æ—¥æœŸ: ${formatDate(video.evaluation_date)}</span>
                    </div>
                    <div class="score-details" style="margin-top: 15px;">
                        <div class="score-item">
                            <div class="label">è§†è§‰è´¨é‡</div>
                            <div class="value">${(video.visual_quality || 0).toFixed(1)}/10</div>
                        </div>
                        <div class="score-item">
                            <div class="label">å†…å®¹ç›¸å…³åº¦</div>
                            <div class="value">${(video.relevance || 0).toFixed(1)}/10</div>
                        </div>
                        <div class="score-item">
                            <div class="label">æ•™å­¦è´¨é‡</div>
                            <div class="value">${(video.pedagogy || 0).toFixed(1)}/10</div>
                        </div>
                        <div class="score-item">
                            <div class="label">çƒ­åº¦/å…ƒæ•°æ®</div>
                            <div class="value">${(video.metadata || 0).toFixed(1)}/10</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="detail-section">
                <h3>æ‰€å±çŸ¥è¯†ç‚¹</h3>
                <p><strong>${escapeHtml(kp.topic_title_cn || kp.topic_title_id)}</strong></p>
                ${kp.chapter_title ? `<p style="color: #666; margin-top: 5px;">ç« èŠ‚: ${escapeHtml(kp.chapter_title)}</p>` : ''}
                ${kp.learning_objective ? `<p style="color: #666; margin-top: 5px; line-height: 1.6;">å­¦ä¹ ç›®æ ‡: ${escapeHtml(kp.learning_objective)}</p>` : ''}
            </div>
        `;

        modal.style.display = 'block';
    }

    // æ˜¾ç¤ºè¯¦æƒ…ï¼ˆç”¨äºå­¦ä¹ èµ„æ–™å’Œäº’åŠ¨é¢˜ç›®ï¼‰
    function showDetail(type, kp) {
        const modal = document.getElementById('detailModal');
        const title = document.getElementById('detailTitle');
        const content = document.getElementById('detailContent');

        if (type === 'materials') {
            title.textContent = `å­¦ä¹ èµ„æ–™ - ${kp.topic_title_cn || kp.topic_title_id}`;
            content.innerHTML = '<div class="empty-state"><h3>åŠŸèƒ½å¼€å‘ä¸­</h3><p>å­¦ä¹ èµ„æ–™åŠŸèƒ½å³å°†ä¸Šçº¿</p></div>';
        } else if (type === 'questions') {
            title.textContent = `äº’åŠ¨é¢˜ç›® - ${kp.topic_title_cn || kp.topic_title_id}`;
            content.innerHTML = '<div class="empty-state"><h3>åŠŸèƒ½å¼€å‘ä¸­</h3><p>äº’åŠ¨é¢˜ç›®åŠŸèƒ½å³å°†ä¸Šçº¿</p></div>';
        }

        modal.style.display = 'block';
    }

    // å…³é—­è¯¦æƒ…Modal
    function closeDetailModal() {
        document.getElementById('detailModal').style.display = 'none';
    }

    // ç‚¹å‡»Modalå¤–éƒ¨å…³é—­
    window.onclick = function(event) {
        const modal = document.getElementById('detailModal');
        if (event.target === modal) {
            closeDetailModal();
        }
    }

    // å·¥å…·å‡½æ•°
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDate(dateString) {
        if (!dateString) return 'æœªçŸ¥';
        try {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch {
            return dateString;
        }
    }
</script>
{% endblock %}
