{% extends "base_new.html" %}

{% block title %}æŠ¥å‘Šä¸­å¿ƒ - K12æ•™è‚²èµ„æºæœç´¢ç³»ç»Ÿ{% endblock %}

{% block page_css %}
<style>
    .page-header {
        text-align: center;
        color: white;
        margin-bottom: var(--spacing-xl);
    }

    .page-header h1 {
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .page-header p {
        font-size: 1.2rem;
        opacity: 0.9;
    }

    .report-card {
        background: var(--bg-card);
        border-radius: 15px;
        padding: var(--spacing-xl);
        box-shadow: var(--shadow-lg);
        margin-bottom: var(--spacing-lg);
    }

    .config-section {
        background: var(--bg-primary);
        border-radius: var(--border-radius);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
    }

    .config-section h5 {
        color: var(--primary-color);
        margin-bottom: var(--spacing-md);
        font-weight: 600;
    }

    .btn-generate {
        background: var(--primary-gradient);
        border: none;
        color: white;
        padding: 15px 40px;
        border-radius: 25px;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all var(--transition-base);
        width: 100%;
        cursor: pointer;
    }

    .btn-generate:hover {
        transform: scale(1.02);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        color: white;
    }

    .btn-generate:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .progress-container {
        display: none;
        margin-top: var(--spacing-lg);
    }

    .progress {
        height: 30px;
        border-radius: 15px;
        background: var(--border-color);
        overflow: hidden;
    }

    .progress-bar {
        background: var(--primary-gradient);
        transition: width 0.3s ease;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
    }

    .result-container {
        display: none;
        margin-top: var(--spacing-lg);
    }

    .result-card {
        background: var(--bg-primary);
        border-radius: var(--border-radius);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        border-left: 4px solid var(--success-color);
    }

    .result-card h6 {
        color: var(--text-primary);
        font-weight: 600;
        margin-bottom: var(--spacing-sm);
    }

    .result-card p {
        color: var(--text-secondary);
        margin-bottom: 5px;
    }

    .download-link {
        display: inline-block;
        margin-top: 10px;
        padding: 8px 20px;
        background: var(--success-color);
        color: white;
        border-radius: 20px;
        text-decoration: none;
        transition: all var(--transition-base);
    }

    .download-link:hover {
        background: #38a169;
        color: white;
        transform: translateX(5px);
    }

    .stat-box {
        text-align: center;
        padding: var(--spacing-lg);
        background: var(--bg-card);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    .stat-label {
        color: var(--text-secondary);
        font-size: var(--font-sm);
        margin-top: 5px;
    }

    .feature-list {
        list-style: none;
        padding: 0;
        margin-top: var(--spacing-lg);
    }

    .feature-list li {
        padding: 10px 0;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-primary);
    }

    .feature-list li:last-child {
        border-bottom: none;
    }

    .feature-list li i {
        color: var(--primary-color);
        margin-right: 10px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: var(--spacing-lg);
    }

    @media (max-width: 1024px) {
        .form-row {
            grid-template-columns: 1fr;
        }
    }

    .checkbox-group {
        display: flex;
        gap: var(--spacing-md);
        flex-wrap: wrap;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }

    .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .checkbox-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
    }

    .checkbox-list-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .checkbox-list-item input[type="checkbox"]:disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }

    .spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
        margin-right: 10px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="background: var(--primary-gradient); min-height: 100vh; padding: var(--spacing-xl) 20px;">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="page-header">
        <h1>ğŸ“Š æŠ¥å‘Šä¸­å¿ƒ</h1>
        <p>è‡ªåŠ¨ç”Ÿæˆæ•™è‚²èµ„æºåˆ†ææŠ¥å‘Šï¼Œæ”¯æŒå¤šç§æ ¼å¼å¯¼å‡º</p>
    </div>

    <!-- æŠ¥å‘Šé…ç½®å¡ç‰‡ -->
    <div class="report-card">
        <h3 style="margin-bottom: var(--spacing-lg);">
            <i class="fas fa-cog"></i> æŠ¥å‘Šé…ç½®
        </h3>

        <div class="form-row">
            <div>
                <div class="config-section">
                    <h5>âš™ï¸ åŸºæœ¬è®¾ç½®</h5>

                    <form id="reportForm">
                        <div class="form-group">
                            <label for="reportTitle" class="form-label">æŠ¥å‘Šæ ‡é¢˜</label>
                            <input type="text" class="form-input" id="reportTitle"
                                   value="K12æ•™è‚²èµ„æºåˆ†ææŠ¥å‘Š" placeholder="è¯·è¾“å…¥æŠ¥å‘Šæ ‡é¢˜">
                        </div>

                        <div class="form-group">
                            <label for="timeRange" class="form-label">ç»Ÿè®¡æ—¶é—´èŒƒå›´ï¼ˆå¤©ï¼‰</label>
                            <input type="number" class="form-input" id="timeRange"
                                   value="30" min="1" max="365" placeholder="é»˜è®¤30å¤©">
                            <small style="color: var(--text-secondary);">æœç´¢è¡Œä¸ºåˆ†æçš„æ—¶é—´èŒƒå›´</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">è¾“å‡ºæ ¼å¼</label>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" id="formatMarkdown" checked>
                                    <span><i class="fab fa-markdown"></i> Markdown</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" id="formatJson" checked>
                                    <span><i class="fas fa-code"></i> JSON</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">æŠ¥å‘Šå†…å®¹</label>
                            <div class="checkbox-list">
                                <div class="checkbox-list-item">
                                    <input type="checkbox" id="includeOverview" checked disabled>
                                    <label for="includeOverview">å…¨çƒæ•™è‚²èµ„æºæ¦‚è§ˆ</label>
                                </div>
                                <div class="checkbox-list-item">
                                    <input type="checkbox" id="includeDetails" checked disabled>
                                    <label for="includeDetails">å„å›½æ•™è‚²èµ„æºè¯¦æƒ…</label>
                                </div>
                                <div class="checkbox-list-item">
                                    <input type="checkbox" id="includeCoverage" checked disabled>
                                    <label for="includeCoverage">çŸ¥è¯†ç‚¹è¦†ç›–ç‡åˆ†æ</label>
                                </div>
                                <div class="checkbox-list-item">
                                    <input type="checkbox" id="includeBehavior" checked disabled>
                                    <label for="includeBehavior">æœç´¢è¡Œä¸ºåˆ†æ</label>
                                </div>
                                <div class="checkbox-list-item">
                                    <input type="checkbox" id="includePerformance" checked disabled>
                                    <label for="includePerformance">ç³»ç»Ÿæ€§èƒ½æŠ¥å‘Š</label>
                                </div>
                            </div>
                            <small style="color: var(--text-secondary);">æ‰€æœ‰æ ¸å¿ƒå†…å®¹å‡åŒ…å«åœ¨æŠ¥å‘Šä¸­</small>
                        </div>

                        <button type="submit" class="btn-generate" id="generateBtn">
                            <i class="fas fa-magic"></i> ç”ŸæˆæŠ¥å‘Š
                        </button>
                    </form>
                </div>
            </div>

            <div>
                <div class="stat-box" style="margin-bottom: var(--spacing-md);">
                    <div class="stat-value" id="totalReports">0</div>
                    <div class="stat-label">å·²ç”ŸæˆæŠ¥å‘Š</div>
                </div>

                <div class="stat-box">
                    <h6 style="margin-bottom: var(--spacing-md);">æŠ¥å‘ŠåŒ…å«å†…å®¹</h6>
                    <ul class="feature-list">
                        <li><i class="fas fa-check-circle"></i> å…¨çƒæ•™è‚²èµ„æºæ¦‚è§ˆ</li>
                        <li><i class="fas fa-check-circle"></i> å„å›½æ•™è‚²èµ„æºè¯¦æƒ…</li>
                        <li><i class="fas fa-check-circle"></i> çŸ¥è¯†ç‚¹è¦†ç›–ç‡åˆ†æ</li>
                        <li><i class="fas fa-check-circle"></i> æœç´¢è¡Œä¸ºåˆ†æ</li>
                        <li><i class="fas fa-check-circle"></i> ç³»ç»Ÿæ€§èƒ½æŠ¥å‘Š</li>
                        <li><i class="fas fa-check-circle"></i> å¤šç»´åº¦æ•°æ®ç»Ÿè®¡</li>
                        <li><i class="fas fa-check-circle"></i> è¶‹åŠ¿åˆ†æå›¾è¡¨</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- è¿›åº¦æ¡ -->
        <div class="progress-container" id="progressContainer">
            <label class="form-label">æ­£åœ¨ç”ŸæˆæŠ¥å‘Š...</label>
            <div class="progress">
                <div class="progress-bar" id="progressBar" style="width: 0%">
                    <span id="progressText">0%</span>
                </div>
            </div>
            <p style="color: var(--text-secondary); margin-top: var(--spacing-sm);" id="progressStatus">æ­£åœ¨åˆå§‹åŒ–...</p>
        </div>

        <!-- ç”Ÿæˆç»“æœ -->
        <div class="result-container" id="resultContainer">
            <h5 style="margin-bottom: var(--spacing-md);">
                <i class="fas fa-check-circle" style="color: var(--success-color);"></i> æŠ¥å‘Šç”Ÿæˆå®Œæˆ
            </h5>
            <div id="resultCards"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
    let isGenerating = false;

    // é¡µé¢åŠ è½½æ—¶è·å–æŠ¥å‘Šåˆ—è¡¨
    window.addEventListener('load', () => {
        loadReportList();
    });

    // è¡¨å•æäº¤
    document.getElementById('reportForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        if (isGenerating) return;

        const title = document.getElementById('reportTitle').value;
        const timeRange = parseInt(document.getElementById('timeRange').value);
        const formatMarkdown = document.getElementById('formatMarkdown').checked;
        const formatJson = document.getElementById('formatJson').checked;

        if (!formatMarkdown && !formatJson) {
            toast.warning('æ ¼å¼é€‰æ‹©', 'è¯·è‡³å°‘é€‰æ‹©ä¸€ç§è¾“å‡ºæ ¼å¼ï¼');
            return;
        }

        if (timeRange < 1 || timeRange > 365) {
            toast.warning('æ—¶é—´èŒƒå›´', 'æ—¶é—´èŒƒå›´å¿…é¡»åœ¨1-365å¤©ä¹‹é—´ï¼');
            return;
        }

        await generateReport(title, timeRange, formatMarkdown, formatJson);
    });

    async function generateReport(title, timeRange, formatMarkdown, formatJson) {
        isGenerating = true;

        const generateBtn = document.getElementById('generateBtn');
        const progressContainer = document.getElementById('progressContainer');
        const resultContainer = document.getElementById('resultContainer');

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<span class="spinner"></span> æ­£åœ¨ç”Ÿæˆ...';

        // æ˜¾ç¤ºè¿›åº¦æ¡
        progressContainer.style.display = 'block';
        resultContainer.style.display = 'none';

        try {
            // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
            updateProgress(10, 'æ­£åœ¨æ”¶é›†æ•°æ®...');

            const response = await fetch('/api/generate_report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title: title,
                    time_range_days: timeRange,
                    format_markdown: formatMarkdown,
                    format_json: formatJson
                })
            });

            updateProgress(80, 'æ­£åœ¨ç”ŸæˆæŠ¥å‘Šæ–‡ä»¶...');

            const data = await response.json();

            if (data.success) {
                updateProgress(100, 'æŠ¥å‘Šç”Ÿæˆå®Œæˆï¼');

                // æ˜¾ç¤ºç»“æœ
                displayResults(data.results);

                // æ›´æ–°æŠ¥å‘Šè®¡æ•°
                loadReportList();

                toast.success('æŠ¥å‘Šç”Ÿæˆ', 'æŠ¥å‘Šå·²æˆåŠŸç”Ÿæˆï¼');
            } else {
                toast.error('æŠ¥å‘Šç”Ÿæˆå¤±è´¥', data.error || 'æœªçŸ¥é”™è¯¯');
                progressContainer.style.display = 'none';
            }

        } catch (error) {
            console.error('æŠ¥å‘Šç”Ÿæˆé”™è¯¯:', error);
            toast.error('æŠ¥å‘Šç”Ÿæˆå¤±è´¥', error.message);
            progressContainer.style.display = 'none';
        } finally {
            isGenerating = false;
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="fas fa-magic"></i> ç”ŸæˆæŠ¥å‘Š';

            setTimeout(() => {
                progressContainer.style.display = 'none';
            }, 2000);
        }
    }

    function updateProgress(percent, status) {
        document.getElementById('progressBar').style.width = percent + '%';
        document.getElementById('progressText').textContent = percent + '%';
        document.getElementById('progressStatus').textContent = status;
    }

    function displayResults(results) {
        const resultContainer = document.getElementById('resultContainer');
        const resultCards = document.getElementById('resultCards');

        resultCards.innerHTML = '';

        // å…ƒæ•°æ®
        const metadata = results.metadata;

        // MarkdownæŠ¥å‘Š
        if (results.markdown_file) {
            const card = document.createElement('div');
            card.className = 'result-card';
            card.innerHTML = `
                <h6><i class="fab fa-markdown"></i> MarkdownæŠ¥å‘Š</h6>
                <p><strong>æ–‡ä»¶å:</strong> ${results.markdown_file}</p>
                <p><strong>ç”Ÿæˆæ—¶é—´:</strong> ${new Date(metadata.generated_at).toLocaleString('zh-CN')}</p>
                <p><strong>è€—æ—¶:</strong> ${metadata.generation_time.toFixed(2)}ç§’</p>
                <a href="/api/download_report?file=${encodeURIComponent(results.markdown_file)}&type=markdown"
                   class="download-link" download>
                    <i class="fas fa-download"></i> ä¸‹è½½MarkdownæŠ¥å‘Š
                </a>
            `;
            resultCards.appendChild(card);
        }

        // JSONæŠ¥å‘Š
        if (results.json_file) {
            const card = document.createElement('div');
            card.className = 'result-card';
            card.innerHTML = `
                <h6><i class="fas fa-code"></i> JSONæŠ¥å‘Š</h6>
                <p><strong>æ–‡ä»¶å:</strong> ${results.json_file}</p>
                <p><strong>ç”Ÿæˆæ—¶é—´:</strong> ${new Date(metadata.generated_at).toLocaleString('zh-CN')}</p>
                <p><strong>è€—æ—¶:</strong> ${metadata.generation_time.toFixed(2)}ç§’</p>
                <a href="/api/download_report?file=${encodeURIComponent(results.json_file)}&type=json"
                   class="download-link" download>
                    <i class="fas fa-download"></i> ä¸‹è½½JSONæŠ¥å‘Š
                </a>
            `;
            resultCards.appendChild(card);
        }

        resultContainer.style.display = 'block';
    }

    async function loadReportList() {
        try {
            const response = await fetch('/api/list_reports');
            const data = await response.json();

            if (data.success) {
                document.getElementById('totalReports').textContent = data.reports.length;
            }
        } catch (error) {
            console.error('åŠ è½½æŠ¥å‘Šåˆ—è¡¨å¤±è´¥:', error);
        }
    }
</script>
{% endblock %}
