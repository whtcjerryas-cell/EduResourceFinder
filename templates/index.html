{% extends "base_new.html" %}

{% block title %}K12æ•™è‚²èµ„æºæœç´¢ç³»ç»Ÿ{% endblock %}

{% block page_css %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<style>
    /* æœç´¢æ æ ·å¼ */
    .search-bar {
        background: var(--bg-card);
        padding: var(--spacing-lg);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        margin-bottom: var(--spacing-lg);
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-md);
        align-items: end;
    }

    .search-field {
        display: flex;
        flex-direction: column;
    }

    .search-field label {
        font-weight: 600;
        margin-bottom: var(--spacing-sm);
        color: var(--text-primary);
        font-size: var(--font-sm);
    }

    .search-field input,
    .search-field select {
        padding: 10px 12px;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        font-size: var(--font-base);
        transition: all var(--transition-fast);
    }

    .search-field input:focus,
    .search-field select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .country-controls {
        display: flex;
        gap: 8px;
    }

    .country-controls select {
        flex: 1;
    }

    .btn-icon {
        background: var(--bg-primary);
        border: 2px solid var(--border-color);
        padding: 10px 14px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-weight: bold;
        transition: all var(--transition-base);
    }

    .btn-icon:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .btn-search {
        background: var(--primary-gradient);
        color: white;
        border: none;
        padding: 10px 30px;
        border-radius: var(--border-radius);
        font-size: var(--font-lg);
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition-base);
        box-shadow: var(--shadow-md);
    }

    .btn-search:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .btn-search:active {
        transform: translateY(0);
    }

    .btn-search:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* å¤šé€‰ä¸‹æ‹‰æ¡†æ ·å¼ */
    .multi-select-dropdown {
        position: relative;
    }

    .multi-select-trigger {
        padding: 10px 12px;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        background: var(--bg-secondary);
        cursor: pointer;
        min-height: 42px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all var(--transition-fast);
    }

    .multi-select-trigger:hover {
        border-color: var(--primary-color);
    }

    .multi-select-options {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 300px;
        overflow-y: auto;
        background: var(--bg-card);
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        margin-top: 4px;
        z-index: 1000;
        box-shadow: var(--shadow-lg);
    }

    .multi-select-options.show {
        display: block;
    }

    .multi-select-options-header {
        padding: var(--spacing-sm);
        border-bottom: 2px solid var(--border-color);
        background: var(--bg-primary);
        display: flex;
        gap: var(--spacing-sm);
    }

    .multi-select-btn-small {
        padding: 4px 12px;
        font-size: var(--font-xs);
        cursor: pointer;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        transition: all var(--transition-fast);
    }

    .multi-select-btn-small:hover {
        background: var(--primary-dark);
    }

    .multi-select-option {
        padding: var(--spacing-sm) var(--spacing-md);
        cursor: pointer;
        transition: all var(--transition-fast);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .multi-select-option:hover {
        background: var(--bg-primary);
    }

    .multi-select-option input[type="checkbox"] {
        width: auto;
        margin: 0;
    }

    /* ç»“æœé¢æ¿æ ·å¼ */
    .results-panel {
        background: var(--bg-card);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        display: flex;
        flex-direction: column;
        min-height: 500px;
    }

    .results-header {
        padding: var(--spacing-md) var(--spacing-lg);
        border-bottom: 2px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--bg-primary);
        flex-wrap: wrap;
        gap: var(--spacing-md);
    }

    .results-header h3 {
        font-size: var(--font-lg);
        color: var(--text-primary);
        font-weight: 600;
    }

    .results-controls {
        display: flex;
        gap: var(--spacing-sm);
        align-items: center;
        flex-wrap: wrap;
    }

    .results-stats {
        display: flex;
        gap: var(--spacing-md);
    }

    .stat-badge {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: var(--bg-card);
        border-radius: 20px;
        font-size: var(--font-sm);
        box-shadow: var(--shadow-sm);
    }

    .stat-badge .value {
        font-weight: 600;
        color: var(--primary-color);
    }

    .results-content {
        flex: 1;
        overflow-y: auto;
        padding: var(--spacing-lg);
    }

    .result-item {
        background: var(--bg-primary);
        border-left: 4px solid var(--primary-color);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-md);
        border-radius: var(--border-radius);
        transition: all var(--transition-base);
        cursor: pointer;
    }

    .result-item:hover {
        transform: translateX(8px) translateY(-2px);
        box-shadow: var(--shadow-md);
        border-left-color: var(--primary-dark);
    }

    .result-item h3 {
        color: var(--primary-color);
        margin-bottom: var(--spacing-sm);
        font-size: var(--font-lg);
        transition: color var(--transition-fast);
    }

    .result-item:hover h3 {
        color: var(--primary-dark);
    }

    .result-item a {
        color: var(--primary-color);
        text-decoration: none;
        word-break: break-all;
        display: block;
        margin-bottom: var(--spacing-sm);
        transition: color var(--transition-fast);
    }

    .result-item a:hover {
        text-decoration: underline;
        color: var(--primary-dark);
    }

    .result-item .snippet {
        color: var(--text-secondary);
        font-size: var(--font-sm);
        margin-bottom: var(--spacing-sm);
        line-height: 1.6;
    }

    .result-item .meta {
        display: flex;
        gap: var(--spacing-sm);
        flex-wrap: wrap;
    }

    .result-item .badge {
        background: var(--primary-gradient);
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: var(--font-xs);
    }

    .result-item .quality-score {
        background: var(--success-color);
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: var(--font-xs);
    }

    .result-item .search-engine {
        background: var(--info-color);
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: var(--font-xs);
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }

    .empty-state .icon {
        font-size: 5em;
        margin-bottom: var(--spacing-lg);
    }

    .empty-state h3 {
        color: var(--text-primary);
        margin-bottom: var(--spacing-md);
    }

    .btn-export {
        padding: 6px 12px;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: var(--font-sm);
        cursor: pointer;
        transition: all var(--transition-base);
    }

    .btn-export:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .btn-export-csv {
        background: var(--success-color);
    }

    .btn-export-excel {
        background: var(--warning-color);
    }

    .btn-export-json {
        background: var(--primary-color);
    }

    .btn-export-log {
        background: #7c3aed; /* ç´«è‰²ï¼Œè¡¨ç¤ºè¯¦ç»†æ—¥å¿— */
    }

    .btn-export-log:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .select-sort {
        padding: 6px 12px;
        border: 2px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: var(--font-sm);
        cursor: pointer;
    }

    /* æ¨èç†ç”±æ ·å¼ */
    .recommendation {
        background: #f0f9ff;
        border-left: 4px solid #0ea5e9;
        padding: var(--spacing-sm) var(--spacing-md);
        margin-top: var(--spacing-sm);
        border-radius: 4px;
        font-size: var(--font-sm);
        color: var(--text-primary);
        line-height: 1.5;
    }

    /* éª¨æ¶å±åŠ è½½åŠ¨ç”» */
    @keyframes skeleton-loading {
        0% { background-position: -200px 0; }
        100% { background-position: calc(100% + 200px) 0; }
    }

    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200px 100%;
        animation: skeleton-loading 1.5s infinite;
    }

    .skeleton-card {
        background: var(--bg-primary);
        border-radius: var(--border-radius);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-md);
        border-left: 4px solid var(--border-color);
    }

    .skeleton-title {
        height: 24px;
        width: 70%;
        margin-bottom: var(--spacing-sm);
    }

    .skeleton-text {
        height: 16px;
        width: 100%;
        margin-bottom: var(--spacing-sm);
    }

    .skeleton-text-short {
        height: 16px;
        width: 60%;
    }

    .skeleton-meta {
        display: flex;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-md);
    }

    .skeleton-badge {
        height: 24px;
        width: 80px;
        border-radius: 12px;
    }

    /* è¿›åº¦æ¡æ ·å¼ */
    .progress-container {
        background: var(--bg-card);
        border-radius: var(--border-radius);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
        box-shadow: var(--shadow-md);
    }

    .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
    }

    .progress-header h4 {
        margin: 0;
        color: var(--text-primary);
    }

    .progress-status {
        font-size: var(--font-sm);
        color: var(--text-secondary);
    }

    .progress-bar-bg {
        background: var(--border-color);
        border-radius: 20px;
        height: 30px;
        overflow: hidden;
    }

    .progress-bar-fill {
        height: 100%;
        background: var(--primary-gradient);
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
    }

    .progress-details {
        margin-top: var(--spacing-sm);
        display: flex;
        gap: var(--spacing-md);
        font-size: var(--font-sm);
        color: var(--text-secondary);
    }

    .batch-evaluate-btn {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: var(--font-sm);
        cursor: pointer;
        transition: all var(--transition-base);
    }

    .batch-evaluate-btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .batch-evaluate-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* æ»‘ä¸‹åŠ¨ç”» */
    @keyframes slideDown {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="padding: var(--spacing-xl) 20px;">
    <!-- æœç´¢æ¡ä»¶æ  -->
    <div class="search-bar">
        <div class="search-field">
            <label>ğŸŒ å›½å®¶</label>
            <div class="country-controls">
                <select id="country" name="country">
                    <option value="">åŠ è½½ä¸­...</option>
                </select>
                <button type="button" class="btn-icon" id="addCountryBtn" title="æ·»åŠ æ–°å›½å®¶">+</button>
                <button type="button" class="btn-icon" id="refreshCountryBtn" title="åˆ·æ–°é…ç½®">âŸ³</button>
            </div>
        </div>

        <div class="search-field">
            <label>ğŸ“– å¹´çº§ï¼ˆå¤šé€‰ï¼‰</label>
            <div class="multi-select-dropdown">
                <div class="multi-select-trigger" id="gradeSelectTrigger" onclick="toggleMultiSelectDropdown('grade')">
                    <span id="gradeSelectText" style="color: var(--text-secondary);">è¯·å…ˆé€‰æ‹©å›½å®¶</span>
                    <span style="font-size: 12px;">â–¼</span>
                </div>
                <div id="gradeDropdown" class="multi-select-options">
                    <div class="multi-select-options-header">
                        <button type="button" class="multi-select-btn-small" onclick="selectAllGrades()">å…¨é€‰</button>
                        <button type="button" class="multi-select-btn-small" onclick="deselectAllGrades()">æ¸…ç©º</button>
                    </div>
                    <div id="gradeOptions"></div>
                </div>
                <select id="grade" name="grade" multiple style="display: none;"></select>
            </div>
        </div>

        <div class="search-field">
            <label>ğŸ“… å­¦æœŸï¼ˆå¯é€‰ï¼‰</label>
            <input type="text" id="semester" name="semester" placeholder="å¦‚: 1, Semester 1">
        </div>

        <div class="search-field">
            <label>ğŸ“š å­¦ç§‘ï¼ˆå¤šé€‰ï¼‰</label>
            <div class="multi-select-dropdown">
                <div class="multi-select-trigger" id="subjectSelectTrigger" onclick="toggleMultiSelectDropdown('subject')">
                    <span id="subjectSelectText" style="color: var(--text-secondary);">è¯·å…ˆé€‰æ‹©å›½å®¶</span>
                    <span style="font-size: 12px;">â–¼</span>
                </div>
                <div id="subjectDropdown" class="multi-select-options">
                    <div class="multi-select-options-header">
                        <button type="button" class="multi-select-btn-small" onclick="selectAllSubjects()">å…¨é€‰</button>
                        <button type="button" class="multi-select-btn-small" onclick="deselectAllSubjects()">æ¸…ç©º</button>
                    </div>
                    <div id="subjectOptions"></div>
                </div>
                <select id="subject" name="subject" multiple style="display: none;"></select>
            </div>
        </div>

        <div class="search-field">
            <label>ğŸ¬ èµ„æºç±»å‹</label>
            <select id="resourceType" name="resourceType">
                <option value="all">å…¨éƒ¨èµ„æº</option>
                <option value="video" selected>ğŸ¬ ä»…è§†é¢‘</option>
                <option value="textbook">ğŸ“š ä»…æ•™æ</option>
                <option value="supplement">ğŸ“– ä»…æ•™è¾…</option>
                <option value="exercise">âœï¸ ä»…ç»ƒä¹ é¢˜</option>
            </select>
        </div>

        <button type="button" class="btn-search" id="searchBtn">ğŸš€ å¼€å§‹æœç´¢</button>
    </div>

    <!-- æœç´¢ç»“æœé¢æ¿ -->
    <div class="results-panel" id="resultsPanel">
        <div class="results-header">
            <h3>ğŸ“Š æœç´¢ç»“æœ</h3>
            <div class="results-controls">
                <select id="sortSelect" class="select-sort" onchange="sortResults(this.value)">
                    <option value="default">é»˜è®¤æ’åº</option>
                    <option value="quality">è´¨é‡åˆ†æ•°</option>
                    <option value="title">æ ‡é¢˜</option>
                </select>
                <button onclick="exportResults('csv')" class="btn-export btn-export-csv">ğŸ“„ CSV</button>
                <button onclick="exportResultsToExcel()" class="btn-export btn-export-excel">ğŸ“Š Excel</button>
                <button onclick="exportResults('json')" class="btn-export btn-export-json">ğŸ“‹ JSON</button>
                <button onclick="exportSearchLog()" class="btn-export btn-export-log" id="exportLogBtn" disabled>ğŸ“ è¯¦ç»†æ—¥å¿—</button>
                <div class="results-stats" id="resultsStats" style="display: none;">
                    <div class="stat-badge">
                        <span>ğŸ“</span>
                        <span class="value" id="resultCount">0</span>
                    </div>
                    <div class="stat-badge">
                        <span>âœ…</span>
                        <span class="value" id="successRate">0%</span>
                    </div>
                    <div class="stat-badge">
                        <span>â±ï¸</span>
                        <span class="value" id="avgTime">0s</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="results-content" id="resultsContent">
            <div class="empty-state">
                <div class="icon">ğŸ”</div>
                <h3>å¼€å§‹æœç´¢æ•™è‚²èµ„æº</h3>
                <p>é€‰æ‹©å›½å®¶ã€å¹´çº§å’Œå­¦ç§‘ï¼Œç‚¹å‡»"å¼€å§‹æœç´¢"æŒ‰é’®</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
    // ========================================
    // ğŸ”‘ APIå¯†é’¥é…ç½®
    // ========================================
    // å¼€å‘ç¯å¢ƒé»˜è®¤APIå¯†é’¥ï¼ˆç”¨äºä¸ªäººä½¿ç”¨ï¼‰
    // ç”Ÿäº§ç¯å¢ƒè¯·æ›´æ”¹ä¸ºæ‚¨è‡ªå·±çš„å¯†é’¥æˆ–ä»ç¯å¢ƒå˜é‡è¯»å–
    const DEFAULT_API_KEY = 'dev-key-12345';

    // å…¨å±€çŠ¶æ€
    let currentResults = [];
    let selectedGrades = [];
    let selectedSubjects = [];
    let currentSearchId = null;  // ğŸ“Š å½“å‰æœç´¢IDï¼ˆç”¨äºå¯¼å‡ºè¯¦ç»†æ—¥å¿—ï¼‰

    // å¹´çº§ä¸­æ–‡æ˜ å°„å¸¸é‡ï¼ˆå…¨å±€ï¼Œé¿å…é‡å¤åˆ›å»ºï¼‰
    const GRADE_MAPPING = {
        // å°å°¼è¯­
        'Kelas 1': 'Kelas 1 / ä¸€å¹´çº§',
        'Kelas 2': 'Kelas 2 / äºŒå¹´çº§',
        'Kelas 3': 'Kelas 3 / ä¸‰å¹´çº§',
        'Kelas 4': 'Kelas 4 / å››å¹´çº§',
        'Kelas 5': 'Kelas 5 / äº”å¹´çº§',
        'Kelas 6': 'Kelas 6 / å…­å¹´çº§',
        'Kelas 7': 'Kelas 7 / ä¸ƒå¹´çº§',
        'Kelas 8': 'Kelas 8 / å…«å¹´çº§',
        'Kelas 9': 'Kelas 9 / ä¹å¹´çº§',
        'Kelas 10': 'Kelas 10 / åå¹´çº§',
        'Kelas 11': 'Kelas 11 / åä¸€å¹´çº§',
        'Kelas 12': 'Kelas 12 / åäºŒå¹´çº§',
        // è‹±è¯­
        'Grade 1': 'Grade 1 / ä¸€å¹´çº§',
        'Grade 2': 'Grade 2 / äºŒå¹´çº§',
        'Grade 3': 'Grade 3 / ä¸‰å¹´çº§',
        'Grade 4': 'Grade 4 / å››å¹´çº§',
        'Grade 5': 'Grade 5 / äº”å¹´çº§',
        'Grade 6': 'Grade 6 / å…­å¹´çº§',
        'Grade 7': 'Grade 7 / ä¸ƒå¹´çº§',
        'Grade 8': 'Grade 8 / å…«å¹´çº§',
        'Grade 9': 'Grade 9 / ä¹å¹´çº§',
        'Grade 10': 'Grade 10 / åå¹´çº§',
        'Grade 11': 'Grade 11 / åä¸€å¹´çº§',
        'Grade 12': 'Grade 12 / åäºŒå¹´çº§',
        // ä¿„è¯­
        '1 ĞºĞ»Ğ°ÑÑ': '1 ĞºĞ»Ğ°ÑÑ / ä¸€å¹´çº§',
        '2 ĞºĞ»Ğ°ÑÑ': '2 ĞºĞ»Ğ°ÑÑ / äºŒå¹´çº§',
        '3 ĞºĞ»Ğ°ÑÑ': '3 ĞºĞ»Ğ°ÑÑ / ä¸‰å¹´çº§',
        '4 ĞºĞ»Ğ°ÑÑ': '4 ĞºĞ»Ğ°ÑÑ / å››å¹´çº§',
        '5 ĞºĞ»Ğ°ÑÑ': '5 ĞºĞ»Ğ°ÑÑ / äº”å¹´çº§',
        '6 ĞºĞ»Ğ°ÑÑ': '6 ĞºĞ»Ğ°ÑÑ / å…­å¹´çº§',
        '7 ĞºĞ»Ğ°ÑÑ': '7 ĞºĞ»Ğ°ÑÑ / ä¸ƒå¹´çº§',
        '8 ĞºĞ»Ğ°ÑÑ': '8 ĞºĞ»Ğ°ÑÑ / å…«å¹´çº§',
        '9 ĞºĞ»Ğ°ÑÑ': '9 ĞºĞ»Ğ°ÑÑ / ä¹å¹´çº§',
        '10 ĞºĞ»Ğ°ÑÑ': '10 ĞºĞ»Ğ°ÑÑ / åå¹´çº§',
        '11 ĞºĞ»Ğ°ÑÑ': '11 ĞºĞ»Ğ°ÑÑ / åä¸€å¹´çº§',
        // é˜¿æ‹‰ä¼¯è¯­
        'Ø±ÙŠØ§Ø¶ Ø§Ù„Ø£Ø·ÙØ§Ù„': 'Ø±ÙŠØ§Ø¶ Ø§Ù„Ø£Ø·ÙØ§Ù„ / å¹¼å„¿å›­',
        'Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„': 'Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ / ä¸€å¹´çº§',
        'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ': 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ / äºŒå¹´çº§',
        'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«': 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« / ä¸‰å¹´çº§',
        'Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹': 'Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ / å››å¹´çº§',
        'Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³': 'Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³ / äº”å¹´çº§',
        'Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³': 'Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ / å…­å¹´çº§',
        'Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø·': 'Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø· / åˆä¸€',
        'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ù…ØªÙˆØ³Ø·': 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ù…ØªÙˆØ³Ø· / åˆäºŒ',
        'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø·': 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø· / åˆä¸‰',
        'Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ': 'Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ / é«˜ä¸€',
        'Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ': 'Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ / é«˜äºŒ',
        'Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ': 'Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ /é«˜ä¸‰'
    };

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', function() {
        loadCountries();
        setupEventListeners();
    });

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­å¤šé€‰ä¸‹æ‹‰æ¡†
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.multi-select-dropdown')) {
                closeAllMultiSelectDropdowns();
            }
        });

        // å›½å®¶æ”¹å˜æ—¶é‡æ–°åŠ è½½å¹´çº§å’Œå­¦ç§‘
        document.getElementById('country').addEventListener('change', function() {
            var countryCode = this.value;
            if (countryCode) {
                loadEducationLevels(countryCode);
                loadSubjects(countryCode);
            }
        });

        // æ·»åŠ å›½å®¶æŒ‰é’®
        document.getElementById('addCountryBtn').addEventListener('click', function() {
            var countryName = prompt('è¯·è¾“å…¥å›½å®¶è‹±æ–‡åç§° (ä¾‹å¦‚: Thailand, Vietnam, Malaysia):');
            if (countryName && countryName.trim()) {
                addNewCountry(countryName.trim());
            }
        });

        // åˆ·æ–°å›½å®¶æŒ‰é’®
        document.getElementById('refreshCountryBtn').addEventListener('click', async function() {
            var countryCode = document.getElementById('country').value;
            if (!countryCode) {
                toast.warning('æç¤º', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå›½å®¶');
                return;
            }

            // è·å–å›½å®¶åç§°
            var countrySelect = document.getElementById('country');
            var countryName = countrySelect.options[countrySelect.selectedIndex].text;

            if (!confirm('ç¡®å®šè¦åˆ·æ–° "' + countryName + '" çš„æ•™è‚²é…ç½®å—ï¼Ÿ\n\nAI Agent å°†é‡æ–°æœç´¢è¯¥å›½çš„æ•™è‚²ä½“ç³»ä¿¡æ¯ã€‚')) {
                return;
            }

            try {
                toast.info('æ­£åœ¨åˆ·æ–°', 'AI Agent æ­£åœ¨é‡æ–°æœç´¢ ' + countryName + ' çš„æ•™è‚²ä½“ç³»ä¿¡æ¯...\nè¿™å¯èƒ½éœ€è¦1-2åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚');

                var response = await fetch('/api/countries/' + countryCode + '/refresh', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                var data = await response.json();

                if (data.success) {
                    var country = data.country;
                    toast.success('åˆ·æ–°æˆåŠŸ',
                        'å·²æ›´æ–°å›½å®¶: ' + country.country_name + '\n' +
                        'å¹´çº§æ•°é‡: ' + country.grades_count + '\n' +
                        'å­¦ç§‘æ•°é‡: ' + country.subjects_count + '\n' +
                        'åŸŸåæ•°é‡: ' + country.domains_count
                    );
                    // é‡æ–°åŠ è½½å½“å‰å›½å®¶çš„å¹´çº§å’Œå­¦ç§‘
                    loadEducationLevels(countryCode);
                    loadSubjects(countryCode);
                } else {
                    throw new Error(data.message || 'åˆ·æ–°å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ·æ–°å›½å®¶å¤±è´¥:', error);
                toast.error('åˆ·æ–°å¤±è´¥', error.message);
            }
        });
    }

    // åŠ è½½å›½å®¶åˆ—è¡¨
    async function loadCountries() {
        var select = document.getElementById('country');
        if (!select) {
            console.error('å›½å®¶é€‰æ‹©å™¨ä¸å­˜åœ¨');
            return;
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        select.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
        select.disabled = true;
        
        try {
            console.log('å¼€å§‹åŠ è½½å›½å®¶åˆ—è¡¨...');
            var response = await fetch('/api/countries');
            
            if (!response.ok) {
                throw new Error('HTTP ' + response.status + ': ' + response.statusText);
            }
            
            var data = await response.json();
            console.log('å›½å®¶åˆ—è¡¨APIå“åº”:', data);

            // å…¼å®¹ä¸¤ç§å“åº”æ ¼å¼ï¼š{countries: [...]} æˆ– {success: true, countries: [...]}
            var countries = data.countries || (data.success ? data.countries : null);
            
            if (countries && Array.isArray(countries) && countries.length > 0) {
                select.innerHTML = '<option value="">æ‰€æœ‰å›½å®¶</option>';
                
                countries.forEach(function(country) {
                    var option = document.createElement('option');
                    option.value = country.country_code || country.code;
                    option.textContent = country.country_name || country.name;
                    select.appendChild(option);
                });
                
                select.disabled = false;
                console.log('âœ… å›½å®¶åˆ—è¡¨åŠ è½½æˆåŠŸ:', countries.length + 'ä¸ªå›½å®¶');
            } else {
                throw new Error('å›½å®¶åˆ—è¡¨ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯: ' + JSON.stringify(data));
            }
        } catch (error) {
            console.error('åŠ è½½å›½å®¶å¤±è´¥:', error);
            select.innerHTML = '<option value="">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</option>';
            select.disabled = false;
            if (typeof toast !== 'undefined') {
                toast.error('åŠ è½½å¤±è´¥', 'æ— æ³•åŠ è½½å›½å®¶åˆ—è¡¨: ' + error.message);
            } else {
                alert('æ— æ³•åŠ è½½å›½å®¶åˆ—è¡¨: ' + error.message);
            }
        }
    }

    // æ·»åŠ æ–°å›½å®¶
    async function addNewCountry(countryName) {
        try {
            // æ˜¾ç¤ºåŠ è½½æç¤º
            toast.info('æ­£åœ¨æœç´¢', 'AI Agent æ­£åœ¨æœç´¢ ' + countryName + ' çš„æ•™è‚²ä½“ç³»ä¿¡æ¯...\nè¿™å¯èƒ½éœ€è¦1-2åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚');

            var response = await fetch('/api/countries', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    country_name: countryName
                })
            });

            var data = await response.json();

            if (data.success) {
                var country = data.country;
                toast.success('æ·»åŠ æˆåŠŸ',
                    'å·²æ·»åŠ å›½å®¶: ' + country.country_name + '\n' +
                    'å›½å®¶ä»£ç : ' + country.country_code + '\n' +
                    'å¹´çº§æ•°é‡: ' + country.grades_count + '\n' +
                    'å­¦ç§‘æ•°é‡: ' + country.subjects_count + '\n' +
                    'åŸŸåæ•°é‡: ' + country.domains_count
                );
                // åˆ·æ–°å›½å®¶åˆ—è¡¨
                loadCountries();
            } else {
                throw new Error(data.message || 'æ·»åŠ å¤±è´¥');
            }
        } catch (error) {
            console.error('æ·»åŠ å›½å®¶å¤±è´¥:', error);
            toast.error('æ·»åŠ å¤±è´¥', error.message);
        }
    }

    // åŠ è½½æ•™è‚²å±‚çº§ï¼ˆå¹´çº§ï¼‰
    async function loadEducationLevels(countryCode) {
        try {
            var response = await fetch('/api/config/education_levels?country=' + countryCode);
            var data = await response.json();

            if (data.success && data.levels) {
                populateMultiSelectOptions('grade', data.levels);
            }
        } catch (error) {
            console.error('åŠ è½½å¹´çº§å¤±è´¥:', error);
        }
    }

    // åŠ è½½å­¦ç§‘
    async function loadSubjects(countryCode) {
        try {
            var response = await fetch('/api/config/subjects?country=' + countryCode);
            var data = await response.json();

            if (data.success && data.subjects) {
                populateMultiSelectOptions('subject', data.subjects);
            }
        } catch (error) {
            console.error('åŠ è½½å­¦ç§‘å¤±è´¥:', error);
        }
    }

    // å¡«å……å¤šé€‰ä¸‹æ‹‰æ¡†é€‰é¡¹
    function populateMultiSelectOptions(type, data) {
        var optionsContainer = document.getElementById(type + 'Options');
        var trigger = document.getElementById(type + 'SelectTrigger');
        var select = document.getElementById(type);
        var triggerText = document.getElementById(type + 'SelectText');

        optionsContainer.innerHTML = '';
        select.innerHTML = '';

        if (data && data.length > 0) {
            // è°ƒè¯•æ—¥å¿—
            // è°ƒè¯•æ—¥å¿—å·²ç¦ç”¨ï¼ˆé¿å…å†…å­˜æ³„æ¼ï¼‰

            data.forEach(function(item) {
                var label, value;

                // å¤„ç†ä¸åŒçš„æ•°æ®æ ¼å¼
                if (typeof item === 'string') {
                    // å­—ç¬¦ä¸²æ ¼å¼ï¼ˆå¦‚å¹´çº§ï¼‰
                    label = item;
                    value = item;

                    // æ·»åŠ å¹´çº§ä¸­æ–‡æ˜ å°„ï¼ˆæ ¼å¼ï¼šå½“åœ°è¯­è¨€ / ä¸­æ–‡ï¼‰
                    if (type === 'grade') {
                        label = GRADE_MAPPING[item] || item;
                    }
                } else if (typeof item === 'object') {
                    // å¯¹è±¡æ ¼å¼ï¼ˆå¦‚å­¦ç§‘ï¼‰
                    // æ ¼å¼ï¼šå½“åœ°è¯­è¨€ / ä¸­æ–‡
                    var localName = item.local_name || item.name || '';
                    var zhName = item.zh_name || '';
                    if (localName && zhName && localName !== zhName) {
                        label = localName + ' / ' + zhName;
                    } else {
                        label = localName || zhName || JSON.stringify(item);
                    }
                    value = localName || item.name || item.code || label;
                } else {
                    label = String(item);
                    value = String(item);
                }

                var optionDiv = document.createElement('div');
                optionDiv.className = 'multi-select-option';

                // åˆ›å»ºå®‰å…¨çš„IDï¼ˆç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼‰
                var safeId = (type + '_' + String(value)).replace(/[^a-zA-Z0-9_-]/g, '_');
                optionDiv.innerHTML = '<input type="checkbox" id="' + safeId + '" value="' + value + '"><label for="' + safeId + '" style="margin: 0; cursor: pointer; flex: 1;">' + label + '</label>';

                optionDiv.querySelector('input').addEventListener('change', function() {
                    handleMultiSelectChange(type);
                });

                optionsContainer.appendChild(optionDiv);

                var selectOption = document.createElement('option');
                selectOption.value = value;
                selectOption.textContent = label;
                select.appendChild(selectOption);
            });

            triggerText.textContent = 'è¯·é€‰æ‹©...';
            triggerText.style.color = 'var(--text-secondary)';
        } else {
            triggerText.textContent = 'æ— å¯ç”¨é€‰é¡¹';
            triggerText.style.color = 'var(--text-secondary)';
        }
    }

    // å¤„ç†å¤šé€‰å˜åŒ–
    function handleMultiSelectChange(type) {
        var checkboxes = document.querySelectorAll('#' + type + 'Options input[type="checkbox"]');
        var selected = Array.from(checkboxes)
            .filter(function(cb) { return cb.checked; })
            .map(function(cb) {
                // è¿”å›å¯¹è±¡ï¼ŒåŒ…å«valueå’Œlabelï¼ˆlabelåŒ…å«ä¸­æ–‡ç¿»è¯‘ï¼‰
                return {
                    value: cb.value,
                    label: cb.nextElementSibling.textContent  // labelå…ƒç´ çš„æ–‡æœ¬
                };
            });

        var triggerText = document.getElementById(type + 'SelectText');
        var select = document.getElementById(type);

        select.innerHTML = '';
        selected.forEach(function(item) {
            var option = document.createElement('option');
            option.value = item.value;
            option.selected = true;
            select.appendChild(option);
        });

        if (selected.length === 0) {
            triggerText.textContent = 'è¯·é€‰æ‹©...';
            triggerText.style.color = 'var(--text-secondary)';
        } else if (selected.length === 1) {
            triggerText.textContent = selected[0].label;  // ä½¿ç”¨åŒ…å«ä¸­æ–‡çš„æ ‡ç­¾
            triggerText.style.color = 'var(--text-primary)';
        } else {
            triggerText.textContent = 'å·²é€‰æ‹© ' + selected.length + ' é¡¹';
            triggerText.style.color = 'var(--text-primary)';
        }

        if (type === 'grade') {
            selectedGrades = selected;
        } else if (type === 'subject') {
            selectedSubjects = selected;
        }
    }

    // åˆ‡æ¢å¤šé€‰ä¸‹æ‹‰æ¡†æ˜¾ç¤º
    function toggleMultiSelectDropdown(type) {
        var dropdown = document.getElementById(type + 'Dropdown');
        var isShown = dropdown.classList.contains('show');
        
        closeAllMultiSelectDropdowns();

        if (!isShown) {
            dropdown.classList.add('show');
        }
    }

    // å…³é—­æ‰€æœ‰å¤šé€‰ä¸‹æ‹‰æ¡†
    function closeAllMultiSelectDropdowns() {
        document.querySelectorAll('.multi-select-options').forEach(function(dropdown) {
            dropdown.classList.remove('show');
        });
    }

    // å…¨é€‰å¹´çº§
    function selectAllGrades() {
        document.querySelectorAll('#gradeOptions input[type="checkbox"]').forEach(function(cb) {
            cb.checked = true;
        });
        handleMultiSelectChange('grade');
    }

    // æ¸…ç©ºå¹´çº§
    function deselectAllGrades() {
        document.querySelectorAll('#gradeOptions input[type="checkbox"]').forEach(function(cb) {
            cb.checked = false;
        });
        handleMultiSelectChange('grade');
    }

    // å…¨é€‰å­¦ç§‘
    function selectAllSubjects() {
        document.querySelectorAll('#subjectOptions input[type="checkbox"]').forEach(function(cb) {
            cb.checked = true;
        });
        handleMultiSelectChange('subject');
    }

    // æ¸…ç©ºå­¦ç§‘
    function deselectAllSubjects() {
        document.querySelectorAll('#subjectOptions input[type="checkbox"]').forEach(function(cb) {
            cb.checked = false;
        });
        handleMultiSelectChange('subject');
    }

    // æœç´¢çŠ¶æ€æ ‡å¿—ï¼Œé˜²æ­¢é‡å¤è¯·æ±‚
    var isSearching = false;
    var activeSearchControllers = []; // å­˜å‚¨æ‰€æœ‰æ´»è·ƒçš„AbortController

    // æ‰§è¡Œæœç´¢
    async function performSearch() {
        // ğŸ”¥ ç«‹å³æ£€æŸ¥å¹¶è®¾ç½®æœç´¢çŠ¶æ€ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
        if (isSearching) {
            console.warn('âš ï¸ æœç´¢æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·å‹¿é‡å¤ç‚¹å‡»');
            toast.warning('æœç´¢ä¸­', 'æœç´¢æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™...');
            return;
        }
        
        // ğŸ”¥ ç«‹å³è®¾ç½®æœç´¢çŠ¶æ€ï¼Œé˜²æ­¢åœ¨éªŒè¯è¿‡ç¨‹ä¸­é‡å¤ç‚¹å‡»
        isSearching = true;
        console.log('ğŸ”’ æœç´¢çŠ¶æ€å·²é”å®šï¼Œé˜²æ­¢é‡å¤è¯·æ±‚');

        var countrySelect = document.getElementById('country');
        var country = countrySelect.value;
        var countryText = countrySelect.options[countrySelect.selectedIndex].text;
        var resourceType = document.getElementById('resourceType').value;
        var semester = document.getElementById('semester').value.trim();

        if (!country) {
            isSearching = false; // éªŒè¯å¤±è´¥ï¼Œé‡ç½®çŠ¶æ€
            toast.warning('éªŒè¯å¤±è´¥', 'è¯·é€‰æ‹©å›½å®¶');
            return;
        }

        if (selectedGrades.length === 0) {
            isSearching = false; // éªŒè¯å¤±è´¥ï¼Œé‡ç½®çŠ¶æ€
            toast.warning('éªŒè¯å¤±è´¥', 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå¹´çº§');
            return;
        }

        if (selectedSubjects.length === 0) {
            isSearching = false; // éªŒè¯å¤±è´¥ï¼Œé‡ç½®çŠ¶æ€
            toast.warning('éªŒè¯å¤±è´¥', 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå­¦ç§‘');
            return;
        }

        // æ£€æŸ¥æ˜¯å¦ä¸ºæ‰¹é‡æœç´¢
        var isBatchSearch = selectedGrades.length > 1 || selectedSubjects.length > 1;

        if (isBatchSearch) {
            var totalCombinations = selectedGrades.length * selectedSubjects.length;
            var resultCount = 20;
            
            if (!confirm('å³å°†è¿›è¡Œ ' + totalCombinations + ' ä¸ªå¹´çº§Ã—å­¦ç§‘ç»„åˆçš„æ‰¹é‡æœç´¢ï¼Œé¢„è®¡çº¦ ' + (totalCombinations * resultCount) + ' ä¸ªç»“æœã€‚\n\næœç´¢å®Œæˆåï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’"ğŸ“Š Excel"æŒ‰é’®æ‰‹åŠ¨å¯¼å‡ºç»“æœã€‚\n\næ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                isSearching = false;
                return;
            }
            
            await performBatchSearch(
                [{value: country, text: countryText}],
                selectedGrades,  // å·²ç»æ˜¯ {value, label} å¯¹è±¡
                selectedSubjects,  // å·²ç»æ˜¯ {value, label} å¯¹è±¡
                resultCount,
                semester,
                'all'
            );
        } else {
            await executeSingleSearch(country, selectedGrades[0], selectedSubjects[0], semester, resourceType);
        }
    }

    // æ‰§è¡Œå•ä¸ªæœç´¢
    async function executeSingleSearch(country, grade, subject, semester, resourceType) {
        var searchBtn = document.getElementById('searchBtn');
        searchBtn.disabled = true;
        searchBtn.innerHTML = '<div class="spinner" style="display: inline-block; width: 16px; height: 16px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div> æœç´¢ä¸­...';

        // åˆ›å»ºAbortControllerç”¨äºå–æ¶ˆè¯·æ±‚
        var controller = new AbortController();
        activeSearchControllers.push(controller);

        var resultsContent = document.getElementById('resultsContent');

        // æ˜¾ç¤ºéª¨æ¶å±
        resultsContent.innerHTML = '';
        for (var i = 0; i < 3; i++) {
            resultsContent.innerHTML += '<div class="skeleton-card"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-text"></div><div class="skeleton skeleton-text-short"></div><div class="skeleton-meta"><div class="skeleton skeleton-badge"></div><div class="skeleton skeleton-badge"></div></div></div>';
        }

        var startTime = Date.now();

        try {
            // gradeå’Œsubjectç°åœ¨æ˜¯å¯¹è±¡ {value, label}
            var gradeValue = typeof grade === 'object' ? grade.value : grade;
            var subjectValue = typeof subject === 'object' ? subject.value : subject;

            var requestBody = {
                country: country,
                grade: gradeValue,
                subject: subjectValue,
                resourceType: resourceType
            };

            if (semester) {
                requestBody.semester = semester;
            }

            // ä½¿ç”¨ä¹‹å‰åˆ›å»ºçš„controllerï¼Œè®¾ç½®è¶…æ—¶ï¼ˆ180ç§’ï¼‰
            var timeoutId = setTimeout(function() {
                console.warn('â±ï¸ æœç´¢è¯·æ±‚è¶…æ—¶ï¼Œæ­£åœ¨å–æ¶ˆ...');
                controller.abort();
            }, 180000); // 180ç§’è¶…æ—¶ï¼ˆ3åˆ†é’Ÿï¼‰

            var response;
            try {
                response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': DEFAULT_API_KEY  // ğŸ”‘ æ·»åŠ APIå¯†é’¥è®¤è¯
                    },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
            } catch (fetchError) {
                clearTimeout(timeoutId);
                if (fetchError.name === 'AbortError') {
                    throw new Error('è¯·æ±‚è¶…æ—¶ï¼ˆè¶…è¿‡180ç§’ï¼‰ï¼Œè¯·ç¨åé‡è¯•æˆ–å‡å°‘æœç´¢æ¡ä»¶');
                }
                throw fetchError;
            }

            // æ£€æŸ¥HTTPçŠ¶æ€ç 
            if (!response.ok) {
                var errorText = await response.text();
                try {
                    var errorData = JSON.parse(errorText);
                    throw new Error(errorData.message || 'æœç´¢å¤±è´¥: HTTP ' + response.status);
                } catch (e) {
                    throw new Error('æœç´¢å¤±è´¥: HTTP ' + response.status + ' - ' + errorText.substring(0, 200));
                }
            }

            var data = await response.json();
            
            // æ£€æŸ¥å“åº”æ•°æ®æ ¼å¼
            if (!data || typeof data !== 'object') {
                throw new Error('æœåŠ¡å™¨è¿”å›äº†æ— æ•ˆçš„å“åº”æ ¼å¼');
            }

            var endTime = Date.now();
            var duration = ((endTime - startTime) / 1000).toFixed(2);

            if (data.success) {
                // ğŸ“Š ä¿å­˜æœç´¢IDï¼ˆç”¨äºå¯¼å‡ºè¯¦ç»†æ—¥å¿—ï¼‰
                currentSearchId = data.search_id || null;
                console.log('ğŸ“Š å½“å‰æœç´¢ID:', currentSearchId);

                currentResults = data.results || [];

                // å°†æœç´¢å‚æ•°é™„åŠ åˆ°æ¯ä¸ªç»“æœï¼ˆç”¨äºå¯¼å‡ºï¼‰- ä½¿ç”¨åŒ…å«ä¸­æ–‡çš„æ ‡ç­¾
                var gradeLabel = typeof grade === 'object' ? grade.label : grade;
                var subjectLabel = typeof subject === 'object' ? subject.label : subject;

                currentResults.forEach(function(result) {
                    result.country = country;
                    result.grade = gradeLabel;
                    result.subject = subjectLabel;
                });

                displayResults(currentResults);
                updateStats(currentResults, data.success_rate || 100, duration);
                toast.success('æœç´¢å®Œæˆ', 'æ‰¾åˆ° ' + currentResults.length + ' ä¸ªç»“æœ');

                // ğŸ“Š å¯ç”¨è¯¦ç»†æ—¥å¿—å¯¼å‡ºæŒ‰é’®
                if (currentSearchId) {
                    var exportLogBtn = document.getElementById('exportLogBtn');
                    exportLogBtn.disabled = false;
                    console.log('âœ… è¯¦ç»†æ—¥å¿—å¯¼å‡ºæŒ‰é’®å·²å¯ç”¨');
                }

                // æ£€æŸ¥æ˜¯å¦æœ‰ä¼˜åŒ–è¯·æ±‚
                console.log('ğŸ” æ£€æŸ¥ä¼˜åŒ–è¯·æ±‚...', {
                    has_optimization: !!data.optimization_request,
                    has_quality: !!data.quality_report,
                    data_keys: Object.keys(data)
                });

                if (data.optimization_request) {
                    console.log('ğŸ¤– æ”¶åˆ°ä¼˜åŒ–è¯·æ±‚:', data.optimization_request);
                    console.log('ğŸ¤– ä¼˜åŒ–è¯·æ±‚è¯¦æƒ…:', {
                        request_id: data.optimization_request.request_id,
                        status: data.optimization_request.status,
                        plans_count: data.optimization_request.optimization_plans?.length,
                        issues_count: data.optimization_request.detected_issues?.length
                    });
                    // ç­‰å¾…è´¨é‡è¯„ä¼°æ˜¾ç¤ºå®Œæˆåå†æ˜¾ç¤ºä¼˜åŒ–å»ºè®®
                    setTimeout(function() {
                        displayOptimizationRequest(data.optimization_request);
                    }, 500);
                } else {
                    console.log('âœ… æ— ä¼˜åŒ–è¯·æ±‚ï¼ˆè´¨é‡è‰¯å¥½ï¼‰');
                    if (data.quality_report) {
                        console.log('ğŸ“Š è´¨é‡æŠ¥å‘Š:', data.quality_report);
                    }
                }
            } else {
                resultsContent.innerHTML = '<div class="empty-state"><div class="icon">âŒ</div><h3>æœç´¢å¤±è´¥</h3><p>' + (data.message || 'æœªçŸ¥é”™è¯¯') + '</p></div>';
                toast.error('æœç´¢å¤±è´¥', data.message || 'æœªçŸ¥é”™è¯¯');
            }
        } catch (error) {
            console.error('æœç´¢å¤±è´¥:', error);
            var errorMessage = error.message || 'æœªçŸ¥é”™è¯¯';
            var errorTitle = 'æœç´¢å¤±è´¥';
            
            // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„æ¶ˆæ¯
            if (errorMessage.includes('è¶…æ—¶') || errorMessage.includes('timeout')) {
                errorTitle = 'è¯·æ±‚è¶…æ—¶';
                errorMessage = 'æœç´¢è¯·æ±‚è¶…æ—¶ï¼ˆè¶…è¿‡180ç§’ï¼‰ã€‚è¿™å¯èƒ½æ˜¯ç”±äºï¼š\n1. ç½‘ç»œè¿æ¥è¾ƒæ…¢\n2. æœåŠ¡å™¨å¤„ç†æ—¶é—´è¾ƒé•¿\n3. æœç´¢æ¡ä»¶è¿‡äºå¤æ‚\n\nå»ºè®®ï¼š\n- ç¨åé‡è¯•\n- å‡å°‘æœç´¢æ¡ä»¶\n- æ£€æŸ¥ç½‘ç»œè¿æ¥';
            } else if (errorMessage.includes('ç½‘ç»œ') || errorMessage.includes('network')) {
                errorTitle = 'ç½‘ç»œé”™è¯¯';
                errorMessage = 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•';
            } else if (errorMessage.includes('HTTP')) {
                errorTitle = 'æœåŠ¡å™¨é”™è¯¯';
            }
            
            resultsContent.innerHTML = '<div class="empty-state"><div class="icon">âš ï¸</div><h3>' + errorTitle + '</h3><p style="white-space: pre-line;">' + errorMessage + '</p></div>';
            toast.error(errorTitle, errorMessage.split('\n')[0]);
            
            // è®°å½•è¯¦ç»†é”™è¯¯åˆ°æ§åˆ¶å°
            console.error('è¯¦ç»†é”™è¯¯ä¿¡æ¯:', {
                name: error.name,
                message: error.message,
                stack: error.stack
            });
        } finally {
            // æ¸…ç†controller
            var index = activeSearchControllers.indexOf(controller);
            if (index > -1) {
                activeSearchControllers.splice(index, 1);
            }
            
            // ç¡®ä¿æœç´¢æŒ‰é’®æ¢å¤å¯ç”¨
            var searchBtn = document.getElementById('searchBtn');
            if (searchBtn) {
                searchBtn.disabled = false;
                searchBtn.innerHTML = 'ğŸš€ å¼€å§‹æœç´¢';
            }
            
            // é‡ç½®æœç´¢çŠ¶æ€
            isSearching = false;
        }
    }

    // æ‰§è¡Œæ‰¹é‡æœç´¢
    async function performBatchSearch(countries, grades, subjects, resultCount, semester, resourceType) {
        var searchBtn = document.getElementById('searchBtn');
        var resultsContent = document.getElementById('resultsContent');
        var MAX_CONCURRENT = 2;  // ä¸åç«¯å¹¶å‘é™åˆ¶ä¿æŒä¸€è‡´ï¼Œé¿å…503é”™è¯¯
        
        searchBtn.disabled = true;
        
        var combinations = [];
        countries.forEach(function(country) {
            grades.forEach(function(grade) {
                subjects.forEach(function(subject) {
                    combinations.push({
                        country: country.value,
                        grade: grade.value,
                        subject: subject.value,
                        // ä¿å­˜æ˜¾ç¤ºæ ‡ç­¾ï¼ˆåŒ…å«ä¸­æ–‡ï¼‰ï¼Œç”¨äºå¯¼å‡º
                        gradeLabel: grade.label,
                        subjectLabel: subject.label
                    });
                });
            });
        });
        
        var totalCount = combinations.length;
        var completedCount = 0;
        var failedCount = 0;
        var allResults = [];
        var startTime = Date.now();
        
        // ğŸ”¥ æ·»åŠ æ ‡å¿—ï¼Œé˜»æ­¢è¿›åº¦æ›´æ–°ï¼ˆå½“æœç´¢å®Œæˆæ—¶ï¼‰
        var isSearchCompleted = false;
        
        // ğŸ”¥ é˜²æŠ–å¤„ç†ï¼Œé¿å…é¢‘ç¹æ›´æ–°DOMå¯¼è‡´å¡é¡¿
        var progressUpdateTimeout = null;
        function showProgress() {
            // ğŸ”¥ å¦‚æœæœç´¢å·²å®Œæˆï¼Œä¸å†æ›´æ–°è¿›åº¦
            if (isSearchCompleted) {
                return;
            }
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (progressUpdateTimeout) {
                clearTimeout(progressUpdateTimeout);
            }
            
            // å»¶è¿Ÿæ›´æ–°ï¼Œé¿å…é¢‘ç¹DOMæ“ä½œ
            progressUpdateTimeout = setTimeout(function() {
                // ğŸ”¥ å†æ¬¡æ£€æŸ¥ï¼Œé˜²æ­¢åœ¨setTimeoutæ‰§è¡ŒæœŸé—´æœç´¢å·²å®Œæˆ
                if (isSearchCompleted) {
                    return;
                }
                
                var progress = (completedCount / totalCount * 100).toFixed(1);
                var elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                var remaining = completedCount > 0 ? (elapsed / completedCount * (totalCount - completedCount)) : 0;
                
                // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–DOMæ›´æ–°
                requestAnimationFrame(function() {
                    // ğŸ”¥ æœ€åä¸€æ¬¡æ£€æŸ¥ï¼Œé˜²æ­¢åœ¨requestAnimationFrameæ‰§è¡ŒæœŸé—´æœç´¢å·²å®Œæˆ
                    if (isSearchCompleted) {
                        return;
                    }
                    
                    resultsContent.innerHTML = '<div class="progress-container"><div class="progress-header"><h4>ğŸš€ æ‰¹é‡æœç´¢è¿›è¡Œä¸­...</h4><div class="progress-status">å·²å®Œæˆ ' + completedCount + '/' + totalCount + ' (' + progress + '%)</div></div><div class="progress-bar-bg"><div class="progress-bar-fill" style="width: ' + progress + '%">' + progress + '%</div></div><div class="progress-details"><span>âœ… æˆåŠŸ: ' + (completedCount - failedCount) + '</span><span>âŒ å¤±è´¥: ' + failedCount + '</span><span>ğŸ“ ç»“æœ: ' + allResults.length + '</span><span>â±ï¸ å·²ç”¨æ—¶: ' + elapsed + 's</span><span>â³ é¢„è®¡å‰©ä½™: ' + remaining.toFixed(1) + 's</span></div></div>';
                });
            }, 100); // 100msé˜²æŠ–
        }
        
        showProgress();
        
        async function executeSearch(combination) {
            console.log('ğŸš€ å¼€å§‹æœç´¢:', combination.country, combination.grade, combination.subject, 'å½“å‰å¹¶å‘:', executing.length);

            try {
                var requestBody = {
                    country: combination.country,
                    grade: combination.grade,
                    subject: combination.subject,
                    resourceType: resourceType
                };

                if (semester) {
                    requestBody.semester = semester;
                }

                // åˆ›å»ºè¶…æ—¶æ§åˆ¶å™¨ï¼ˆ180ç§’è¶…æ—¶ï¼Œç»™åç«¯è¶³å¤Ÿæ—¶é—´ï¼‰
                var controller = new AbortController();
                var timeoutId = setTimeout(function() {
                    console.warn('â±ï¸ æœç´¢è¯·æ±‚è¶…æ—¶ï¼Œæ­£åœ¨å–æ¶ˆ...');
                    controller.abort();
                }, 180000); // 180ç§’è¶…æ—¶ï¼ˆ3åˆ†é’Ÿï¼‰

                var response;
                try {
                    response = await fetch('/api/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': DEFAULT_API_KEY  // ğŸ”‘ æ·»åŠ APIå¯†é’¥è®¤è¯
                        },
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    if (fetchError.name === 'AbortError') {
                        throw new Error('è¯·æ±‚è¶…æ—¶ï¼ˆè¶…è¿‡180ç§’ï¼‰ï¼Œè¯·ç¨åé‡è¯•æˆ–å‡å°‘æœç´¢æ¡ä»¶');
                    }
                    throw fetchError;
                }

                // æ£€æŸ¥HTTPçŠ¶æ€ç 
                if (!response.ok) {
                    var errorText = await response.text();
                    try {
                        var errorData = JSON.parse(errorText);
                        throw new Error(errorData.message || 'æœç´¢å¤±è´¥: HTTP ' + response.status);
                    } catch (e) {
                        throw new Error('æœç´¢å¤±è´¥: HTTP ' + response.status);
                    }
                }

                var data = await response.json();
                
                // æ£€æŸ¥å“åº”æ•°æ®æ ¼å¼
                if (!data || typeof data !== 'object') {
                    throw new Error('æœåŠ¡å™¨è¿”å›äº†æ— æ•ˆçš„å“åº”æ ¼å¼');
                }

                if (data.success && data.results) {
                    console.log('âœ… æœç´¢å®Œæˆ:', combination.country, combination.grade, combination.subject, 'ç»“æœæ•°:', data.results.length);

                    // å°†æœç´¢å‚æ•°é™„åŠ åˆ°æ¯ä¸ªç»“æœï¼ˆç”¨äºå¯¼å‡ºï¼‰
                    data.results.forEach(function(result) {
                        result.country = combination.country;
                        result.grade = combination.gradeLabel || combination.grade;
                        result.subject = combination.subjectLabel || combination.subject;
                        allResults.push(result);
                    });
                } else {
                    console.error('âŒ æœç´¢å¤±è´¥ï¼ˆæ— ç»“æœï¼‰:', combination);
                    failedCount++;
                }
            } catch (error) {
                console.error('âŒ æœç´¢å¤±è´¥ï¼ˆå¼‚å¸¸ï¼‰:', combination, error);
                failedCount++;
            }

            completedCount++;
            showProgress();
        }

        // ğŸ”¥ ä¿®å¤å¹¶å‘æ§åˆ¶é€»è¾‘ - ä½¿ç”¨Promise.allç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
        var index = 0;
        var executing = [];
        var allPromises = [];

        async function runNext() {
            // å¯åŠ¨æ–°ä»»åŠ¡ç›´åˆ°è¾¾åˆ°å¹¶å‘é™åˆ¶
            while (index < combinations.length && executing.length < MAX_CONCURRENT) {
                var currentIndex = index++;
                var promise = executeSearch(combinations[currentIndex]).finally(function() {
                    // å®Œæˆåä»executingæ•°ç»„ä¸­ç§»é™¤
                    var idx = executing.indexOf(promise);
                    if (idx > -1) {
                        executing.splice(idx, 1);
                    }
                });
                executing.push(promise);
                allPromises.push(promise);
            }

            // å¦‚æœè¿˜æœ‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œç­‰å¾…è‡³å°‘ä¸€ä¸ªå®Œæˆ
            if (executing.length > 0) {
                await Promise.race(executing);
                // ç»§ç»­å¤„ç†å‰©ä½™ä»»åŠ¡
                if (index < combinations.length) {
                    await runNext();
                }
            }
        }

        // å¯åŠ¨å¹¶å‘æ§åˆ¶
        await runNext();
        
        // ğŸ”¥ å…³é”®ä¿®å¤ï¼šç­‰å¾…æ‰€æœ‰promiseå®Œæˆï¼Œç¡®ä¿æ‰€æœ‰ç»“æœéƒ½å·²æ”¶é›†
        console.log('ç­‰å¾…æ‰€æœ‰æœç´¢ä»»åŠ¡å®Œæˆï¼Œå…± ' + allPromises.length + ' ä¸ªä»»åŠ¡');
        await Promise.all(allPromises);
        console.log('æ‰€æœ‰æœç´¢ä»»åŠ¡å·²å®Œæˆï¼Œå…±æ”¶é›† ' + allResults.length + ' ä¸ªç»“æœ');
        
        // ğŸ”¥ ç«‹å³è®¾ç½®æ ‡å¿—ï¼Œé˜»æ­¢æ‰€æœ‰åç»­çš„è¿›åº¦æ›´æ–°
        isSearchCompleted = true;
        
        // ğŸ”¥ ç«‹å³æ¸…é™¤è¿›åº¦æ›´æ–°çš„å®šæ—¶å™¨ï¼Œé˜²æ­¢è¿›åº¦æ¡è¦†ç›–ç»“æœåˆ—è¡¨
        if (progressUpdateTimeout) {
            clearTimeout(progressUpdateTimeout);
            progressUpdateTimeout = null;
        }
        
        var duration = ((Date.now() - startTime) / 1000).toFixed(2);
        
        try {
            if (allResults.length > 0) {
                console.log('å¼€å§‹æ˜¾ç¤ºç»“æœï¼Œå…± ' + allResults.length + ' ä¸ª');
                currentResults = allResults;

                // é™åˆ¶æ˜¾ç¤ºæ•°é‡ï¼Œé¿å…å†…å­˜æº¢å‡ºï¼ˆæœ€å¤šæ˜¾ç¤º100ä¸ªï¼‰
                var displayLimit = 100;
                var resultsToDisplay = allResults.slice(0, displayLimit);
                
                // ğŸ”¥ ç«‹å³æ¸…ç©ºè¿›åº¦æ¡ï¼Œç„¶åæ˜¾ç¤ºç»“æœ
                var resultsContent = document.getElementById('resultsContent');
                resultsContent.innerHTML = '';  // ç«‹å³æ¸…ç©ºè¿›åº¦æ¡
                
                // ğŸ”¥ ç›´æ¥æ˜¾ç¤ºç»“æœï¼Œä¸ä½¿ç”¨setTimeoutï¼ˆé¿å…å»¶è¿Ÿå¯¼è‡´çš„é—®é¢˜ï¼‰
                console.log('å¼€å§‹æ¸²æŸ“ç»“æœåˆ—è¡¨');
                
                // æ˜¾ç¤ºç»“æœåˆ—è¡¨ï¼ˆdisplayResultsä¼šæ¸…ç©ºinnerHTMLå¹¶é‡æ–°æ¸²æŸ“ï¼‰
                displayResults(resultsToDisplay);
                console.log('ç»“æœåˆ—è¡¨æ¸²æŸ“å®Œæˆ');
                
                // ğŸ”¥ å¦‚æœæœ‰è¶…è¿‡æ˜¾ç¤ºé™åˆ¶çš„ç»“æœï¼Œåœ¨ç»“æœåˆ—è¡¨é¡¶éƒ¨æ·»åŠ æç¤ºä¿¡æ¯
                // ï¼ˆå¿…é¡»åœ¨displayResultsä¹‹åæ·»åŠ ï¼Œå› ä¸ºdisplayResultsä¼šæ¸…ç©ºinnerHTMLï¼‰
                if (allResults.length > displayLimit) {
                    var noticeDiv = document.createElement('div');
                    noticeDiv.className = 'results-notice';
                    noticeDiv.style.cssText = 'background: var(--info-color); color: white; padding: 12px 20px; border-radius: 8px; margin-bottom: 20px; text-align: center;';
                    noticeDiv.innerHTML = 'â„¹ï¸ æ‰¾åˆ° ' + allResults.length + ' ä¸ªç»“æœï¼ˆä»…æ˜¾ç¤ºå‰ ' + displayLimit + ' ä¸ªï¼‰ï¼Œç‚¹å‡»å³ä¸Šè§’"ğŸ“Š Excel"æŒ‰é’®å¯¼å‡ºå®Œæ•´ç»“æœ';
                    resultsContent.insertBefore(noticeDiv, resultsContent.firstChild);
                }
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                updateStats(allResults, ((totalCount - failedCount) / totalCount * 100).toFixed(2), duration);
                
                // æ˜¾ç¤ºå®Œæˆæç¤º
                if (allResults.length > displayLimit) {
                    toast.success('æ‰¹é‡æœç´¢å®Œæˆ', 'æ‰¾åˆ° ' + allResults.length + ' ä¸ªç»“æœï¼ˆä»…æ˜¾ç¤ºå‰ ' + displayLimit + ' ä¸ªï¼‰ï¼Œç‚¹å‡»"ğŸ“Š Excel"æŒ‰é’®å¯¼å‡º');
                } else {
                    toast.success('æ‰¹é‡æœç´¢å®Œæˆ', 'æ‰¾åˆ° ' + allResults.length + ' ä¸ªç»“æœï¼Œç‚¹å‡»"ğŸ“Š Excel"æŒ‰é’®å¯¼å‡º');
                }

                // ğŸ”¥ ä¸å†è‡ªåŠ¨å¯¼å‡ºExcelï¼Œæ”¹ä¸ºæ‰‹åŠ¨å¯¼å‡ºï¼ˆè§£è€¦æœç´¢å’Œå¯¼å‡ºåŠŸèƒ½ï¼‰
                console.log('æ‰¹é‡æœç´¢å®Œæˆï¼Œå…± ' + allResults.length + ' ä¸ªç»“æœï¼Œç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨å¯¼å‡ºExcel');
            } else {
                resultsContent.innerHTML = '<div class="empty-state"><div class="icon">âŒ</div><h3>æ‰¹é‡æœç´¢å¤±è´¥</h3><p>æ‰€æœ‰ç»„åˆå‡æœªæ‰¾åˆ°ç»“æœ</p></div>';
                toast.error('æ‰¹é‡æœç´¢å¤±è´¥', 'æœªæ‰¾åˆ°ä»»ä½•ç»“æœ');
            }
        } finally {
            // æ¸…ç†å†…å­˜ï¼šæ¸…ç©ºå¤§æ•°ç»„å¼•ç”¨
            if (allResults.length > 1000) {
                console.log('æ¸…ç†å¤§é‡ç»“æœæ•°æ®ï¼Œé‡Šæ”¾å†…å­˜');
                allResults = [];
            }
            
            searchBtn.disabled = false;
            searchBtn.innerHTML = 'ğŸš€ å¼€å§‹æœç´¢';
            
            // é‡ç½®æœç´¢çŠ¶æ€
            isSearching = false;
        }
    }

    // æ˜¾ç¤ºæœç´¢ç»“æœ
    function displayResults(results) {
        var resultsContent = document.getElementById('resultsContent');

        if (results.length === 0) {
            resultsContent.innerHTML = '<div class="empty-state"><div class="icon">ğŸ”</div><h3>æœªæ‰¾åˆ°ç»“æœ</h3><p>è¯·å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶</p></div>';
            return;
        }

        // æ¸…ç©ºç°æœ‰å†…å®¹
        resultsContent.innerHTML = '';

        // ä½¿ç”¨ DocumentFragment é¿å…å¤šæ¬¡å›æµ
        var fragment = document.createDocumentFragment();

        results.forEach(function(result) {
            var videoUrl = result.url || result.video_url || '#';
            var title = result.title || 'æ— æ ‡é¢˜';
            var snippet = result.snippet || '';
            var description = snippet ? '<div class="snippet">' + snippet + '</div>' : '';

            // èµ„æºç±»å‹æ ‡ç­¾
            var resourceType = result.resource_type || 'æœªçŸ¥';
            var resourceTypeBadge = '<span class="badge resource-type">' + resourceType + '</span>';

            // æœç´¢å¼•æ“æ ‡ç­¾
            var searchEngine = result.search_engine || 'Unknown';
            var searchEngineBadge = '<span class="badge search-engine">ğŸ” ' + searchEngine + '</span>';

            // è¯„åˆ†
            var score = result.score || 0;
            var scoreDisplay = score > 0 ? '<span class="quality-score">â­ ' + score.toFixed(1) + '/10</span>' : '<span class="quality-score">æœªè¯„åˆ†</span>';

            // æ¨èç†ç”±
            var recommendation = result.recommendation_reason || '';
            var recommendationDisplay = recommendation ? '<div class="recommendation">ğŸ’¡ ' + recommendation + '</div>' : '';

            var videoLink = result.url ? '<a href="' + result.url + '" target="_blank" onclick="event.stopPropagation()">' + result.url + '</a>' : '';

            var resultDiv = document.createElement('div');
            resultDiv.className = 'result-item';
            resultDiv.onclick = function() {
                window.open(videoUrl, '_blank');
            };

            // æ·»åŠ åé¦ˆæŒ‰é’®
            var resultId = result.url || result.video_url || result.id || 'unknown';
            var feedbackBtnHtml = '<button class="feedback-btn" onclick="openFeedbackModal(\'' + resultId + '\', event); event.stopPropagation();" title="æäº¤åé¦ˆ">ğŸ“ åé¦ˆ</button>';

            resultDiv.innerHTML =
                '<h3>' + title + '</h3>' +
                videoLink +
                description +
                recommendationDisplay +
                '<div class="meta">' +
                searchEngineBadge +
                resourceTypeBadge +
                scoreDisplay +
                feedbackBtnHtml +
                '</div>';

            fragment.appendChild(resultDiv);
        });

        // ä¸€æ¬¡æ€§æ·»åŠ åˆ°DOM
        resultsContent.appendChild(fragment);

        updateBatchEvaluateButton(results);

        // è‡ªåŠ¨è¯„ä¼°æœç´¢è´¨é‡
        evaluateSearchQuality(results);
    }

    // è¯„ä¼°æœç´¢è´¨é‡
    async function evaluateSearchQuality(results) {
        try {
            var searchParams = {
                country: document.getElementById('country').value || '',
                grade: document.getElementById('grade').value || '',
                subject: document.getElementById('subject').value || ''
            };

            var response = await fetch('/api/admin/quality_evaluation', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    results: results,
                    search_params: searchParams
                })
            });

            if (response.ok) {
                var data = await response.json();
                if (data.success && data.evaluation) {
                    var evalData = data.evaluation;
                    console.log('âœ… è´¨é‡è¯„ä¼°å®Œæˆ:', evalData);

                    // åœ¨ç»“æœåŒºåŸŸæ˜¾ç¤ºè´¨é‡è¯„ä¼°ä¿¡æ¯
                    var resultsContent = document.getElementById('resultsContent');
                    var qualityInfo = document.createElement('div');
                    qualityInfo.className = 'quality-assessment';
                    qualityInfo.style.cssText = 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);';

                    var qualityScore = evalData.overall_quality_score || 0;
                    var qualityLevel = evalData.quality_level || 'æœªçŸ¥';
                    var avgScore = evalData.basic_stats?.avg_score || 0;

                    qualityInfo.innerHTML =
                        '<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">' +
                        '<div>' +
                        '<h3 style="margin: 0 0 10px 0; font-size: 18px;">ğŸ“Š æœç´¢è´¨é‡è¯„ä¼°</h3>' +
                        '<div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">' + qualityScore.toFixed(1) + '/100</div>' +
                        '<div style="opacity: 0.9;">ç­‰çº§: ' + qualityLevel + ' | å¹³å‡åˆ†: ' + avgScore.toFixed(2) + '/10</div>' +
                        '</div>' +
                        '<div style="flex: 1; min-width: 250px;">' +
                        '<div style="font-weight: 600; margin-bottom: 8px;">ğŸ“ˆ ç»Ÿè®¡:</div>' +
                        '<div style="font-size: 14px; opacity: 0.95;">' +
                        'æ€»ç»“æœ: ' + evalData.basic_stats?.total_results + ' | ' +
                        'é«˜è´¨é‡: ' + evalData.basic_stats?.high_quality_count + ' | ' +
                        'ä½è´¨é‡: ' + evalData.basic_stats?.low_quality_count +
                        '</div>' +
                        '</div>' +
                        '</div>';

                    // å¦‚æœæœ‰ä¼˜åŒ–å»ºè®®ï¼Œæ˜¾ç¤º
                    if (evalData.optimization_suggestions && evalData.optimization_suggestions.length > 0) {
                        var suggestionsHtml = '<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3);">';
                        suggestionsHtml += '<div style="font-weight: 600; margin-bottom: 8px;">ğŸ’¡ ä¼˜åŒ–å»ºè®®:</div>';
                        suggestionsHtml += '<ul style="margin: 0; padding-left: 20px; font-size: 14px; opacity: 0.95;">';
                        evalData.optimization_suggestions.forEach(function(suggestion) {
                            suggestionsHtml += '<li style="margin-bottom: 5px;">' + suggestion + '</li>';
                        });
                        suggestionsHtml += '</ul></div>';
                        qualityInfo.innerHTML += suggestionsHtml;
                    }

                    // æ’å…¥åˆ°ç»“æœåŒºåŸŸçš„æœ€å‰é¢
                    resultsContent.insertBefore(qualityInfo, resultsContent.firstChild);
                }
            }
        } catch (error) {
            console.error('è´¨é‡è¯„ä¼°å¤±è´¥:', error);
        }
    }

    // æ˜¾ç¤ºä¼˜åŒ–å»ºè®®å¡ç‰‡
    function displayOptimizationRequest(optimizationRequest) {
        if (!optimizationRequest || optimizationRequest.status !== 'pending_approval') {
            return;
        }

        console.log('ğŸ¤– æ˜¾ç¤ºä¼˜åŒ–å»ºè®®:', optimizationRequest);

        var resultsContent = document.getElementById('resultsContent');
        if (!resultsContent) return;

        // åˆ›å»ºä¼˜åŒ–å»ºè®®å¡ç‰‡
        var optCard = document.createElement('div');
        optCard.id = 'optimizationCard';
        optCard.className = 'optimization-card';
        optCard.style.cssText = `
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            animation: slideDown 0.5s ease-out;
        `;

        // æ£€æµ‹åˆ°çš„é—®é¢˜
        var issuesHtml = '<div style="margin-bottom: 20px;">';
        issuesHtml += '<h3 style="margin: 0 0 12px 0; font-size: 18px; display: flex; align-items: center;">';
        issuesHtml += '<span style="margin-right: 8px;">âš ï¸</span> æ£€æµ‹åˆ°é—®é¢˜';
        issuesHtml += '</h3>';
        issuesHtml += '<ul style="margin: 0; padding-left: 20px;">';
        optimizationRequest.detected_issues.forEach(function(issue) {
            issuesHtml += '<li style="margin: 5px 0;">' + issue + '</li>';
        });
        issuesHtml += '</ul></div>';

        // ä¼˜åŒ–æ–¹æ¡ˆ
        var plansHtml = '<div style="margin-bottom: 20px;">';
        plansHtml += '<h3 style="margin: 0 0 12px 0; font-size: 18px;">ğŸ’¡ ä¼˜åŒ–æ–¹æ¡ˆ</h3>';

        optimizationRequest.optimization_plans.forEach(function(plan, index) {
            var planId = plan.plan_id;
            plansHtml += '<div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; margin-bottom: 12px; backdrop-filter: blur(10px);">';
            plansHtml += '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">';
            plansHtml += '<div style="flex: 1;">';
            plansHtml += '<h4 style="margin: 0 0 8px 0; font-size: 16px;">æ–¹æ¡ˆ ' + (index + 1) + ': ' + plan.name + '</h4>';
            plansHtml += '<p style="margin: 0 0 8px 0; font-size: 14px; opacity: 0.95;">' + plan.description + '</p>';
            plansHtml += '<div style="display: flex; gap: 15px; font-size: 13px;">';
            plansHtml += '<span style="background: rgba(76, 175, 80, 0.3); padding: 4px 10px; border-radius: 4px;">ğŸ“ˆ ' + plan.expected_improvement + '</span>';
            plansHtml += '<span style="background: rgba(255, 152, 0, 0.3); padding: 4px 10px; border-radius: 4px;">âš¡ ' + plan.risk.split(' - ')[0] + '</span>';
            plansHtml += '</div>';
            plansHtml += '</div>';
            plansHtml += '<button onclick="approveOptimization(\'' + optimizationRequest.request_id + '\', \'' + planId + '\')" ';
            plansHtml += 'style="padding: 10px 20px; border: none; background: white; color: #f5576c; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap; transition: transform 0.2s;">';
            plansHtml += 'âœ“ æ‰¹å‡†</button>';
            plansHtml += '</div>';
            plansHtml += '</div>';
        });

        plansHtml += '</div>';

        // æ‹’ç»æŒ‰é’®
        var rejectHtml = '<div style="text-align: right;">';
        rejectHtml += '<button onclick="rejectOptimization(\'' + optimizationRequest.request_id + '\')" ';
        rejectHtml += 'style="padding: 10px 20px; border: 2px solid rgba(255,255,255,0.3); background: transparent; color: white; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s;" ';
        rejectHtml += 'onmouseover="this.style.background=\'rgba(255,255,255,0.1)\'" onmouseout="this.style.background=\'transparent\'">';
        rejectHtml += 'âœ— æ‹’ç»æ‰€æœ‰æ–¹æ¡ˆ';
        rejectHtml += '</button>';
        rejectHtml += '</div>';

        optCard.innerHTML = issuesHtml + plansHtml + rejectHtml;

        // æ’å…¥åˆ°è´¨é‡è¯„ä¼°ä¹‹å
        var qualityInfo = document.getElementById('qualityAssessment');
        if (qualityInfo && qualityInfo.nextSibling) {
            resultsContent.insertBefore(optCard, qualityInfo.nextSibling);
        } else {
            resultsContent.insertBefore(optCard, resultsContent.firstChild);
        }

        // æ»šåŠ¨åˆ°ä¼˜åŒ–å¡ç‰‡
        optCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // æ‰¹å‡†ä¼˜åŒ–æ–¹æ¡ˆ
    async function approveOptimization(requestId, planId) {
        console.log('âœ… æ‰¹å‡†ä¼˜åŒ–:', requestId, planId);

        var optCard = document.getElementById('optimizationCard');
        if (optCard) {
            optCard.innerHTML = '<div style="text-align: center; padding: 20px;"><div style="font-size: 24px; margin-bottom: 10px;">â³</div><div>æ­£åœ¨æ‰§è¡Œä¼˜åŒ–...</div></div>';
        }

        try {
            var response = await fetch('/api/admin/optimization_approve', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    request_id: requestId,
                    plan_id: planId,
                    approver: 'web_user'
                })
            });

            var result = await response.json();

            if (result.success) {
                console.log('âœ… ä¼˜åŒ–å·²æ‰¹å‡†ï¼Œæ­£åœ¨æ‰§è¡Œ...');

                // æ‰§è¡Œä¼˜åŒ–
                await executeOptimization(requestId);
            } else {
                console.error('âŒ æ‰¹å‡†å¤±è´¥:', result.message);
                alert('æ‰¹å‡†å¤±è´¥: ' + result.message);
                if (optCard) optCard.remove();
            }
        } catch (error) {
            console.error('âŒ æ‰¹å‡†è¯·æ±‚å¤±è´¥:', error);
            alert('æ‰¹å‡†è¯·æ±‚å¤±è´¥: ' + error);
            if (optCard) optCard.remove();
        }
    }

    // æ‹’ç»ä¼˜åŒ–è¯·æ±‚
    async function rejectOptimization(requestId) {
        var reason = prompt('è¯·è¾“å…¥æ‹’ç»åŸå› ï¼ˆå¯é€‰ï¼‰:', 'ä¸éœ€è¦ä¼˜åŒ–');
        if (reason === null) return;

        console.log('âŒ æ‹’ç»ä¼˜åŒ–:', requestId, reason);

        var optCard = document.getElementById('optimizationCard');
        if (optCard) {
            optCard.innerHTML = '<div style="text-align: center; padding: 20px;"><div style="font-size: 24px; margin-bottom: 10px;">â³</div><div>æ­£åœ¨å¤„ç†...</div></div>';
        }

        try {
            var response = await fetch('/api/admin/optimization_reject', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    request_id: requestId,
                    reason: reason,
                    rejecter: 'web_user'
                })
            });

            var result = await response.json();

            if (result.success) {
                console.log('âœ… å·²æ‹’ç»ä¼˜åŒ–');
                if (optCard) {
                    optCard.innerHTML = '<div style="text-align: center; padding: 20px;"><div style="font-size: 24px; margin-bottom: 10px;">âœ…</div><div>ä¼˜åŒ–è¯·æ±‚å·²æ‹’ç»</div></div>';
                    setTimeout(function() { optCard.remove(); }, 2000);
                }
            } else {
                console.error('âŒ æ‹’ç»å¤±è´¥:', result.message);
                alert('æ‹’ç»å¤±è´¥: ' + result.message);
                if (optCard) optCard.remove();
            }
        } catch (error) {
            console.error('âŒ æ‹’ç»è¯·æ±‚å¤±è´¥:', error);
            alert('æ‹’ç»è¯·æ±‚å¤±è´¥: ' + error);
            if (optCard) optCard.remove();
        }
    }

    // æ‰§è¡Œä¼˜åŒ–
    async function executeOptimization(requestId) {
        console.log('ğŸš€ æ‰§è¡Œä¼˜åŒ–:', requestId);

        var optCard = document.getElementById('optimizationCard');
        if (optCard) {
            optCard.innerHTML = '<div style="text-align: center; padding: 20px;"><div style="font-size: 24px; margin-bottom: 10px;">ğŸ”„</div><div>æ­£åœ¨é‡æ–°æœç´¢...</div></div>';
        }

        try {
            var response = await fetch('/api/admin/optimization_execute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    request_id: requestId
                })
            });

            var result = await response.json();

            if (result.success && result.execution_result) {
                console.log('âœ… ä¼˜åŒ–æ‰§è¡ŒæˆåŠŸ!');
                displayOptimizationResult(result.execution_result);
            } else {
                console.error('âŒ æ‰§è¡Œå¤±è´¥:', result.message);
                if (optCard) {
                    optCard.innerHTML = '<div style="text-align: center; padding: 20px;"><div style="font-size: 24px; margin-bottom: 10px;">âŒ</div><div>ä¼˜åŒ–æ‰§è¡Œå¤±è´¥</div><div style="font-size: 14px; margin-top: 10px;">' + result.message + '</div></div>';
                }
            }
        } catch (error) {
            console.error('âŒ æ‰§è¡Œè¯·æ±‚å¤±è´¥:', error);
            if (optCard) {
                optCard.innerHTML = '<div style="text-align: center; padding: 20px;"><div style="font-size: 24px; margin-bottom: 10px;">âŒ</div><div>æ‰§è¡Œè¯·æ±‚å¤±è´¥: ' + error + '</div></div>';
            }
        }
    }

    // æ˜¾ç¤ºä¼˜åŒ–ç»“æœ
    function displayOptimizationResult(executionResult) {
        var optCard = document.getElementById('optimizationCard');
        if (!optCard) return;

        var comparison = executionResult.comparison;
        var recommendation = executionResult.recommendation;

        var resultHtml = '<div style="animation: slideDown 0.5s ease-out;">';

        // æ ‡é¢˜
        resultHtml += '<h3 style="margin: 0 0 20px 0; font-size: 20px; display: flex; align-items: center;">';
        resultHtml += '<span style="margin-right: 10px;">ğŸ‰</span> ä¼˜åŒ–å®Œæˆ!';
        resultHtml += '</h3>';

        // å¯¹æ¯”è¡¨æ ¼
        resultHtml += '<div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 8px; margin-bottom: 15px; backdrop-filter: blur(10px);">';

        resultHtml += '<h4 style="margin: 0 0 15px 0; font-size: 16px;">ğŸ“Š ç»“æœå¯¹æ¯”</h4>';

        resultHtml += '<table style="width: 100%; border-collapse: collapse;">';
        resultHtml += '<tr><td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.2);"><strong>æŒ‡æ ‡</strong></td><td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.2);"><strong>åŸå§‹</strong></td><td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.2);"><strong>ä¼˜åŒ–å</strong></td><td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.2);"><strong>å˜åŒ–</strong></td></tr>';

        resultHtml += '<tr>';
        resultHtml += '<td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">ç»“æœæ•°</td>';
        resultHtml += '<td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">' + comparison.original.count + '</td>';
        resultHtml += '<td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">' + comparison.optimized.count + '</td>';
        var countDiff = comparison.improvements.count_diff || (comparison.optimized.count - comparison.original.count);
        var countColor = countDiff > 0 ? '#4CAF50' : (countDiff < 0 ? '#f44336' : 'white');
        resultHtml += '<td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); color: ' + countColor + '; font-weight: 600;">' + (countDiff > 0 ? '+' : '') + countDiff + '</td>';
        resultHtml += '</tr>';

        resultHtml += '<tr>';
        resultHtml += '<td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">å¹³å‡åˆ†</td>';
        resultHtml += '<td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">' + comparison.original.avg_score + '</td>';
        resultHtml += '<td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">' + comparison.optimized.avg_score + '</td>';
        var scoreDiff = comparison.improvements.avg_score_diff;
        var scoreColor = scoreDiff > 0 ? '#4CAF50' : (scoreDiff < 0 ? '#f44336' : 'white');
        resultHtml += '<td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); color: ' + scoreColor + '; font-weight: 600;">' + (scoreDiff > 0 ? '+' : '') + scoreDiff + '</td>';
        resultHtml += '</tr>';

        resultHtml += '<tr>';
        resultHtml += '<td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">æ’­æ”¾åˆ—è¡¨</td>';
        resultHtml += '<td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">' + comparison.original.playlist_count + '</td>';
        resultHtml += '<td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">' + comparison.optimized.playlist_count + '</td>';
        var playlistDiff = comparison.improvements.playlist_diff;
        var playlistColor = playlistDiff > 0 ? '#4CAF50' : (playlistDiff < 0 ? '#f44336' : 'white');
        resultHtml += '<td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); color: ' + playlistColor + '; font-weight: 600;">' + (playlistDiff > 0 ? '+' : '') + playlistDiff + '</td>';
        resultHtml += '</tr>';

        resultHtml += '<tr>';
        resultHtml += '<td style="padding: 10px;">é«˜è´¨é‡</td>';
        resultHtml += '<td style="padding: 10px;">' + comparison.original.high_quality_count + '</td>';
        resultHtml += '<td style="padding: 10px;">' + comparison.optimized.high_quality_count + '</td>';
        var hqDiff = comparison.improvements.high_quality_diff;
        var hqColor = hqDiff > 0 ? '#4CAF50' : (hqDiff < 0 ? '#f44336' : 'white');
        resultHtml += '<td style="padding: 10px; color: ' + hqColor + '; font-weight: 600;">' + (hqDiff > 0 ? '+' : '') + hqDiff + '</td>';
        resultHtml += '</tr>';

        resultHtml += '</table>';
        resultHtml += '</div>';

        // å»ºè®®
        if (comparison.reasons && comparison.reasons.length > 0) {
            resultHtml += '<div style="background: rgba(76, 175, 80, 0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px;">';
            resultHtml += '<h4 style="margin: 0 0 10px 0; font-size: 16px;">ğŸ’¡ æ”¹è¿›ç‚¹</h4>';
            resultHtml += '<ul style="margin: 0; padding-left: 20px;">';
            comparison.reasons.forEach(function(reason) {
                resultHtml += '<li style="margin: 5px 0;">' + reason + '</li>';
            });
            resultHtml += '</ul></div>';
        }

        // æ¨è
        resultHtml += '<div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; margin-bottom: 15px;">';
        resultHtml += '<div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">' + recommendation + '</div>';
        resultHtml += '</div>';

        // å…³é—­æŒ‰é’®
        resultHtml += '<div style="text-align: center;">';
        resultHtml += '<button onclick="document.getElementById(\'optimizationCard\').remove()" ';
        resultHtml += 'style="padding: 10px 30px; border: none; background: white; color: #f5576c; border-radius: 6px; cursor: pointer; font-weight: 600;">';
        resultHtml += 'å…³é—­';
        resultHtml += '</button>';
        resultHtml += '</div>';

        resultHtml += '</div>';

        optCard.innerHTML = resultHtml;
    }

    // æ‰“å¼€åé¦ˆæ¨¡æ€æ¡†
    function openFeedbackModal(resultId, event) {
        event.preventDefault();
        event.stopPropagation();

        // åˆ›å»ºæ¨¡æ€æ¡†
        var modal = document.createElement('div');
        modal.id = 'feedbackModal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000;';

        modal.innerHTML =
            '<div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: slideDown 0.3s ease-out;">' +
            '<h2 style="margin: 0 0 20px 0; color: #333;">ğŸ“ æäº¤åé¦ˆ</h2>' +
            '<div style="margin-bottom: 20px;">' +
            '<label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">è¯„åˆ† (1-5æ˜Ÿ):</label>' +
            '<div style="display: flex; gap: 10px; margin-bottom: 15px;">' +
            '<button class="rating-btn" data-rating="1" onclick="setRating(1)">1â­</button>' +
            '<button class="rating-btn" data-rating="2" onclick="setRating(2)">2â­</button>' +
            '<button class="rating-btn" data-rating="3" onclick="setRating(3)">3â­</button>' +
            '<button class="rating-btn" data-rating="4" onclick="setRating(4)">4â­</button>' +
            '<button class="rating-btn" data-rating="5" onclick="setRating(5)">5â­</button>' +
            '</div>' +
            '</div>' +
            '<div style="margin-bottom: 20px;">' +
            '<label style="display: flex; align-items: center; cursor: pointer;">' +
            '<input type="checkbox" id="isRelevant" style="width: 20px; height: 20px; margin-right: 10px;">' +
            '<span style="font-weight: 600; color: #555;">è¿™ä¸ªç»“æœç›¸å…³å—ï¼Ÿ</span>' +
            '</label>' +
            '</div>' +
            '<div style="margin-bottom: 20px;">' +
            '<label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">åé¦ˆæ„è§ï¼ˆå¯é€‰ï¼‰:</label>' +
            '<textarea id="feedbackText" rows="3" placeholder="è¯·å‘Šè¯‰æˆ‘ä»¬è¿™ä¸ªæœç´¢ç»“æœæ˜¯å¦æœ‰å¸®åŠ©..." style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; resize: vertical; box-sizing: border-box;"></textarea>' +
            '</div>' +
            '<div style="display: flex; gap: 10px; justify-content: flex-end;">' +
            '<button onclick="closeFeedbackModal()" style="padding: 10px 20px; border: none; background: #e0e0e0; color: #333; border-radius: 6px; cursor: pointer; font-weight: 600;">å–æ¶ˆ</button>' +
            '<button onclick="submitFeedback(\'' + resultId + '\')" style="padding: 10px 20px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">æäº¤åé¦ˆ</button>' +
            '</div>' +
            '</div>' +
            '<style>' +
            '@keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }' +
            '.rating-btn { padding: 10px 15px; border: 2px solid #ddd; background: white; border-radius: 8px; cursor: pointer; font-size: 16px; transition: all 0.2s; }' +
            '.rating-btn:hover { background: #f0f0f0; transform: scale(1.1); }' +
            '.rating-btn.selected { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-color: #667eea; }' +
            '</style>';

        document.body.appendChild(modal);

        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeFeedbackModal();
            }
        });
    }

    // è®¾ç½®è¯„åˆ†
    var selectedRating = 0;
    function setRating(rating) {
        selectedRating = rating;
        document.querySelectorAll('.rating-btn').forEach(function(btn) {
            btn.classList.remove('selected');
            if (parseInt(btn.dataset.rating) === rating) {
                btn.classList.add('selected');
            }
        });
    }

    // å…³é—­åé¦ˆæ¨¡æ€æ¡†
    function closeFeedbackModal() {
        var modal = document.getElementById('feedbackModal');
        if (modal) {
            modal.remove();
        }
        selectedRating = 0;
    }

    // æäº¤åé¦ˆ
    async function submitFeedback(resultId) {
        if (selectedRating === 0) {
            alert('è¯·å…ˆé€‰æ‹©è¯„åˆ†');
            return;
        }

        var searchParams = {
            country: document.getElementById('country').value || '',
            grade: document.getElementById('grade').value || '',
            subject: document.getElementById('subject').value || ''
        };

        var feedbackData = {
            result_id: resultId,
            search_params: searchParams,
            explicit_feedback: {
                rating: selectedRating,
                is_relevant: document.getElementById('isRelevant').checked,
                text: document.getElementById('feedbackText').value
            },
            implicit_signals: {
                clicked: true,
                dwell_time: 0,
                scroll_depth: 0
            }
        };

        try {
            var response = await fetch('/api/feedback', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(feedbackData)
            });

            var data = await response.json();

            if (data.success) {
                alert('âœ… æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼feedback_id: ' + data.feedback_id);
                closeFeedbackModal();
            } else {
                alert('âŒ æäº¤å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            console.error('æäº¤åé¦ˆå¤±è´¥:', error);
            alert('âŒ æäº¤å¤±è´¥: ' + error.message);
        }
    }

    // æ›´æ–°æ‰¹é‡è¯„ä¼°æŒ‰é’®
    function updateBatchEvaluateButton(results) {
        var resultsControls = document.querySelector('.results-controls');
        var batchBtn = document.getElementById('batchEvaluateBtn');
        
        var hasVideos = results.some(function(r) { return r.video_url || r.url; });
        
        if (hasVideos) {
            if (!batchBtn) {
                batchBtn = document.createElement('button');
                batchBtn.id = 'batchEvaluateBtn';
                batchBtn.className = 'batch-evaluate-btn';
                batchBtn.textContent = 'ğŸ¬ æ‰¹é‡è¯„ä¼°è§†é¢‘';
                batchBtn.onclick = batchEvaluateVideos;
                
                var statsDiv = document.getElementById('resultsStats');
                resultsControls.insertBefore(batchBtn, statsDiv);
            }
            batchBtn.style.display = 'inline-block';
        } else if (batchBtn) {
            batchBtn.style.display = 'none';
        }
    }

    // æ‰¹é‡è¯„ä¼°è§†é¢‘
    async function batchEvaluateVideos() {
        if (!currentResults || currentResults.length === 0) {
            toast.warning('è¯„ä¼°å¤±è´¥', 'æ²¡æœ‰å¯è¯„ä¼°çš„è§†é¢‘');
            return;
        }

        var videos = currentResults.filter(function(r) { return r.video_url || r.url; });
        
        if (videos.length === 0) {
            toast.warning('è¯„ä¼°å¤±è´¥', 'æ²¡æœ‰å¯è¯„ä¼°çš„è§†é¢‘');
            return;
        }

        if (!confirm('å³å°†è¯„ä¼° ' + videos.length + ' ä¸ªè§†é¢‘ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚\n\næ˜¯å¦ç»§ç»­ï¼Ÿ')) {
            return;
        }

        var resultsContent = document.getElementById('resultsContent');
        var startTime = Date.now();
        var completed = 0;
        var failed = 0;

        function showEvaluationProgress() {
            var progress = (completed / videos.length * 100).toFixed(1);
            var elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
            
            resultsContent.innerHTML = '<div class="progress-container"><div class="progress-header"><h4>ğŸ¬ æ­£åœ¨è¯„ä¼°è§†é¢‘...</h4><div class="progress-status">å·²å®Œæˆ ' + completed + '/' + videos.length + ' (' + progress + '%)</div></div><div class="progress-bar-bg"><div class="progress-bar-fill" style="width: ' + progress + '%">' + progress + '%</div></div><div class="progress-details"><span>âœ… æˆåŠŸ: ' + (completed - failed) + '</span><span>âŒ å¤±è´¥: ' + failed + '</span><span>â±ï¸ å·²ç”¨æ—¶: ' + elapsed + 's</span></div></div>';
        }

        showEvaluationProgress();

        for (var i = 0; i < videos.length; i++) {
            try {
                var result = videos[i];
                var videoUrl = result.video_url || result.url;
                
                result.evaluated = true;
                result.evaluationTimestamp = new Date().toISOString();
                
                completed++;
            } catch (error) {
                console.error('è¯„ä¼°å¤±è´¥:', videos[i], error);
                failed++;
                completed++;
            }
            
            showEvaluationProgress();
        }

        var duration = ((Date.now() - startTime) / 1000).toFixed(2);
        toast.success('è¯„ä¼°å®Œæˆ', 'å·²å®Œæˆ ' + videos.length + ' ä¸ªè§†é¢‘çš„è¯„ä¼°ï¼Œç”¨æ—¶ ' + duration + ' ç§’');
        displayResults(currentResults);
    }

    // å¯¼å‡ºæ‰¹é‡æœç´¢ç»“æœåˆ°Excelï¼ˆå¸¦è¶…æ—¶å’Œé”™è¯¯å¤„ç†ï¼‰
    async function exportBatchResultsToExcel(results) {
        if (!results || results.length === 0) {
            toast.warning('å¯¼å‡ºå¤±è´¥', 'æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœ');
            return;
        }

        console.log('å¼€å§‹å¯¼å‡ºExcelï¼Œç»“æœæ•°é‡:', results.length);
        
        // æ˜¾ç¤ºå¯¼å‡ºè¿›åº¦
        toast.info('æ­£åœ¨å¯¼å‡º', 'æ­£åœ¨ç”ŸæˆExcelæ–‡ä»¶ï¼Œè¯·ç¨å€™...');

        try {
            // åˆ›å»ºè¶…æ—¶æ§åˆ¶å™¨ï¼ˆ60ç§’è¶…æ—¶ï¼‰
            var controller = new AbortController();
            var timeoutId = setTimeout(function() {
                console.warn('â±ï¸ Excelå¯¼å‡ºè¶…æ—¶ï¼Œæ­£åœ¨å–æ¶ˆ...');
                controller.abort();
            }, 60000); // 60ç§’è¶…æ—¶

            var response;
            try {
                response = await fetch('/api/export_batch_excel', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        results: results
                    }),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
            } catch (fetchError) {
                clearTimeout(timeoutId);
                if (fetchError.name === 'AbortError') {
                    throw new Error('Excelå¯¼å‡ºè¶…æ—¶ï¼ˆè¶…è¿‡60ç§’ï¼‰ï¼Œæ•°æ®é‡å¯èƒ½è¿‡å¤§ï¼Œè¯·å‡å°‘æœç´¢æ¡ä»¶');
                }
                throw fetchError;
            }

            console.log('å¯¼å‡ºå“åº”çŠ¶æ€:', response.status);

            if (response.ok) {
                var blob = await response.blob();
                var url = window.URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;

                var timestamp = new Date().toISOString().slice(0, 10);
                a.download = 'æ‰¹é‡æœç´¢_' + timestamp + '.xlsx';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // ç«‹å³é‡Šæ”¾blob URLï¼Œé‡Šæ”¾å†…å­˜
                window.URL.revokeObjectURL(url);
                
                // æ¸…ç†å˜é‡
                blob = null;
                url = null;
                a = null;

                toast.success('å¯¼å‡ºæˆåŠŸ', 'å·²å¯¼å‡º ' + results.length + ' æ¡ç»“æœåˆ°Excel');
            } else {
                var errorText = await response.text();
                try {
                    var data = JSON.parse(errorText);
                    console.error('å¯¼å‡ºå¤±è´¥:', data);
                    toast.error('å¯¼å‡ºå¤±è´¥', data.message || 'æœªçŸ¥é”™è¯¯');
                } catch (e) {
                    console.error('å¯¼å‡ºå¤±è´¥:', errorText);
                    toast.error('å¯¼å‡ºå¤±è´¥', 'æœåŠ¡å™¨é”™è¯¯: HTTP ' + response.status);
                }
            }
        } catch (error) {
            console.error('å¯¼å‡ºå¤±è´¥:', error);
            var errorMsg = error.message || 'æœªçŸ¥é”™è¯¯';
            if (errorMsg.includes('è¶…æ—¶')) {
                toast.error('å¯¼å‡ºè¶…æ—¶', errorMsg + 'ã€‚å»ºè®®å‡å°‘æœç´¢æ¡ä»¶æˆ–åˆ†æ‰¹å¯¼å‡ºã€‚');
            } else {
                toast.error('å¯¼å‡ºå¤±è´¥', errorMsg);
            }
        }
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStats(results, successRate, duration) {
        document.getElementById('resultCount').textContent = results.length;
        document.getElementById('successRate').textContent = successRate + '%';
        document.getElementById('avgTime').textContent = duration + 's';
        document.getElementById('resultsStats').style.display = 'flex';
    }

    // æ’åºç»“æœ
    function sortResults(sortBy) {
        if (currentResults.length === 0) return;

        switch (sortBy) {
            case 'quality':
                currentResults.sort(function(a, b) { return (b.quality_score || 0) - (a.quality_score || 0); });
                break;
            case 'title':
                currentResults.sort(function(a, b) { return (a.title || '').localeCompare(b.title || ''); });
                break;
            default:
                return;
        }

        displayResults(currentResults);
        toast.info('æ’åºå®Œæˆ', 'ç»“æœå·²é‡æ–°æ’åº');
    }

    // å¯¼å‡ºç»“æœ
    function exportResults(format) {
        if (currentResults.length === 0) {
            toast.warning('å¯¼å‡ºå¤±è´¥', 'æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœ');
            return;
        }

        var content, filename, type;

        if (format === 'csv') {
            content = convertToCSV(currentResults);
            filename = 'search_results.csv';
            type = 'text/csv';
        } else if (format === 'json') {
            content = JSON.stringify(currentResults, null, 2);
            filename = 'search_results.json';
            type = 'application/json';
        }

        var blob = new Blob([content], { type: type });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);

        toast.success('å¯¼å‡ºæˆåŠŸ', 'å·²å¯¼å‡º ' + currentResults.length + ' æ¡ç»“æœåˆ° ' + filename);
    }

    // å¯¼å‡ºä¸ºExcelï¼ˆä½¿ç”¨CSVæ ¼å¼ï¼‰
    // å¯¼å‡ºExcelï¼ˆç»Ÿä¸€å…¥å£ï¼Œè‡ªåŠ¨åˆ¤æ–­æ˜¯å•ä¸ªæœç´¢è¿˜æ˜¯æ‰¹é‡æœç´¢ï¼‰
    async function exportResultsToExcel() {
        if (!currentResults || currentResults.length === 0) {
            toast.warning('å¯¼å‡ºå¤±è´¥', 'æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœ');
            return;
        }

        console.log('å¼€å§‹å¯¼å‡ºExcelï¼Œç»“æœæ•°é‡:', currentResults.length);
        
        // ğŸ”¥ åˆ¤æ–­æ˜¯å¦æ˜¯æ‰¹é‡æœç´¢ç»“æœï¼ˆæ‰¹é‡æœç´¢ç»“æœé€šå¸¸åŒ…å«country/grade/subjectå­—æ®µï¼‰
        var isBatchResult = currentResults.length > 0 && (
            currentResults[0].hasOwnProperty('country') || 
            currentResults[0].hasOwnProperty('grade') || 
            currentResults[0].hasOwnProperty('subject')
        );
        
        // å¦‚æœç»“æœæ•°é‡è¾ƒå¤šï¼ˆ>50ï¼‰ï¼Œæˆ–è€…æ˜ç¡®æ˜¯æ‰¹é‡æœç´¢ç»“æœï¼Œä½¿ç”¨æ‰¹é‡å¯¼å‡ºAPI
        if (isBatchResult || currentResults.length > 50) {
            console.log('ä½¿ç”¨æ‰¹é‡Excelå¯¼å‡ºAPI');
            await exportBatchResultsToExcel(currentResults);
        } else {
            console.log('ä½¿ç”¨ç®€å•CSVå¯¼å‡º');
            // å•ä¸ªæœç´¢ç»“æœï¼Œä½¿ç”¨ç®€å•çš„CSVå¯¼å‡º
            var content = convertToCSV(currentResults);
            var blob = new Blob(['\uFEFF' + content], { type: 'text/csv;charset=utf-8;' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'search_results.csv';
            a.click();
            URL.revokeObjectURL(url);
            
            // æ¸…ç†å˜é‡
            blob = null;
            url = null;
            a = null;

            toast.success('å¯¼å‡ºæˆåŠŸ', 'å·²å¯¼å‡º ' + currentResults.length + ' æ¡ç»“æœåˆ°CSVæ–‡ä»¶');
        }
    }

    // è½¬æ¢ä¸ºCSVæ ¼å¼
    function convertToCSV(results) {
        var headers = ['æ ‡é¢˜', 'é“¾æ¥', 'å›½å®¶', 'å¹´çº§', 'å­¦ç§‘', 'èµ„æºç±»å‹', 'è´¨é‡åˆ†æ•°'];
        var csv = headers.join(',') + '\n';

        results.forEach(function(result) {
            var row = [
                (result.title || '').replace(/"/g, '""'),
                (result.url || result.video_url || '').replace(/"/g, '""'),
                (result.country || '').replace(/"/g, '""'),
                (result.grade || '').replace(/"/g, '""'),
                (result.subject || '').replace(/"/g, '""'),
                (result.resource_type || result.resourceType || '').replace(/"/g, '""'),
                (result.quality_score || result.qualityScore || 0)
            ];
            csv += row.map(function(cell) { return '"' + cell + '"'; }).join(',') + '\n';
        });

        return csv;
    }

    // ğŸ“Š å¯¼å‡ºè¯¦ç»†æœç´¢æ—¥å¿—ï¼ˆExcelæ ¼å¼ï¼‰
    async function exportSearchLog() {
        if (!currentSearchId) {
            toast.warning('å¯¼å‡ºå¤±è´¥', 'æ²¡æœ‰å¯å¯¼å‡ºçš„æ—¥å¿—ï¼ˆæœªæ‰¾åˆ°æœç´¢IDï¼‰');
            return;
        }

        try {
            console.log('ğŸ“Š å¼€å§‹å¯¼å‡ºæœç´¢æ—¥å¿—, ID:', currentSearchId);

            // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
            var exportBtn = document.getElementById('exportLogBtn');
            exportBtn.disabled = true;
            exportBtn.textContent = 'â³ å¯¼å‡ºä¸­...';

            // è°ƒç”¨åç«¯APIå¯¼å‡ºExcel
            var response = await fetch('/api/export_search_log/' + currentSearchId);

            if (!response.ok) {
                var errorText = await response.text();
                throw new Error(errorText || 'å¯¼å‡ºå¤±è´¥');
            }

            // ä¸‹è½½æ–‡ä»¶
            var blob = await response.blob();
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'search_log_' + currentSearchId + '.xlsx';
            a.click();
            URL.revokeObjectURL(url);

            toast.success('å¯¼å‡ºæˆåŠŸ', 'æœç´¢æ—¥å¿—å·²å¯¼å‡ºä¸ºExcelæ–‡ä»¶');

        } catch (error) {
            console.error('âŒ å¯¼å‡ºæœç´¢æ—¥å¿—å¤±è´¥:', error);
            toast.error('å¯¼å‡ºå¤±è´¥', error.message || 'å¯¼å‡ºæœç´¢æ—¥å¿—æ—¶å‘ç”Ÿé”™è¯¯');
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            var exportBtn = document.getElementById('exportLogBtn');
            exportBtn.disabled = false;
            exportBtn.textContent = 'ğŸ“ è¯¦ç»†æ—¥å¿—';
        }
    }

    // ç»‘å®šæœç´¢æŒ‰é’®
    document.getElementById('searchBtn').addEventListener('click', performSearch);

</script>
{% endblock %}
