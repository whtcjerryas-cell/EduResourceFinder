{% extends "base_new.html" %}

{% block title %}K12æ•™è‚²èµ„æºæœç´¢ç³»ç»Ÿ{% endblock %}

{% block page_css %}
<style>
    /* æœç´¢æ æ ·å¼ */
    .search-bar {
        background: var(--bg-card);
        padding: var(--spacing-lg);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        margin-bottom: var(--spacing-lg);
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-md);
        align-items: end;
    }

    .search-field {
        display: flex;
        flex-direction: column;
    }

    .search-field label {
        font-weight: 600;
        margin-bottom: var(--spacing-sm);
        color: var(--text-primary);
        font-size: var(--font-sm);
    }

    .search-field input,
    .search-field select {
        padding: 10px 12px;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        font-size: var(--font-base);
        transition: all var(--transition-fast);
    }

    .search-field input:focus,
    .search-field select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .country-controls {
        display: flex;
        gap: 8px;
    }

    .country-controls select {
        flex: 1;
    }

    .btn-icon {
        background: var(--bg-primary);
        border: 2px solid var(--border-color);
        padding: 10px 14px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-weight: bold;
        transition: all var(--transition-base);
    }

    .btn-icon:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .btn-search {
        background: var(--primary-gradient);
        color: white;
        border: none;
        padding: 10px 30px;
        border-radius: var(--border-radius);
        font-size: var(--font-lg);
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition-base);
        box-shadow: var(--shadow-md);
    }

    .btn-search:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .btn-search:active {
        transform: translateY(0);
    }

    .btn-search:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* å¤šé€‰ä¸‹æ‹‰æ¡†æ ·å¼ */
    .multi-select-dropdown {
        position: relative;
    }

    .multi-select-trigger {
        padding: 10px 12px;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        background: var(--bg-secondary);
        cursor: pointer;
        min-height: 42px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all var(--transition-fast);
    }

    .multi-select-trigger:hover {
        border-color: var(--primary-color);
    }

    .multi-select-options {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 300px;
        overflow-y: auto;
        background: var(--bg-card);
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        margin-top: 4px;
        z-index: 1000;
        box-shadow: var(--shadow-lg);
    }

    .multi-select-options.show {
        display: block;
    }

    .multi-select-options-header {
        padding: var(--spacing-sm);
        border-bottom: 2px solid var(--border-color);
        background: var(--bg-primary);
        display: flex;
        gap: var(--spacing-sm);
    }

    .multi-select-btn-small {
        padding: 4px 12px;
        font-size: var(--font-xs);
        cursor: pointer;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        transition: all var(--transition-fast);
    }

    .multi-select-btn-small:hover {
        background: var(--primary-dark);
    }

    .multi-select-option {
        padding: var(--spacing-sm) var(--spacing-md);
        cursor: pointer;
        transition: all var(--transition-fast);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .multi-select-option:hover {
        background: var(--bg-primary);
    }

    .multi-select-option input[type="checkbox"] {
        width: auto;
        margin: 0;
    }

    /* ç»“æœé¢æ¿æ ·å¼ */
    .results-panel {
        background: var(--bg-card);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        display: flex;
        flex-direction: column;
        min-height: 500px;
    }

    .results-header {
        padding: var(--spacing-md) var(--spacing-lg);
        border-bottom: 2px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--bg-primary);
        flex-wrap: wrap;
        gap: var(--spacing-md);
    }

    .results-header h3 {
        font-size: var(--font-lg);
        color: var(--text-primary);
        font-weight: 600;
    }

    .results-controls {
        display: flex;
        gap: var(--spacing-sm);
        align-items: center;
        flex-wrap: wrap;
    }

    .results-stats {
        display: flex;
        gap: var(--spacing-md);
    }

    .stat-badge {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: var(--bg-card);
        border-radius: 20px;
        font-size: var(--font-sm);
        box-shadow: var(--shadow-sm);
    }

    .stat-badge .value {
        font-weight: 600;
        color: var(--primary-color);
    }

    .results-content {
        flex: 1;
        overflow-y: auto;
        padding: var(--spacing-lg);
    }

    .result-item {
        background: var(--bg-primary);
        border-left: 4px solid var(--primary-color);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-md);
        border-radius: var(--border-radius);
        transition: all var(--transition-base);
        cursor: pointer;
    }

    .result-item:hover {
        transform: translateX(8px) translateY(-2px);
        box-shadow: var(--shadow-md);
        border-left-color: var(--primary-dark);
    }

    .result-item h3 {
        color: var(--primary-color);
        margin-bottom: var(--spacing-sm);
        font-size: var(--font-lg);
        transition: color var(--transition-fast);
    }

    .result-item:hover h3 {
        color: var(--primary-dark);
    }

    .result-item a {
        color: var(--primary-color);
        text-decoration: none;
        word-break: break-all;
        display: block;
        margin-bottom: var(--spacing-sm);
        transition: color var(--transition-fast);
    }

    .result-item a:hover {
        text-decoration: underline;
        color: var(--primary-dark);
    }

    .result-item .snippet {
        color: var(--text-secondary);
        font-size: var(--font-sm);
        margin-bottom: var(--spacing-sm);
        line-height: 1.6;
    }

    .result-item .meta {
        display: flex;
        gap: var(--spacing-sm);
        flex-wrap: wrap;
    }

    .result-item .badge {
        background: var(--primary-gradient);
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: var(--font-xs);
    }

    .result-item .quality-score {
        background: var(--success-color);
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: var(--font-xs);
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }

    .empty-state .icon {
        font-size: 5em;
        margin-bottom: var(--spacing-lg);
    }

    .empty-state h3 {
        color: var(--text-primary);
        margin-bottom: var(--spacing-md);
    }

    .btn-export {
        padding: 6px 12px;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: var(--font-sm);
        cursor: pointer;
        transition: all var(--transition-base);
    }

    .btn-export:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .btn-export-csv {
        background: var(--success-color);
    }

    .btn-export-excel {
        background: var(--warning-color);
    }

    .btn-export-json {
        background: var(--primary-color);
    }

    .select-sort {
        padding: 6px 12px;
        border: 2px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: var(--font-sm);
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="padding: var(--spacing-xl) 20px;">
    <!-- æœç´¢æ¡ä»¶æ  -->
    <div class="search-bar">
        <div class="search-field">
            <label>ğŸŒ å›½å®¶</label>
            <div class="country-controls">
                <select id="country" name="country">
                    <option value="">åŠ è½½ä¸­...</option>
                </select>
                <button type="button" class="btn-icon" id="addCountryBtn" title="æ·»åŠ æ–°å›½å®¶">+</button>
                <button type="button" class="btn-icon" id="refreshCountryBtn" title="åˆ·æ–°é…ç½®">âŸ³</button>
            </div>
        </div>

        <div class="search-field">
            <label>ğŸ“– å¹´çº§ï¼ˆå¤šé€‰ï¼‰</label>
            <div class="multi-select-dropdown">
                <div class="multi-select-trigger" id="gradeSelectTrigger" onclick="toggleMultiSelectDropdown('grade')">
                    <span id="gradeSelectText" style="color: var(--text-secondary);">è¯·å…ˆé€‰æ‹©å›½å®¶</span>
                    <span style="font-size: 12px;">â–¼</span>
                </div>
                <div id="gradeDropdown" class="multi-select-options">
                    <div class="multi-select-options-header">
                        <button type="button" class="multi-select-btn-small" onclick="selectAllGrades()">å…¨é€‰</button>
                        <button type="button" class="multi-select-btn-small" onclick="deselectAllGrades()">æ¸…ç©º</button>
                    </div>
                    <div id="gradeOptions"></div>
                </div>
                <select id="grade" name="grade" multiple style="display: none;"></select>
            </div>
        </div>

        <div class="search-field">
            <label>ğŸ“… å­¦æœŸï¼ˆå¯é€‰ï¼‰</label>
            <input type="text" id="semester" name="semester" placeholder="å¦‚: 1, Semester 1">
        </div>

        <div class="search-field">
            <label>ğŸ“š å­¦ç§‘ï¼ˆå¤šé€‰ï¼‰</label>
            <div class="multi-select-dropdown">
                <div class="multi-select-trigger" id="subjectSelectTrigger" onclick="toggleMultiSelectDropdown('subject')">
                    <span id="subjectSelectText" style="color: var(--text-secondary);">è¯·å…ˆé€‰æ‹©å›½å®¶</span>
                    <span style="font-size: 12px;">â–¼</span>
                </div>
                <div id="subjectDropdown" class="multi-select-options">
                    <div class="multi-select-options-header">
                        <button type="button" class="multi-select-btn-small" onclick="selectAllSubjects()">å…¨é€‰</button>
                        <button type="button" class="multi-select-btn-small" onclick="deselectAllSubjects()">æ¸…ç©º</button>
                    </div>
                    <div id="subjectOptions"></div>
                </div>
                <select id="subject" name="subject" multiple style="display: none;"></select>
            </div>
        </div>

        <div class="search-field">
            <label>ğŸ¬ èµ„æºç±»å‹</label>
            <select id="resourceType" name="resourceType">
                <option value="all">å…¨éƒ¨èµ„æº</option>
                <option value="video" selected>ğŸ¬ ä»…è§†é¢‘</option>
                <option value="textbook">ğŸ“š ä»…æ•™æ</option>
                <option value="supplement">ğŸ“– ä»…æ•™è¾…</option>
                <option value="exercise">âœï¸ ä»…ç»ƒä¹ é¢˜</option>
            </select>
        </div>

        <button type="button" class="btn-search" id="searchBtn">ğŸš€ å¼€å§‹æœç´¢</button>
    </div>

    <!-- æœç´¢ç»“æœé¢æ¿ -->
    <div class="results-panel" id="resultsPanel">
        <div class="results-header">
            <h3>ğŸ“Š æœç´¢ç»“æœ</h3>
            <div class="results-controls">
                <select id="sortSelect" class="select-sort" onchange="sortResults(this.value)">
                    <option value="default">é»˜è®¤æ’åº</option>
                    <option value="quality">è´¨é‡åˆ†æ•°</option>
                    <option value="title">æ ‡é¢˜</option>
                </select>
                <button onclick="exportResults('csv')" class="btn-export btn-export-csv">ğŸ“„ CSV</button>
                <button onclick="exportResultsToExcel()" class="btn-export btn-export-excel">ğŸ“Š Excel</button>
                <button onclick="exportResults('json')" class="btn-export btn-export-json">ğŸ“‹ JSON</button>
                <div class="results-stats" id="resultsStats" style="display: none;">
                    <div class="stat-badge">
                        <span>ğŸ“</span>
                        <span class="value" id="resultCount">0</span>
                    </div>
                    <div class="stat-badge">
                        <span>âœ…</span>
                        <span class="value" id="successRate">0%</span>
                    </div>
                    <div class="stat-badge">
                        <span>â±ï¸</span>
                        <span class="value" id="avgTime">0s</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="results-content" id="resultsContent">
            <div class="empty-state">
                <div class="icon">ğŸ”</div>
                <h3>å¼€å§‹æœç´¢æ•™è‚²èµ„æº</h3>
                <p>é€‰æ‹©å›½å®¶ã€å¹´çº§å’Œå­¦ç§‘ï¼Œç‚¹å‡»"å¼€å§‹æœç´¢"æŒ‰é’®</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
    // å…¨å±€çŠ¶æ€
    let currentResults = [];
    let selectedGrades = [];
    let selectedSubjects = [];

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
        loadCountries();
        setupEventListeners();
    });

    // åŠ è½½å›½å®¶åˆ—è¡¨
    async function loadCountries() {
        try {
            const response = await fetch('/api/countries');
            const data = await response.json();

            if (data.success && data.countries) {
                const select = document.getElementById('country');
                select.innerHTML = '<option value="">æ‰€æœ‰å›½å®¶</option>';
                
                data.countries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country.code;
                    option.textContent = country.name;
                    select.appendChild(option);
                });

                toast.success('é…ç½®åŠ è½½', 'å›½å®¶é…ç½®å·²åŠ è½½');
            }
        } catch (error) {
            console.error('åŠ è½½å›½å®¶å¤±è´¥:', error);
            // ä½¿ç”¨é»˜è®¤å›½å®¶åˆ—è¡¨
            const select = document.getElementById('country');
            select.innerHTML = '<option value="">æ‰€æœ‰å›½å®¶</option>';
            const countries = [
                {code: 'ID', name: 'å°åº¦å°¼è¥¿äºš'},
                {code: 'PH', name: 'è²å¾‹å®¾'},
                {code: 'RU', name: 'ä¿„ç½—æ–¯'},
                {code: 'IN', name: 'å°åº¦'},
                {code: 'IQ', name: 'ä¼Šæ‹‰å…‹'},
                {code: 'NG', name: 'å°¼æ—¥åˆ©äºš'},
                {code: 'SA', name: 'æ²™ç‰¹'},
                {code: 'EG', name: 'åŸƒåŠ'},
                {code: 'CN', name: 'ä¸­å›½'},
                {code: 'ZA', name: 'å—é'}
            ];
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.code;
                option.textContent = country.name;
                select.appendChild(option);
            });
        }
    }

    // è®¾ç½®äº‹ä»¶ç›‘å¬
    function setupEventListeners() {
        // å›½å®¶é€‰æ‹©å˜åŒ–æ—¶æ›´æ–°å¹´çº§å’Œå­¦ç§‘
        document.getElementById('country').addEventListener('change', async (e) => {
            const countryCode = e.target.value;
            if (countryCode) {
                await loadEducationLevels(countryCode);
                await loadSubjects(countryCode);
            } else {
                clearMultiSelect('grade');
                clearMultiSelect('subject');
            }
        });

        // æœç´¢æŒ‰é’®
        document.getElementById('searchBtn').addEventListener('click', performSearch);

        // æ·»åŠ å›½å®¶æŒ‰é’®
        document.getElementById('addCountryBtn').addEventListener('click', showAddCountryModal);

        // åˆ·æ–°é…ç½®æŒ‰é’®
        document.getElementById('refreshCountryBtn').addEventListener('click', () => {
            loadCountries();
            toast.info('åˆ·æ–°é…ç½®', 'æ­£åœ¨é‡æ–°åŠ è½½å›½å®¶é…ç½®...');
        });

        // ç‚¹å‡»å¤–éƒ¨å…³é—­å¤šé€‰ä¸‹æ‹‰æ¡†
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.multi-select-dropdown')) {
                closeAllMultiSelectDropdowns();
            }
        });
    }

    // åŠ è½½æ•™è‚²å±‚çº§ï¼ˆå¹´çº§ï¼‰
    async function loadEducationLevels(countryCode) {
        try {
            const response = await fetch(\`/api/config/education_levels?country=\${countryCode}\`);
            const data = await response.json();

            if (data.success && data.levels) {
                populateMultiSelectOptions('grade', data.levels);
            }
        } catch (error) {
            console.error('åŠ è½½å¹´çº§å¤±è´¥:', error);
            // ä½¿ç”¨é»˜è®¤å¹´çº§åˆ—è¡¨
            const defaultGrades = ['Grade 1', 'Grade 2', 'Grade 3', 'Grade 4', 'Grade 5', 'Grade 6',
                                   'Grade 7', 'Grade 8', 'Grade 9', 'Grade 10', 'Grade 11', 'Grade 12'];
            populateMultiSelectOptions('grade', defaultGrades);
        }
    }

    // åŠ è½½å­¦ç§‘
    async function loadSubjects(countryCode) {
        try {
            const response = await fetch(\`/api/config/subjects?country=\${countryCode}\`);
            const data = await response.json();

            if (data.success && data.subjects) {
                populateMultiSelectOptions('subject', data.subjects);
            }
        } catch (error) {
            console.error('åŠ è½½å­¦ç§‘å¤±è´¥:', error);
            // ä½¿ç”¨é»˜è®¤å­¦ç§‘åˆ—è¡¨
            const defaultSubjects = ['Mathematics', 'Science', 'Physics', 'Chemistry', 'Biology',
                                     'English', 'History', 'Geography'];
            populateMultiSelectOptions('subject', defaultSubjects);
        }
    }

    // å¡«å……å¤šé€‰ä¸‹æ‹‰æ¡†é€‰é¡¹
    function populateMultiSelectOptions(type, options) {
        const optionsContainer = document.getElementById(\`\${type}Options\`);
        const trigger = document.getElementById(\`\${type}SelectTrigger\`);
        const triggerText = document.getElementById(\`\${type}SelectText\`);
        const select = document.getElementById(type);

        optionsContainer.innerHTML = '';
        select.innerHTML = '';

        options.forEach(option => {
            const label = typeof option === 'string' ? option : option.name;
            const value = typeof option === 'string' ? option : option.id || option.code;

            // åˆ›å»ºé€‰é¡¹
            const optionDiv = document.createElement('div');
            optionDiv.className = 'multi-select-option';
            optionDiv.innerHTML = \`
                <input type="checkbox" id="\${type}_\${value}" value="\${value}">
                <label for="\${type}_\${value}" style="margin: 0; cursor: pointer; flex: 1;">\${label}</label>
            \`;

            optionDiv.querySelector('input').addEventListener('change', (e) => {
                handleMultiSelectChange(type);
            });

            optionsContainer.appendChild(optionDiv);

            // åˆ›å»ºselect option
            const selectOption = document.createElement('option');
            selectOption.value = value;
            selectOption.textContent = label;
            select.appendChild(selectOption);
        });

        triggerText.textContent = 'è¯·é€‰æ‹©...';
        triggerText.style.color = 'var(--text-secondary)';
    }

    // å¤„ç†å¤šé€‰å˜åŒ–
    function handleMultiSelectChange(type) {
        const checkboxes = document.querySelectorAll(\`#\${type}Options input[type="checkbox"]\`);
        const selected = Array.from(checkboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);

        const triggerText = document.getElementById(\`\${type}SelectText\`);
        const select = document.getElementById(type);

        // æ›´æ–°éšè—çš„select
        select.innerHTML = '';
        selected.forEach(value => {
            const option = document.createElement('option');
            option.value = value;
            option.selected = true;
            select.appendChild(option);
        });

        // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
        if (selected.length === 0) {
            triggerText.textContent = 'è¯·é€‰æ‹©...';
            triggerText.style.color = 'var(--text-secondary)';
        } else if (selected.length === 1) {
            triggerText.textContent = selected[0];
            triggerText.style.color = 'var(--text-primary)';
        } else {
            triggerText.textContent = \`å·²é€‰æ‹© \${selected.length} é¡¹\`;
            triggerText.style.color = 'var(--text-primary)';
        }

        // æ›´æ–°å…¨å±€çŠ¶æ€
        if (type === 'grade') {
            selectedGrades = selected;
        } else if (type === 'subject') {
            selectedSubjects = selected;
        }
    }

    // åˆ‡æ¢å¤šé€‰ä¸‹æ‹‰æ¡†æ˜¾ç¤º
    function toggleMultiSelectDropdown(type) {
        const dropdown = document.getElementById(\`\${type}Dropdown\`);
        const isShown = dropdown.classList.contains('show');
        
        // å…³é—­æ‰€æœ‰å…¶ä»–ä¸‹æ‹‰æ¡†
        closeAllMultiSelectDropdowns();

        if (!isShown) {
            dropdown.classList.add('show');
        }
    }

    // å…³é—­æ‰€æœ‰å¤šé€‰ä¸‹æ‹‰æ¡†
    function closeAllMultiSelectDropdowns() {
        document.querySelectorAll('.multi-select-options').forEach(dropdown => {
            dropdown.classList.remove('show');
        });
    }

    // æ¸…ç©ºå¤šé€‰
    function clearMultiSelect(type) {
        const optionsContainer = document.getElementById(\`\${type}Options\`);
        const triggerText = document.getElementById(\`\${type}SelectText\`);
        
        optionsContainer.innerHTML = '';
        triggerText.textContent = 'è¯·å…ˆé€‰æ‹©å›½å®¶';
        triggerText.style.color = 'var(--text-secondary)';

        if (type === 'grade') {
            selectedGrades = [];
        } else if (type === 'subject') {
            selectedSubjects = [];
        }
    }

    // å…¨é€‰å¹´çº§
    function selectAllGrades() {
        const checkboxes = document.querySelectorAll('#gradeOptions input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = true);
        handleMultiSelectChange('grade');
    }

    // æ¸…ç©ºå¹´çº§
    function deselectAllGrades() {
        const checkboxes = document.querySelectorAll('#gradeOptions input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
        handleMultiSelectChange('grade');
    }

    // å…¨é€‰å­¦ç§‘
    function selectAllSubjects() {
        const checkboxes = document.querySelectorAll('#subjectOptions input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = true);
        handleMultiSelectChange('subject');
    }

    // æ¸…ç©ºå­¦ç§‘
    function deselectAllSubjects() {
        const checkboxes = document.querySelectorAll('#subjectOptions input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
        handleMultiSelectChange('subject');
    }

    // æ‰§è¡Œæœç´¢
    async function performSearch() {
        const country = document.getElementById('country').value;
        const resourceType = document.getElementById('resourceType').value;
        const semester = document.getElementById('semester').value.trim();

        // éªŒè¯è¾“å…¥
        if (!country) {
            toast.warning('éªŒè¯å¤±è´¥', 'è¯·é€‰æ‹©å›½å®¶');
            return;
        }

        if (selectedGrades.length === 0) {
            toast.warning('éªŒè¯å¤±è´¥', 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå¹´çº§');
            return;
        }

        if (selectedSubjects.length === 0) {
            toast.warning('éªŒè¯å¤±è´¥', 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå­¦ç§‘');
            return;
        }

        // ç¦ç”¨æœç´¢æŒ‰é’®
        const searchBtn = document.getElementById('searchBtn');
        searchBtn.disabled = true;
        searchBtn.innerHTML = '<div class="spinner" style="display: inline-block; width: 16px; height: 16px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div> æœç´¢ä¸­...';

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const resultsContent = document.getElementById('resultsContent');
        resultsContent.innerHTML = '<div class="empty-state"><div class="spinner"></div><p>æ­£åœ¨æœç´¢...</p></div>';

        const startTime = Date.now();

        try {
            const params = new URLSearchParams({
                country: country,
                grades: selectedGrades.join(','),
                subjects: selectedSubjects.join(','),
                resource_type: resourceType
            });

            if (semester) {
                params.append('semester', semester);
            }

            const response = await fetch(\`/api/search?\${params}\`);
            const data = await response.json();

            const endTime = Date.now();
            const duration = ((endTime - startTime) / 1000).toFixed(2);

            if (data.success) {
                currentResults = data.results || [];
                displayResults(currentResults);
                updateStats(currentResults, data.success_rate || 100, duration);
                toast.success('æœç´¢å®Œæˆ', \`æ‰¾åˆ° \${currentResults.length} ä¸ªç»“æœ\`);
            } else {
                resultsContent.innerHTML = \`
                    <div class="empty-state">
                        <div class="icon">âŒ</div>
                        <h3>æœç´¢å¤±è´¥</h3>
                        <p>\${data.message || 'æœªçŸ¥é”™è¯¯'}</p>
                    </div>
                \`;
                toast.error('æœç´¢å¤±è´¥', data.message || 'æœªçŸ¥é”™è¯¯');
            }
        } catch (error) {
            console.error('æœç´¢å¤±è´¥:', error);
            resultsContent.innerHTML = \`
                <div class="empty-state">
                    <div class="icon">âš ï¸</div>
                    <h3>ç½‘ç»œé”™è¯¯</h3>
                    <p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•</p>
                </div>
            \`;
            toast.error('ç½‘ç»œé”™è¯¯', 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        } finally {
            searchBtn.disabled = false;
            searchBtn.innerHTML = 'ğŸš€ å¼€å§‹æœç´¢';
        }
    }

    // æ˜¾ç¤ºæœç´¢ç»“æœ
    function displayResults(results) {
        const resultsContent = document.getElementById('resultsContent');

        if (results.length === 0) {
            resultsContent.innerHTML = \`
                <div class="empty-state">
                    <div class="icon">ğŸ”</div>
                    <h3>æœªæ‰¾åˆ°ç»“æœ</h3>
                    <p>è¯·å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶</p>
                </div>
            \`;
            return;
        }

        resultsContent.innerHTML = results.map(result => \`
            <div class="result-item" onclick="window.open('\${result.video_url || '#'}', '_blank')">
                <h3>\${result.title || 'æ— æ ‡é¢˜'}</h3>
                \${result.video_url ? \`<a href="\${result.video_url}" target="_blank" onclick="event.stopPropagation()">\${result.video_url}</a>\` : ''\}
                \${result.description ? \`<div class="snippet">\${result.description}</div>\` : ''\`
                <div class="meta">
                    <span class="badge">\${result.country || '-'}</span>
                    <span class="badge">ğŸ“– \${result.grade || '-'}</span>
                    <span class="badge">ğŸ“š \${result.subject || '-'}</span>
                    \${result.quality_score ? \`<span class="quality-score">â­ \${result.quality_score}/10</span>\` : ''\`
                </div>
            </div>
        \`).join('');
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStats(results, successRate, duration) {
        document.getElementById('resultCount').textContent = results.length;
        document.getElementById('successRate').textContent = successRate + '%';
        document.getElementById('avgTime').textContent = duration + 's';
        document.getElementById('resultsStats').style.display = 'flex';
    }

    // æ’åºç»“æœ
    function sortResults(sortBy) {
        if (currentResults.length === 0) return;

        switch (sortBy) {
            case 'quality':
                currentResults.sort((a, b) => (b.quality_score || 0) - (a.quality_score || 0));
                break;
            case 'title':
                currentResults.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
                break;
            default:
                // é»˜è®¤æ’åºï¼Œä¸æ”¹å˜
                return;
        }

        displayResults(currentResults);
        toast.info('æ’åºå®Œæˆ', 'ç»“æœå·²é‡æ–°æ’åº');
    }

    // å¯¼å‡ºç»“æœ
    function exportResults(format) {
        if (currentResults.length === 0) {
            toast.warning('å¯¼å‡ºå¤±è´¥', 'æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœ');
            return;
        }

        let content, filename, type;

        if (format === 'csv') {
            content = convertToCSV(currentResults);
            filename = 'search_results.csv';
            type = 'text/csv';
        } else if (format === 'json') {
            content = JSON.stringify(currentResults, null, 2);
            filename = 'search_results.json';
            type = 'application/json';
        }

        const blob = new Blob([content], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);

        toast.success('å¯¼å‡ºæˆåŠŸ', \`å·²å¯¼å‡º \${currentResults.length} æ¡ç»“æœåˆ° \${filename}\`);
    }

    // å¯¼å‡ºä¸ºExcelï¼ˆä½¿ç”¨CSVæ ¼å¼ï¼‰
    function exportResultsToExcel() {
        if (currentResults.length === 0) {
            toast.warning('å¯¼å‡ºå¤±è´¥', 'æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœ');
            return;
        }

        // ä½¿ç”¨CSVæ ¼å¼ï¼ŒExcelå¯ä»¥æ‰“å¼€
        const content = convertToCSV(currentResults);
        const blob = new Blob(['\uFEFF' + content], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'search_results.csv';
        a.click();
        URL.revokeObjectURL(url);

        toast.success('å¯¼å‡ºæˆåŠŸ', \`å·²å¯¼å‡º \${currentResults.length} æ¡ç»“æœåˆ°Excelæ–‡ä»¶\`);
    }

    // è½¬æ¢ä¸ºCSV
    function convertToCSV(results) {
        const headers = ['æ ‡é¢˜', 'URL', 'å›½å®¶', 'å¹´çº§', 'å­¦ç§‘', 'è´¨é‡åˆ†æ•°', 'æè¿°'];
        const rows = results.map(r => [
            r.title || '',
            r.video_url || '',
            r.country || '',
            r.grade || '',
            r.subject || '',
            r.quality_score || '',
            r.description || ''
        ]);

        const csvContent = [
            headers.join(','),
            ...rows.map(row => row.map(cell => \`"\${cell.replace(/"/g, '""')}"\`).join(','))
        ].join('\n');

        return csvContent;
    }

    // æ˜¾ç¤ºæ·»åŠ å›½å®¶æ¨¡æ€æ¡†
    function showAddCountryModal() {
        const countryName = prompt('è¯·è¾“å…¥æ–°å›½å®¶çš„åç§°:');
        if (!countryName) return;

        const countryCode = prompt('è¯·è¾“å…¥å›½å®¶ä»£ç ï¼ˆå¦‚: ID, PH, RUï¼‰:');
        if (!countryCode) return;

        toast.info('æ·»åŠ å›½å®¶', \`æ­£åœ¨æ·»åŠ å›½å®¶: \${countryName} (\${countryCode})\`);

        // è¿™é‡Œåº”è¯¥è°ƒç”¨APIæ·»åŠ å›½å®¶
        // æš‚æ—¶åªæ˜¾ç¤ºæç¤º
        setTimeout(() => {
            toast.warning('åŠŸèƒ½å¼€å‘ä¸­', 'æ·»åŠ å›½å®¶åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…');
        }, 500);
    }
</script>
{% endblock %}
