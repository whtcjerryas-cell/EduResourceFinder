# ============================================
# 搜索引擎配置
# ============================================
# 用途：配置所有搜索引擎相关参数
# 修改后：重启服务生效
# ============================================

search:
  # ----------------------------------------
  # 搜索引擎配置
  # ----------------------------------------
  engines:
    # Google Custom Search
    google:
      endpoint: "https://customsearch.googleapis.com/customsearch/v1"
      api_key_env: "GOOGLE_API_KEY"           # 环境变量名
      cx_env: "GOOGLE_CX"                     # 自定义搜索引擎ID
      max_results_per_page: 10
      timeout: 30
      default_region: "id"                    # 印尼
      enabled: true

    # Baidu Search
    baidu:
      base_url: "https://qianfan.baidubce.com/v2/ai_search"
      token_url: "https://aip.baidubce.com/oauth/2.0/token"
      api_key_env: "BAIDU_API_KEY"
      secret_key_env: "BAIDU_SECRET_KEY"
      default_model: "ernie-3.5-8k"
      max_results: 20
      timeout: 60
      enabled: true

      # 智能搜索模式
      smart_search:
        model: "ernie-3.5-8k"
        max_results: 20

      # 高性能模式
      high_performance:
        model: "ernie-4.5-turbo-32k"
        max_results: 20
        timeout: 60

    # Tavily Search
    tavily:
      endpoint: "https://api.tavily.com/search"
      api_key_env: "TAVILY_API_KEY"
      max_results: 20
      max_domains: 5                         # 最多包含的域名数
      timeout: 30
      enabled: true

    # DuckDuckGo Search
    duckduckgo:
      region: "id"                            # 印尼
      safesearch: "moderate"                 # 安全搜索级别
      max_results: 30
      timeout: 30
      enabled: true

  # ----------------------------------------
  # 搜索策略
  # ----------------------------------------
  strategy:
    # 每个章节最大搜索尝试次数
    max_attempts_per_chapter: 5

    # 重试延迟（秒）
    retry_delay_seconds: 1

    # 章节间延迟（秒）
    inter_chapter_delay_seconds: 1

    # 是否启用智能搜索（AI生成查询）
    enable_smart_search: true

    # 是否启用多引擎并行搜索
    enable_parallel_search: true

    # 并行搜索最大引擎数
    max_parallel_engines: 3

  # ----------------------------------------
  # 本地化关键词
  # ----------------------------------------
  # 不同语言的"教学视频"关键词
  localization:
    id: "Video pembelajaran"      # 印尼语
    en: "Video lesson"             # 英语
    zh: "教学视频"                 # 中文（简体）
    zh-CN: "教学视频"              # 中文（简体）
    ms: "Video pembelajaran"      # 马来语
    ar: "فيديو تعليمي"            # 阿拉伯语
    ru: "Видео урок онлайн"       # 俄语（增强：添加"在线"）
    th: "วิดีโอการสอน"          # 泰语
    vi: "Video bài giảng"         # 越南语

  # 俄语教育关键词优化（提升俄罗斯搜索效果）
  russian_keywords:
    - "видео урок"               # 视频教程
    - "онлайн урок"              # 在线课程
    - "лекция"                   # 讲座
    - "обучение"                 # 教学/培训
    - "учебник"                  # 教科书
    - "презентация"              # 演示文稿
    - "видео лекция"             # 视频讲座
    - "полный курс"              # 完整课程

  # ----------------------------------------
  # EdTech平台域名白名单
  # ----------------------------------------
  # 检测结果是否来自知名教育平台
  edtech_domains:
    - "youtube.com"
    - "ruangguru.com"
    - "zenius.net"
    - "quipper.com"
    - "brainly.co.id"
    - "khanacademy.org"
    - "coursera.org"
    - "udemy.com"
    - "edx.org"
    # 俄罗斯教育平台
    - "uchi.ru"
    - "znaika.ru"
    - "interneturok.ru"
    - "infourok.ru"
    - "videouroki.net"
    - "reshuege.ru"
    - "ruchihil.ru"

  # ----------------------------------------
  # 搜索结果过滤
  # ----------------------------------------
  filters:
    # 最小相关度分数（低于此分数的结果会被过滤）
    min_relevance_score: 3.0

    # 最小视觉质量分数
    min_visual_quality_score: 3.0

    # 最小综合分数
    min_overall_score: 4.0

    # 是否过滤掉非视频资源
    require_video: false

    # 是否优先选择播放列表
    prefer_playlist: true
    playlist_boost: 1.5        # 播放列表的得分加成

  # ----------------------------------------
  # 搜索查询生成配置
  # ----------------------------------------
  query_generation:
    # 每次生成的查询变体数量
    num_variants: 5

    # 查询模板
    templates:
      # 基础模板
      basic: "{grade} {subject} {topic} video"

      # 完整课程模板
      full_course: "{grade} {subject} {topic} complete course"

      # 播放列表模板
      playlist: "{grade} {subject} {topic} playlist"

      # 章节特定模板
      chapter: "{grade} {subject} {chapter} {topic}"

      # 本地语言模板（印尼语）
      localized_id: "Video pembelajaran {subject} {topic} kelas {grade}"

  # ----------------------------------------
  # 学期检测关键词
  # ----------------------------------------
  # 用于检测查询是否关于特定学期
  semester_detection:
    semester2_keywords:
      - "geometri"              # 几何
      - "statistik"             # 统计
      - "peluang"               # 概率
      - "bangun ruang"          # 空间
      - "transformasi"          # 变换

# ============================================
# 渐进式搜索优化配置（方案一）
# ============================================
# [新增] 2026-01-20: 渐进式搜索优化配置
# 目标: 简化搜索流程，提高搜索质量，减少API调用
# ============================================

incremental_search:
  # ----------------------------------------
  # 优化策略选择
  # ----------------------------------------
  # 可选值: incremental(渐进式) / fusion(智能融合) / hybrid(混合评分)
  strategy: incremental

  # ----------------------------------------
  # 查询生成配置
  # ----------------------------------------
  query_generation:
    # 使用LLM生成最优查询
    use_llm: true

    # 是否包含播放列表关键词
    include_playlist: true

    # 是否包含本地化关键词
    include_localized: true

    # 备选查询数量（用于重试）
    max_alternative_queries: 5

  # ----------------------------------------
  # 搜索引擎配置
  # ----------------------------------------
  engines:
    # 主引擎（用于初始搜索）
    primary: tavily    # 或 metaso

    # 辅助引擎（用于补充搜索）
    secondary: google

    # 降级引擎（用于引擎切换）
    fallback: metaso

  # ----------------------------------------
  # 质量控制配置
  # ----------------------------------------
  quality:
    # 高质量阈值（>=此分数直接返回）
    high_threshold: 7.0

    # 低质量阈值（<此分数触发重试）
    low_threshold: 5.0

    # 质量评估使用的结果数量
    evaluation_count: 10

    # 最少结果数量（低于此数量视为失败）
    min_results_count: 5

    # 是否启用LLM评分
    enable_llm_scoring: false

  # ----------------------------------------
  # 降级策略配置
  # ----------------------------------------
  fallback:
    # 是否启用降级策略
    enabled: true

    # 最大重试次数
    max_attempts: 3

    # 启用的降级策略
    strategies:
      - query_rewrite        # 查询重写
      - engine_switching     # 引擎切换
      - relax_filters        # 放宽筛选条件
      - historical_cache     # 历史缓存

    # 查询重写配置
    query_rewrite:
      enabled: true
      max_attempts: 5

    # 引擎切换配置
    engine_switching:
      enabled: true
      try_engines:
        - tavily
        - google
        - metaso
        - baidu

    # 放宽筛选配置
    relax_filters:
      enabled: true
      relaxed_min_score: 3.0
      increased_max_results: 50

    # 历史缓存配置
    historical_cache:
      enabled: true
      max_age_hours: 48    # 最长使用48小时前的缓存
      include_expired: true

  # ----------------------------------------
  # 性能配置
  # ----------------------------------------
  performance:
    # 初始搜索超时（秒）
    initial_search_timeout: 20

    # 补充搜索超时（秒）
    supplementary_search_timeout: 15

    # 重试超时（秒）
    retry_timeout: 20

    # 总体超时（秒）
    total_timeout: 60

  # ----------------------------------------
  # 缓存配置（如果启用）
  # ----------------------------------------
  cache:
    # 是否启用多级缓存
    enabled: false

    # L1: 内存缓存
    l1_enabled: true
    l1_ttl: 300           # 5分钟
    l1_max_size: 100

    # L2: Redis缓存
    l2_enabled: true
    l2_ttl: 3600          # 1小时

    # L3: 磁盘缓存
    l3_enabled: true
    l3_ttl: 86400         # 24小时

  # ----------------------------------------
  # 日志配置
  # ----------------------------------------
  logging:
    # 是否记录详细日志
    verbose: true

    # 是否记录搜索步骤
    log_steps: true

    # 是否记录质量评估
    log_quality_assessment: true

    # 是否记录降级策略
    log_fallback: true
